<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>제스트 출석 관리 시스템</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- ① 글꼴 불러오기 -->
<link href="https://cdn.jsdelivr.net/gh/webfontworld/gmarket/GmarketSans.css" rel="stylesheet" />
<style>
  body {
      font-family: 'GmarketSans', sans-serif;
      padding: 1.2rem;
      margin: 0;
      background-color: #f2f2f2;
    }

    .tab-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .tab-buttons button {
      white-space: nowrap;
      flex: 1;
      padding: 0.6rem 1rem;
      text-overflow: ellipsis;
      font-size: clamp(0.9rem, 1.8vw, 1.2rem);
      border: none;
      border-radius: 8px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      font-weight: bold;
      line-height: 1.2;  
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3); /* 그림자 설정 */
    }

    .tab-buttons button:hover {
      background-color: #45a049;
    }

    .tab {
      display: none;
      padding: 1rem;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }

    .tab.active {
      display: block;
    }

    h2 {
      margin-top: 0;
    }

    /* 각 탭 버튼에 고유한 색상 부여 */
.tab-buttons button:nth-child(1) {
  background-color: #A3B18A; /* 출석부 */
}
.tab-buttons button:nth-child(2) {
  background-color: #6C91BF; /* 경기 편성 */
}
.tab-buttons button:nth-child(3) {
  background-color: #D8A7A7; /* 회원 관리 */
}
.tab-buttons button:nth-child(4) {
  background-color: #E5C07B; /* 경기 점수 */
}
.tab-buttons button:nth-child(5) {
  background-color: #A67B5B; /* 출석 관리 */
}

  </style>
  <style>
    #selectedTable tr {
      height: 48px; /* 또는 52px 등 원하는 값 */
    }
  </style>
  <style>
    /* 출석부 탭 내 select 요소 폰트와 패딩 확대 */
    #attendanceTab select {
      font-size: 1.3rem;
      padding: 0.6rem 1rem;
    }
  
    /* 출석부 탭 내 버튼들 폰트 및 패딩 확대 */
    #attendanceTab button {
      font-size: 1.3rem;
      padding: 0.8rem 1.2rem;
    }
  
    /* 출석 요약 영역도 가독성 개선 */
    #attendanceSummary {
      font-size: 1.2rem;
      line-height: 1.8rem;
    }
  </style>
  <style>
    /* 경기 편성 탭 내 전체 글자 크기 확대 */
    #matchTab {
      font-size: 1.3rem;
      line-height: 1.9rem;
    }
  
    /* 입력 필드와 셀렉트 박스 크기 조정 */
    #matchTab input,
    #matchTab select {
      font-size: 1.3rem;
      padding: 0.6rem 1rem;
    }
  
    /* 버튼 크기 확대 */
    #matchTab button {
      font-size: 1.3rem;
      padding: 0.8rem 1.2rem;
    }
  
    /* 결과 출력 영역 텍스트 크기 조정 */
    #matchResult {
      font-size: 1.2rem;
      line-height: 1.8rem;
    }
    #suggestA, #suggestB {
  font-size: 1.56rem;  /* 120% 확대 */
  font-weight: bold;
}
.my-custom-style {
      background-color: #fdfbe8;
      border: 2px solid #bbb;
    }
    .name-select {
  transition: background-color 0.3s ease;
}

.name-select.flash {
  background-color: #e0ffe0;
}

#lateStatusTable {
  margin-top: 2rem;
  background: white;
  border-collapse: collapse;
  border: 1px solid #ddd;
}
#lateStatusTable th, #lateStatusTable td {
  padding: 8px;
  text-align: center;
  border: 1px solid #ddd;
}

  </style>
  <style>
    .envelope-box {
      width: 35px;
      height: 35px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      background-color: #fff;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      margin: 6px;
    }
    .envelope.selected {
  background-color: #ccc;
  color: #999;
  border: 2px solid #aaa;
  cursor: not-allowed;
}
    .envelope-box:hover {
      transform: scale(1.06);
      background-color: #f5f5f5;
    }

    #envelopeArea {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 4px;
  margin-top: 0.3rem;
}
#liveResultTable {
  display: flex;
  flex-wrap: wrap;               /* ✅ 자동 줄바꿈 허용 */
  justify-content: center;       /* 가운데 정렬 */
  gap: 1rem;                   /* 간격 유지 */
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
  padding: 1rem;
}
  </style>
  
</head>
<body>

  <!-- 탭 버튼 -->
  <div class="tab-buttons">
    <button onclick="showTab('attendanceTab')">출석부</button>
    <button onclick="showTab('matchTab')">경기<br>편성<br>1경기</button>
    <button onclick="showTab('matchSetup2')">경기<br>편성<br>2-4경기</button>
    <button onclick="showTab('memberTab')">회원<br>관리</button>
    <button onclick="showTab('scoreTab')">경기<br>점수</button>

  </div>

  <!-- 탭 콘텐츠 영역 -->
  <div id="attendanceTab" class="tab active">
    
    <!-- 이후 단계에서 내용 추가 -->
     <!-- 날짜 선택 영역 -->
<!-- 제목 오른쪽에 날짜 선택 UI를 배치 -->
<div style="display: flex; justify-content: space-between; align-items: center;">
    <h2 style="display: none;">출석부</h2>
  
  <div style="display: flex; align-items: center; gap: 6px;">
    <select id="yearSelect" style="width: 100px;"></select>
    <select id="monthSelect" style="width: 85px;"></select>
    <select id="daySelect" style="width: 100px;"></select>
    <span id="weekdayDisplay" style="font-weight: bold;"></span>
  </div>
</div>

  <!-- 순위별 성명 선택 및 지각/조퇴 체크 -->
<div style="margin-top: 1rem;">
  <!-- 출석 명단 만들기 버튼 - 살짝 파란 계열로 변경 -->
  <div style="display: flex; gap: 10px; margin-top: 1rem;">
    <button 
      onclick="loadRankedAttendance()" 
      style="background-color: #cce5ff; color: #003366; padding: 0.4rem 0.8rem; font-size: 1rem;">
      출석부 생성
    </button>
  
    <button 
      onclick="confirmAndClearAttendance()" 
      style="background-color: #ffe5e5; color: #663333; padding: 0.4rem 0.8rem; font-size: 1rem;">
      출석부 삭제
    </button>
  </div>
  <!-- 🧪 [개발자용] 랜덤 출석 추가 버튼 - 나중에 삭제 -->
<div style="margin-top: 1rem;">
  <button onclick="debugAddRandomAttendance()" style="padding: 0.6rem 1.2rem; background-color: #eee;">
    🧪 랜덤 출석 27명 추가
  </button>
</div>
  
  <div id="matchSetup2" class="tab">
    <h2>경기 편성 2-4경기</h2>
    <p>여기에 2~4경기 관련 포지션 뽑기 기록, 자동 팀 재배치 등의 기능이 들어갈 수 있어요.</p>
  </div>

  <div id="attendanceList" style="margin-top: 1rem;"></div>
  <div style="text-align: center; margin-top: 1rem;">
    <button onclick="saveAttendance()" style="padding: 0.7rem 1.3rem;">출석 저장</button>
  </div>
  
  <div id="attendanceSummary" style="margin-top: 1rem; background: #f3f3f3; padding: 1rem; border-radius: 8px;"></div>
</div>


  </div>
  <!-- 경기 편성 1경기 탭 -->
<div id="matchTab" class="tab">
    <h2>경기 편성 1경기</h2>
  
    <!-- 출석 날짜 선택 + 출석 인원 적용 -->
    <div style="margin-bottom: 1rem; display: flex; align-items: center;">
        <button onclick="loadMatchPlayers()" style="padding: 0.8rem 1.2rem;">출석부 적용하기</button>
        <span style="margin-left: 2rem; font-weight: bold; font-size: 1.2rem;">
            참가자: <span id="matchTotal">0</span>명 /
        </span>
      </div>
  
    <!-- C팀 인원 설정 -->
    <div style="margin-bottom: 2rem;">
      C팀 인원 수: <input type="number" id="matchCInput" value="0" min="0" oninput="updateMatchCounts()">
    </div>
  
    <!-- A팀 구역 -->
<div style="background-color: #fff9c4; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
    <div id="matchAInfo" style="font-weight: bold; font-size: 1.4rem;">A팀 출석 인원:</div>
    <div style="margin-top: 0.7rem;">
      <label style="font-weight: bold;">A팀 선발 인원:</label>
      <div style="display: flex; align-items: center; gap: 10px;">
        <button onclick="adjustStarter('A', 1)">▲</button>
        <input type="number" id="matchAStarter" value="11" min="1" style="width: 60px; text-align: center;" readonly>
        <button onclick="adjustStarter('A', -1)">▼</button>
      </div>
    </div>
    <div style="margin-top: 0.7rem;">
      <label><strong>포메이션 추천:</strong> <span id="suggestA" style="font-size: 1rem;"></span></label><br>
      <label><strong>A팀 포메이션:</strong></label>
      <select id="formationASelect" onchange="toggleCustomFormation('A')">
        <option value="">-- 추천 선택 --</option>
        <!-- 자동으로 추천값 추가됨 -->
      </select>
      <div id="formationACustom" style="display: none; margin-top: 0.5rem;">
        DF: <input type="number" id="dfA" value="0" min="0" style="width: 30px;" />
        MF: <input type="number" id="mfA" value="0" min="0" style="width: 30px;" />
        FW: <input type="number" id="fwA" value="0" min="0" style="width: 30px;" />
      </div>
      <div id="remainingA" style="margin-top: 0.5rem; font-weight: bold;"></div>

    </div>
  </div>
  
  
    <!-- B팀 구역 -->
<div style="background-color: #e0f7da; padding: 1rem; border-radius: 10px;">
    <div id="matchBInfo" style="font-weight: bold; font-size: 1.4rem;">B팀 출석 인원:</div>
    <div style="margin-top: 0.7rem;">
      <label style="font-weight: bold;">B팀 선발 인원:</label>
      <div style="display: flex; align-items: center; gap: 10px;">
        <button onclick="adjustStarter('B', 1)">▲</button>
        <input type="number" id="matchBStarter" value="11" min="1" style="width: 60px; text-align: center;" readonly>
        <button onclick="adjustStarter('B', -1)">▼</button>
      </div>
    </div>
    <div style="margin-top: 0.7rem;">
      <label><strong>포메이션 추천:</strong> <span id="suggestB" style="font-size: 1rem;"></span></label><br>
      <label style="display: inline-block; margin-top: 1rem;"><strong>B팀 포메이션:</strong></label>
      <select id="formationBSelect" onchange="toggleCustomFormation('B')" style="margin-left: 10px;">
        <option value="">-- 추천 선택 --</option>
      </select>
      <div id="formationBCustom" style="display: none; margin-top: 0.5rem;">
        DF: <input type="number" id="dfB" value="0" min="0" style="width: 30px;" />
        MF: <input type="number" id="mfB" value="0" min="0" style="width: 30px;" />
        FW: <input type="number" id="fwB" value="0" min="0" style="width: 30px;" />
      </div>
      <div id="remainingB" style="margin-top: 0.5rem; font-weight: bold;"></div>
    </div>
  </div>
    
    <!-- 포지션 뽑기 -->
<div style="margin: 2rem 0; text-align: center;">
  <div style="margin: 2rem 0; text-align: center;">
  <button onclick="drawMatchPositions()" style="
    font-size: 1.5rem;
    padding: 1rem 2rem;
    border-radius: 50px;
    background-color: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.2);">
    ⚽ 포지션 뽑기
  </button>
</div>
  
  </div>
  

    <!-- 결과 출력 -->
    <div id="matchResult" style="margin-top: 1.5rem;"></div>
  </div>
  
  
  <div id="memberTab" class="tab">
    <h2>회원 관리</h2>
  
 <!-- 회원 명단 업로드 -->
<div style="margin-bottom: 2.5rem; font-size: 1.5rem; line-height: 2.2rem;">
    <label style="font-weight: bold;">회원 명단 업로드 (엑셀):</label><br>
  
    <!-- 파일 선택 영역 -->
    <div style="margin: 1rem 0;">
      <input type="file" id="excelFileInput" accept=".xlsx, .xls"
        style="font-size: 1.4rem; padding: 0.6rem 1rem; border-radius: 6px;"
        onchange="updateSelectedFileName(this)">
      <div id="fileNameDisplay" style="margin-top: 0.5rem; font-size: 1.5rem; color: #555;"></div>
    </div>
  
    <!-- 버튼 그룹 -->
    <div style="display: flex; flex-wrap: wrap; gap: 1.2rem; margin-top: 1.5rem;">
      <button onclick="downloadMemberList()" style="flex: 1 1 45%; padding: 1.2rem; font-size: 1.3rem;">회원 명단 보기</button>
      <button onclick="toggleEditTeam()" style="flex: 1 1 45%; padding: 1.2rem; font-size: 1.3rem;">회원 소속 변경</button>
      <button onclick="toggleIndividualDelete()" style="flex: 1 1 45%; padding: 1.2rem; font-size: 1.3rem;">회원 개별 삭제</button>
      <button onclick="deleteAllMembers()" style="flex: 1 1 45%; padding: 1.2rem; font-size: 1.3rem;">회원 명단<br>전체 삭제</button>
    </div>
  </div>
  
  <!-- 회원 직접 추가 -->
<div style="margin-top: 3rem; margin-bottom: 2rem; font-size: 1.5rem;">
    <label style="font-weight: bold; display: block; margin-bottom: 1rem;">회원 직접 추가:</label>
  
    <input type="text" id="manualName" placeholder="성명 입력"
      style="width: 160px; font-size: 1.3rem; padding: 0.6rem; margin-right: 1rem; margin-bottom: 1rem;" />
    
    <input type="text" id="manualTeam" placeholder="소속 입력"
      style="width: 200px; font-size: 1.3rem; padding: 0.6rem; margin-right: 1rem; margin-bottom: 1rem;" />
  
    <br>
    <button onclick="addManualMember()"
      style="padding: 0.7rem 1.4rem; font-size: 1.3rem;">회원 직접 추가</button>
  </div>
  
  
  
    <!-- 회원 명단 표시 -->
    <div id="memberListDisplay" style="margin-top:1rem;"></div>
  </div>
  

  </div>
<!-- 경기 점수 탭 시작 -->
<!-- ✅ 경기 점수 탭 전체 구조 -->
<div id="scoreTab" class="tab">
    <h2>경기 점수</h2>
  
    <!-- 시즌 설정 -->
    <div style="margin-bottom: 1rem; display: flex; align-items: center; flex-wrap: wrap; gap: 1.5rem;">
      <div style="flex: 1;">
        <label style="font-size: 1.3rem;">시즌 시작일:</label><br>
        <input type="date" id="seasonStart" value="2025-03-01" style="font-size: 1.3rem; padding: 0.5rem;">
        <br><br>
        <label style="font-size: 1.3rem;">시즌 마감일:</label><br>
        <input type="date" id="seasonEnd" value="2026-02-28" style="font-size: 1.3rem; padding: 0.5rem;">
      </div>
  
      <!-- 포상금 설정 버튼 -->
      <div style="align-self: center;">
        <button onclick="openRewardSetting()" style="padding: 0.7rem 1.5rem; font-size: 1.1rem;">포상금<br>설정</button>
      </div>
    </div>
  
    <!-- 포상금 설정 입력 영역 -->
    <div id="rewardSettingArea" style="display: none; margin-top: 1.5rem;"></div>
  
    <!-- 출석 관리 버튼 + 영역 -->
    <div style="margin-bottom: 1.5rem;">
      <button onclick="toggleAttendanceHistory()" style="padding: 0.8rem 1.2rem; font-size: 1.1rem;">출석 관리</button>
    </div>
    <div id="attendanceHistoryArea" style="display: none; margin-top: 1.5rem; overflow: auto; max-height: 500px; max-width: 100%; border: 1px solid #ccc;"></div>
  
    <!-- TOP10 순위 보기 -->
    <div style="margin-bottom: 1.5rem;">
      <button onclick="showTop10()" style="font-size: 1.3rem; padding: 1rem 1.5rem;">TOP10 순위 보기</button>
      <div id="top10Display" style="margin-top: 1rem; background: #fff8e1; padding: 1rem; border-radius: 8px;"></div>
    </div>
  
    <!-- 전체 회원 점수 확인 -->
    <div style="margin-bottom: 2rem;">
      <button onclick="showAllScores()" style="font-size: 1.3rem; padding: 1rem 1.5rem;">전체 회원 점수 확인</button>
      <div id="allScoresArea" style="margin-top: 1rem;"></div>
      <canvas id="scoreChart" height="300" style="width:100%; max-height:400px;"></canvas>
    </div>
 
  
  <div style="margin-bottom: 1rem;">
    총 인원: <span id="matchTotal">0</span>명 
    A팀: <span id="matchA">0</span>명 /
    B팀: <span id="matchB">0</span>명 /
    C팀: <span id="matchC">0</span>명
  </div>
 
</div>



  <!-- JS 코드 -->
  <script>
   function confirmAndClearAttendance() {
    if (confirm("정말로 출석부를 삭제하시겠습니까?")) {
      clearCurrentAttendanceInputs(); // 원래 있던 삭제 함수 실행
    }
  }
    function showTab(tabId) {
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(tab => tab.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');

}
    // 날짜 선택 초기화
const yearSelect = document.getElementById("yearSelect");
const monthSelect = document.getElementById("monthSelect");
const daySelect = document.getElementById("daySelect");
const weekdayDisplay = document.getElementById("weekdayDisplay");

function setupDateListeners() {
  const yearSelect = document.getElementById("yearSelect");
  const monthSelect = document.getElementById("monthSelect");
  const daySelect = document.getElementById("daySelect");

  const handler = () => {
    updateWeekday();                 // 요일 갱신
    clearCurrentAttendanceInputs(); // 입력 초기화
    updateSelectOptions(document.querySelectorAll('.name-select'));
  };

  yearSelect.addEventListener("change", handler);
  monthSelect.addEventListener("change", handler);
  daySelect.addEventListener("change", handler);
}
function adjustStarter(team, delta) {
  const input = document.getElementById(`match${team}Starter`);
  let value = parseInt(input.value || 0);
  value += delta;
  if (value < 1) value = 1;
  input.value = value;
  suggestFormation(team);
}
function toggleCustomFormation(team) {
  const select = document.getElementById(`formation${team}Select`);
  const customDiv = document.getElementById(`formation${team}Custom`);

  if (select.value === "custom") {
    customDiv.style.display = "block";
  } else {
    customDiv.style.display = "none";
  }
}
function updateRemainingSpots(team) {
  const starter = parseInt(document.getElementById(`match${team}Starter`).value || 0);
  const df = parseInt(document.getElementById(`df${team}`).value || 0);
  const mf = parseInt(document.getElementById(`mf${team}`).value || 0);
  const fw = parseInt(document.getElementById(`fw${team}`).value || 0);

  const used = 1 + df + mf + fw; // GK 1명 포함
  const remaining = starter - used;

  const display = document.getElementById(`remaining${team}`);
  display.textContent = `남은 인원: ${remaining >= 0 ? remaining : 0}명`;
}

function toggleCustomFormation(team) {
  const select = document.getElementById(`formation${team}Select`);
  const customDiv = document.getElementById(`formation${team}Custom`);

  if (select.value === "custom") {
    customDiv.style.display = "block";
    updateRemainingSpots(team); // ✅ 표시 업데이트
  } else {
    customDiv.style.display = "none";
    document.getElementById(`remaining${team}`).textContent = "";
  }
}

function populateDateSelectors() {
  const now = new Date();

  const shortYears = [2025, 2026, 2027, 2028];
  yearSelect.innerHTML = "";
  shortYears.forEach(y => {
    const option = document.createElement("option");
    option.value = y;
    option.textContent = `${String(y).slice(2)}년`; // 25년, 26년 등
    yearSelect.appendChild(option);
  });

  // 월 초기화
  monthSelect.innerHTML = "";
  for (let m = 1; m <= 12; m++) {
    const option = document.createElement("option");
    option.value = m;
    option.textContent = `${m}월`;
    monthSelect.appendChild(option);
  }

  // 오늘 날짜 기본값 설정
  yearSelect.value = now.getFullYear();
  monthSelect.value = now.getMonth() + 1;

  // 일 초기화 (요일 색상 포함)
  const selectedYear = parseInt(yearSelect.value);
  const selectedMonth = parseInt(monthSelect.value);
  const lastDay = new Date(selectedYear, selectedMonth, 0).getDate();

  daySelect.innerHTML = "";
  for (let d = 1; d <= lastDay; d++) {
    const date = new Date(selectedYear, selectedMonth - 1, d);
    const weekday = date.getDay();
    let color = "black";
    if (weekday === 0) color = "red";
    else if (weekday === 6) color = "blue";

    const option = document.createElement("option");
    option.value = d;
    option.textContent = `${d}일`;
    option.style.color = color;  // ✅ 핵심!
    daySelect.appendChild(option);
  }

  daySelect.value = now.getDate();
  updateWeekday();
}
function updateRemainingPlayers(team) {
  const starterInput = document.getElementById(`match${team}Starter`);
  const df = parseInt(document.getElementById(`df${team}`).value) || 0;
  const mf = parseInt(document.getElementById(`mf${team}`).value) || 0;
  const fw = parseInt(document.getElementById(`fw${team}`).value) || 0;

  const starter = parseInt(starterInput.value) || 0;
  const used = 1 + df + mf + fw;
  const remaining = starter - used;

  const target = document.getElementById(`remaining${team}`);
  target.textContent = `남은 인원: ${remaining}명`;
}


function loadRankedAttendance() {
  const container = document.getElementById("attendanceList");
  container.innerHTML = "";

  if (memberList.length === 0) {
    alert("먼저 회원 명단을 업로드하세요.");
    return;
  }

  if (document.getElementById("selectedTable")) return;

  const wrapper = document.createElement("div");
  wrapper.style.display = "flex";
  wrapper.style.alignItems = "center";
  wrapper.style.gap = "30px";
  wrapper.style.flexWrap = "wrap";

  const select = document.createElement("select");
  select.id = "singleNameSelect";
  select.classList.add("name-select", "my-custom-style");
  select.style.fontSize = "1.3rem";
  select.style.marginBottom = "1rem";

  const defaultOption = document.createElement("option");
  defaultOption.value = "";
  defaultOption.textContent = "-- 성명 선택 --";
  select.appendChild(defaultOption);

  const sortedList = [...memberList].sort((a, b) => a.name.localeCompare(b.name, "ko"));
  sortedList.forEach(member => {
    const key = `${member.name}__${member.team || ""}`;
    if (selectedNames.includes(key)) return;

    const isDuplicate = memberList.filter(m => m.name === member.name).length > 1;

    const option = document.createElement("option");
    option.value = key;
    option.textContent = isDuplicate && member.team
      ? `${member.name}(${member.team})`
      : member.name;

    select.appendChild(option);
  });

  const nonMemberOption = document.createElement("option");
  nonMemberOption.value = "__비회원__";
  nonMemberOption.textContent = "➕ 비회원 추가";
  select.appendChild(nonMemberOption);

  select.addEventListener("change", () => {
    const fullKey = select.value;

    if (fullKey === "__비회원__") {
      showNonMemberInput(select);
      return;
    }

    if (!fullKey || selectedNames.includes(fullKey)) return;

    if (selectedNames.length >= 35) {
      alert("최대 35명까지만 등록할 수 있습니다.");
      return;
    }

    selectedNames.push(fullKey);
    updateSelectOptions(document.querySelectorAll('.name-select'));
    renderSelectedTable();
    updateSummary();

    localStorage.setItem("tempSelectedNames", JSON.stringify(selectedNames));
    localStorage.setItem("tempLateStatus", JSON.stringify(lateStatus));

    setTimeout(() => {
      select.selectedIndex = 0;
      updateSelectOptions(document.querySelectorAll(".name-select"));
    }, 500);

    // ✅ 새 줄로 자동 스크롤 이동
    setTimeout(() => {
      const lastRow = document.querySelector("#selectedTable tbody")?.lastElementChild;
      if (lastRow) {
        lastRow.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }
    }, 100);
  });

  const insertBtn = document.createElement("button");
  insertBtn.id = "middleInsertButton";
  insertBtn.textContent = "중간 삽입";
  insertBtn.style.fontSize = "1rem";
  insertBtn.style.padding = "0.5rem 0.7rem";
  insertBtn.style.height = "38px";
  insertBtn.style.lineHeight = "1";
  insertBtn.style.boxSizing = "border-box";
  insertBtn.onclick = () => showMiddleInsertForm();

  wrapper.appendChild(select);
  wrapper.appendChild(insertBtn);
  container.appendChild(wrapper);

  // ✅ 테이블 래퍼 (스크롤 + thead 고정)
  const tableWrapper = document.createElement("div");
  tableWrapper.id = "selectedTableWrapper";
  tableWrapper.style.maxHeight = "300px";
  tableWrapper.style.overflowY = "auto";
  tableWrapper.style.border = "1px solid #ccc";
  tableWrapper.style.borderRadius = "8px";
  tableWrapper.style.marginTop = "1rem";
  tableWrapper.style.backgroundColor = "#fff";

  const table = document.createElement("table");
table.id = "selectedTable";
table.style.borderCollapse = "collapse";
table.style.width = "100%";
table.innerHTML = `
  <thead style="position: sticky; top: 0; background-color: #f9f9f9; z-index: 1;">
    <tr>
      <th>순위</th>
      <th>성명</th>
      <th>지각</th>
      <th>변경</th>
    </tr>
  </thead>
  <tbody id="selectedTableBody"></tbody>
`;

  tableWrapper.appendChild(table);
  container.appendChild(tableWrapper);

  renderSelectedTable();
  updateSelectOptions(document.querySelectorAll(".name-select"));
  localStorage.setItem("tempSelectedNames", JSON.stringify(selectedNames));
  localStorage.setItem("tempLateStatus", JSON.stringify(lateStatus));
}


function showNonMemberInput(select) {
  // 이미 입력창이 있으면 제거
  const existing = document.getElementById("nonMemberInputBox");
  if (existing) existing.remove();

  const box = document.createElement("div");
  box.id = "nonMemberInputBox";
  box.style.marginTop = "1rem";
  box.style.display = "flex";
  box.style.gap = "10px";
  box.style.alignItems = "center";

  const input = document.createElement("input");
  input.placeholder = "비회원 성명 입력";
  input.style.fontSize = "1.1rem";
  input.style.padding = "0.4rem";
  input.style.width = "160px";

  const saveBtn = document.createElement("button");
  saveBtn.textContent = "저장";
  saveBtn.onclick = () => {
    const name = input.value.trim();
    if (!name) {
      alert("이름을 입력하세요.");
      return;
    }
    if (selectedNames.includes(name)) {
      alert("이미 등록된 이름입니다.");
      return;
    }
    selectedNames.push(name);
    renderSelectedTable();
    updateSummary();
    select.value = "";
    box.remove();
  };

  const cancelBtn = document.createElement("button");
  cancelBtn.textContent = "취소";
  cancelBtn.onclick = () => {
    select.value = "";
    box.remove();
  };

  box.appendChild(input);
  box.appendChild(saveBtn);
  box.appendChild(cancelBtn);

  // select 바로 아래에 삽입
  select.parentNode.insertBefore(box, select.nextSibling);
}

function showMiddleInsertForm() {
  const container = document.getElementById("attendanceList");
  const existing = document.getElementById("middleInsertBox");
  if (existing) existing.remove();

  const box = document.createElement("div");
  box.id = "middleInsertBox";
  box.style.marginTop = "1rem";
  box.style.padding = "1rem";
  box.style.backgroundColor = "#f9f9f9";
  box.style.border = "1px solid #ccc";
  box.style.borderRadius = "8px";
  box.style.display = "flex";
  box.style.gap = "10px";
  box.style.alignItems = "center";
  box.style.flexWrap = "wrap";

  // ✅ 성명 선택 드롭다운
  const nameSelect = document.createElement("select");
  nameSelect.id = "middleInsertName";
  nameSelect.style.fontSize = "1.1rem";
  nameSelect.innerHTML = '<option value="">-- 성명 선택 --</option>';

  const sortedList = [...memberList].sort((a, b) => a.name.localeCompare(b.name, "ko"));
  sortedList.forEach(member => {
  const key = `${member.name}__${member.team || ""}`;
  if (selectedNames.includes(key)) return;

  const option = document.createElement("option");
  const isDuplicate = memberList.filter(m => m.name === member.name).length > 1;
  option.value = key;
  option.textContent = isDuplicate && member.team
    ? `${member.name}(${member.team})`
    : member.name;

  nameSelect.appendChild(option);
});

// ✅ 비회원 항목 추가
const nonMemberOption = document.createElement("option");
nonMemberOption.value = "__비회원__";
nonMemberOption.textContent = "➕ 비회원 추가";
nameSelect.appendChild(nonMemberOption);


  // ✅ 출석 순위 선택 드롭다운
  const rankSelect = document.createElement("select");
  rankSelect.id = "middleInsertRank";
  rankSelect.style.fontSize = "1.1rem";
  rankSelect.style.padding = "0.4rem 0.6rem";

  for (let i = 1; i <= 30; i++) {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = `${i}등`;
    rankSelect.appendChild(option);
  }

  // ✅ 저장 버튼
  const saveBtn = document.createElement("button");
  saveBtn.textContent = "저장";
  saveBtn.style.fontSize = "1.1rem";
  saveBtn.onclick = () => {
    const fullKey = nameSelect.value;
    const insertIndex = parseInt(rankSelect.value) - 1;

    // 중복 추가 방지
    if (selectedNames.includes(fullKey)) {
      alert("이미 선택된 이름입니다.");
      return;
    }

    if (!fullKey || isNaN(insertIndex) || insertIndex < 0 || insertIndex > selectedNames.length) {
      alert("입력이 올바르지 않습니다.");
      return;
    }

    selectedNames.splice(insertIndex, 0, fullKey);
    renderSelectedTable();
    updateSummary();
    updateSelectOptions(document.querySelectorAll(".name-select"));
    box.remove(); // 성공 후 창 닫기
  };

  // ✅ 닫기 버튼
  const closeBtn = document.createElement("button");
  closeBtn.textContent = "닫기";
  closeBtn.style.fontSize = "1.1rem";
  closeBtn.onclick = () => {
    box.remove(); // 입력창 제거
  };

  // ✅ 구성 요소 추가
  box.appendChild(nameSelect);
  box.appendChild(rankSelect);
  box.appendChild(saveBtn);
  box.appendChild(closeBtn);
  
  const insertBtn = document.getElementById("middleInsertButton");
if (insertBtn) {
  insertBtn.insertAdjacentElement("afterend", box);  // 버튼 바로 아래
} else {
  container.appendChild(box); // fallback
}
}


function renderSelectedTable() {
   
  const table = document.getElementById("selectedTable");
if (!table) {
  console.error("❌ selectedTable 테이블이 존재하지 않습니다.");
  return;
}

let tbody = table.querySelector("tbody");
if (!tbody) {
  tbody = document.createElement("tbody");
  table.appendChild(tbody);
}
tbody.innerHTML = "";  // 기존 내용 초기화
  
  
  selectedNames.forEach((fullKey, idx) => {
    const row = document.createElement("tr");
    row.style.fontSize = "1.3rem";
    row.style.border = "1px solid #ddd";

    const rankTd = document.createElement("td");
    rankTd.textContent = `${idx + 1}`;
    rankTd.style.textAlign = "center";

    const nameTd = document.createElement("td");
    nameTd.style.textAlign = "center";
    const [name, team] = fullKey.split("__");
    const isDuplicate = memberList.filter(m => m.name === name).length > 1;
    const displayName = isDuplicate && team ? `${name}(${team})` : name;
    const nameSpan = document.createElement("span");
    nameSpan.textContent = displayName;
    nameTd.appendChild(nameSpan);

    const lateTd = document.createElement("td");
    lateTd.style.textAlign = "center";
    const lateCheck = document.createElement("input");
    lateCheck.type = "checkbox";
    lateCheck.checked = lateStatus[fullKey] || false;
    lateCheck.style.transform = "scale(1.3)";
    lateCheck.style.marginLeft = "8px";
    lateCheck.onchange = () => {
      lateStatus[fullKey] = lateCheck.checked;
      updateLateStatusTable();
      renderNameDropdown();
      updateSelectOptions(document.querySelectorAll(".name-select"));
    };
    lateTd.appendChild(lateCheck);

    const controlTd = document.createElement("td");
    controlTd.style.textAlign = "center";

    const upBtn = document.createElement("button");
    upBtn.textContent = "▲";
    upBtn.style.marginRight = "2px";
    upBtn.style.fontSize = "0.8rem";
    upBtn.style.padding = "1px 5px";
    upBtn.style.marginLeft = "6px";
    upBtn.onclick = () => {
      if (idx === 0) return;
      [selectedNames[idx - 1], selectedNames[idx]] = [selectedNames[idx], selectedNames[idx - 1]];
      renderSelectedTable();
      updateSummary();
    };

    const downBtn = document.createElement("button");
    downBtn.textContent = "▼";
    downBtn.style.marginRight = "8px";
    downBtn.style.fontSize = "0.8rem";
    downBtn.style.padding = "1px 5px";
    downBtn.onclick = () => {
      if (idx === selectedNames.length - 1) return;
      [selectedNames[idx + 1], selectedNames[idx]] = [selectedNames[idx], selectedNames[idx + 1]];
      renderSelectedTable();
      updateSummary();
    };

    const delBtn = document.createElement("button");
    delBtn.textContent = "삭제";
    delBtn.style.fontSize = "0.8rem";
    delBtn.style.lineHeight = "1";
    delBtn.style.padding = "0.2rem 0.5rem";
    delBtn.style.marginLeft = "0px";
    delBtn.onclick = () => {
  selectedNames.splice(idx, 1);
  renderSelectedTable();
  updateSummary();
  updateLateStatusTable(); // ← 삭제 후 상태 테이블도 반영
};


    controlTd.appendChild(upBtn);
    controlTd.appendChild(downBtn);
    controlTd.appendChild(delBtn);

    row.appendChild(rankTd);
    row.appendChild(nameTd);
    row.appendChild(lateTd);
    row.appendChild(controlTd);
    tbody.appendChild(row);
  });

  const wrapper = document.getElementById("attendanceTableWrapper");
  if (wrapper) {
    wrapper.scrollTop = wrapper.scrollHeight;
  }

  updateLateStatusTable(); // 마지막에 갱신
}



function updateLateStatusTable() {
  const existingStatus = document.getElementById("lateStatusTable");
  if (existingStatus) existingStatus.remove();

  const statusTable = document.createElement("table");
  statusTable.id = "lateStatusTable";
  statusTable.style.marginTop = "1.5rem";
  statusTable.style.borderCollapse = "collapse";
  statusTable.style.width = "100%";

  statusTable.innerHTML = `
    <thead>
      <tr style="background:#f0f0f0;">
        <th style="padding: 6px;">순위</th>
        <th style="padding: 6px;">성명</th>
        <th style="padding: 6px;">상태</th>
      </tr>
    </thead>
    <tbody>
      ${selectedNames.map((fullKey, idx) => {
        const [name, team] = fullKey.split("__");
        const isDuplicate = memberList.filter(m => m.name === name).length > 1;
        const displayName = isDuplicate && team ? `${name}(${team})` : name;
        const isLate = lateStatus[fullKey] || false;
        const status = isLate
          ? `<span style="color:red; font-weight:bold;">지각</span>`
          : "정상";

        return `
          <tr>
            <td style="text-align:center;">${idx + 1}</td>
            <td style="text-align:center;">${displayName}</td>
            <td style="text-align:center;">${status}</td>
          </tr>
        `;
      }).join("")}
    </tbody>
  `;
  const parent = document.getElementById("attendanceList");
if (parent) {
  parent.appendChild(statusTable);
}
}


function renderNameDropdown() {
  const select = document.getElementById("singleNameSelect");
  if (!select) return;

  select.innerHTML = "";

  // 기본 안내 옵션
  const defaultOption = document.createElement("option");
  defaultOption.value = "";
  defaultOption.textContent = "-- 성명 선택 --";
  select.appendChild(defaultOption);

  // 정렬된 명단 기준 드롭다운 구성
  const sortedList = [...memberList].sort((a, b) => a.name.localeCompare(b.name, "ko"));
  sortedList.forEach(member => {
    const fullKey = `${member.name}__${member.team || ""}`;

    if (selectedNames.includes(fullKey)) return; // 이미 선택된 사람은 제외

    const isDuplicate = memberList.filter(m => m.name === member.name).length > 1;

    const option = document.createElement("option");
    option.value = fullKey;
    option.textContent = isDuplicate && member.team
      ? `${member.name}(${member.team})`
      : member.name;

    select.appendChild(option);
  });

  // ✅ 비회원 추가 옵션은 한 번만!
  const nonMemberOption = document.createElement("option");
  nonMemberOption.value = "__비회원__";
  nonMemberOption.textContent = "➕ 비회원 추가";
  select.appendChild(nonMemberOption);

  select.value = "";
}


let matchPlayers = []; // 1경기 참가자 저장용

function loadMatchPlayers() {
    if (!window.attendanceHistoryData || Object.keys(attendanceHistoryData).length === 0) {
    alert("출석 저장된 데이터가 없습니다.");
    return;
  }

  // 가장 최근 날짜를 찾음 (정렬된 마지막 값)
  const latestDate = Object.keys(attendanceHistoryData).sort().pop();
  const latestData = attendanceHistoryData[latestDate];

  matchPlayers = [...latestData];

  const total = matchPlayers.length;
  const cNum = parseInt(document.getElementById("matchCInput").value || 0);
  const rest = Math.max(0, total - cNum);
  const aNum = Math.ceil(rest / 2);
  const bNum = Math.floor(rest / 2);

  document.getElementById("matchAStarter").value = aNum;
  document.getElementById("matchBStarter").value = bNum;

  updateMatchCounts();

  // ✅ 포메이션 추천 즉시 표시
  suggestFormation("A");
  suggestFormation("B");

  console.log(`최근 출석 날짜: ${latestDate}`);
}

function updateMatchCounts() {
  const total = matchPlayers.length;
  const cNum = parseInt(document.getElementById("matchCInput").value || 0);
  const rest = Math.max(0, total - cNum);
  const aNum = Math.ceil(rest / 2);
  const bNum = Math.floor(rest / 2);

  document.getElementById("matchTotal").textContent = total;
  document.getElementById("matchA").textContent = aNum;
  document.getElementById("matchB").textContent = bNum;
  document.getElementById("matchC").textContent = cNum;

  document.getElementById("matchAInfo").textContent = `A팀 출석 인원: ${aNum}명`;
  document.getElementById("matchBInfo").textContent = `B팀 출석 인원: ${bNum}명`;
}

function suggestFormation(team) {
  const starter = parseInt(document.getElementById(`match${team}Starter`).value || 0);
  const target = document.getElementById(`suggest${team}`);
  const select = document.getElementById(`formation${team}Select`);
  const list = {
    12: ["4-5-2", "4-4-3", "3-4-4"],
    11: ["4-3-3", "4-4-2", "3-5-2", "3-4-3"], 
    10: ["4-4-1", "3-4-2", "3-5-1", "4-3-2"],
    9: ["3-4-1", "4-3-1", "3-3-2"],
    8: ["3-3-1", "2-4-1", "4-2-1"],
    7: ["3-3-0", "2-3-1", "3-2-1"]
  };
  const recommended = list[starter] || [];

  // 추천 포메이션 텍스트 출력 (굵게 + 확대)
  target.textContent = recommended.join(", ");

  // 셀렉트 박스 옵션 초기화
  select.innerHTML = '<option value="">-- 추천 선택 --</option>';

  // 추천 포메이션을 옵션으로 추가
  recommended.forEach((form, i) => {
    const option = document.createElement("option");
    option.value = form;
    option.textContent = form;
    if (i === 0) option.selected = true;
    select.appendChild(option);
  });

  // '직접 입력' 옵션 추가
  const customOption = document.createElement("option");
  customOption.value = "custom";
  customOption.textContent = "직접 입력";
  select.appendChild(customOption);
}
let formationA = null;
let formationB = null;

function drawMatchPositions() {
  if (!matchPlayers || matchPlayers.length === 0) {
    alert("출석부를 먼저 적용해주세요.");
    return;
  }

  const formationASelect = document.getElementById("formationASelect").value;
  const formationBSelect = document.getElementById("formationBSelect").value;
  if (!formationASelect || !formationBSelect) {
    alert("포메이션을 먼저 선택하세요.");
    return;
  }

  currentPlayerIndex = 0;
  openedEnvelopes = [];
  confirmedSelections = {};

  let formationA, formationB;
  if (formationASelect === "custom") {
    const df = parseInt(document.getElementById("dfA").value || 0);
    const mf = parseInt(document.getElementById("mfA").value || 0);
    const fw = parseInt(document.getElementById("fwA").value || 0);
    const starter = parseInt(document.getElementById("matchAStarter").value || 0);
    const total = 1 + df + mf + fw;
    if (total > starter) {
      alert(`⚠️ A팀 포지션 수(${total})가 선발 인원(${starter})을 초과했습니다.`);
      return;
    }
    formationA = `${df}-${mf}-${fw}`;
  } else {
    formationA = formationASelect;
  }

  if (formationBSelect === "custom") {
    const df = parseInt(document.getElementById("dfB").value || 0);
    const mf = parseInt(document.getElementById("mfB").value || 0);
    const fw = parseInt(document.getElementById("fwB").value || 0);
    const starter = parseInt(document.getElementById("matchBStarter").value || 0);
    const total = 1 + df + mf + fw;
if (starter === 0 && total > 0) {
  alert(`⚠️ B팀을 뽑지 않으려면 포지션도 모두 0이어야 합니다.`);
  return;
}
if (total > starter) {
  alert(`⚠️ B팀 포지션 수(${total})가 선발 인원(${starter})을 초과했습니다.`);
  return;
}
    formationB = `${df}-${mf}-${fw}`;
  } else {
    formationB = formationBSelect;
  }

  const [dfA, mfA, fwA] = formationA.split("-").map(Number);
  const [dfB, mfB, fwB] = formationB.split("-").map(Number);
  const aCount = 1 + dfA + mfA + fwA;
  const bCount = 1 + dfB + mfB + fwB;

  const players = [...matchPlayers];
  const total = players.length;
  const teamA = players.slice(0, aCount);
  const teamB = players.slice(aCount, aCount + bCount);

  // ⛳ C팀 인원은 입력된 값 기반으로 고정
  let cCount = parseInt(document.getElementById("matchCInput").value || 0);
let teamC = [];

if (cCount > 0) {
  teamC = players.slice(aCount + bCount, aCount + bCount + cCount);
} else {
  // 인원 남았을 경우, 남는 인원 A/B팀에 포함되도록 수정
  const restPlayers = players.slice(aCount + bCount);
  const half = Math.ceil(restPlayers.length / 2);
  teamA.push(...restPlayers.slice(0, half));
  teamB.push(...restPlayers.slice(half));
}

  window.matchTeamAssignments = {
    formationA,
    formationB,
    teamA,
    teamB,
    teamC
  };

  const notes = [];

  // A팀 쪽지
  if (teamA.length > 0) {
    const totalPositions = 1 + dfA + mfA + fwA;
    notes.push("A팀 GK", ...Array(dfA).fill("A팀 DF"), ...Array(mfA).fill("A팀 MF"), ...Array(fwA).fill("A팀 FW"));
    const extra = teamA.length - totalPositions;
    if (extra > 0) notes.push(...Array(extra).fill("A팀 휴식"));
  }

  // B팀 쪽지
  if (teamB.length > 0) {
    const totalPositions = 1 + dfB + mfB + fwB;
    notes.push("B팀 GK", ...Array(dfB).fill("B팀 DF"), ...Array(mfB).fill("B팀 MF"), ...Array(fwB).fill("B팀 FW"));
    const extra = teamB.length - totalPositions;
    if (extra > 0) notes.push(...Array(extra).fill("B팀 휴식"));
  }

 // C팀 쪽지 (인원 수 기준 생성)
if (teamC.length > 0) {
  notes.push(...Array(teamC.length).fill("C팀"));
}


  // 셔플
  window.shuffledNotes = [...notes];
  for (let i = shuffledNotes.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffledNotes[i], shuffledNotes[j]] = [shuffledNotes[j], shuffledNotes[i]];
  }

  setupVotingOrder();
  renderEnvelopes();

  document.getElementById("seasonStart").parentElement.style.display = "none";
  document.getElementById("rewardSettingArea").style.display = "none";
  document.getElementById("top10Display").style.display = "none";
  document.getElementById("allScoresArea").style.display = "none";
  document.getElementById("attendanceHistoryArea").style.display = "none";
  document.getElementById("drawModalOverlay").style.display = "flex";

  console.log("쪽지 목록 확인:", shuffledNotes);
}


function assignTeams() {
  const numPlayers = parseInt(document.getElementById("matchCount").value);
  const formation = document.getElementById("formationSelect").value;
  const [df, mf, fw] = formation.split("-").map(Number);

  const selected = [...savedAttendanceData] // 출석 저장된 명단
    .filter(p => memberList.map(m => m.name).includes(p.name))
    .slice(0, numPlayers);

  if (selected.length < numPlayers) {
    alert(`출석 인원이 ${numPlayers}명보다 적습니다.`);
    return;
  }

  // 셔플
  const shuffled = [...selected].sort(() => Math.random() - 0.5);

  const GK = shuffled[0].name;
  const DFs = shuffled.slice(1, 1 + df).map(p => p.name);
  const MFs = shuffled.slice(1 + df, 1 + df + mf).map(p => p.name);
  const FWs = shuffled.slice(1 + df + mf, 1 + df + mf + fw).map(p => p.name);

  // 팀 분할 (나머지 인원 자동 A/B 배정)
  const teamA = [], teamB = [];
  shuffled.forEach((p, i) => {
    if (i % 2 === 0) teamA.push(p.name);
    else teamB.push(p.name);
  });

  let html = `<h3>포지션 배정 (${formation})</h3>`;
  html += `<p><strong>GK:</strong> ${GK}</p>`;
  html += `<p><strong>DF:</strong> ${DFs.join(", ")}</p>`;
  html += `<p><strong>MF:</strong> ${MFs.join(", ")}</p>`;
  html += `<p><strong>FW:</strong> ${FWs.join(", ")}</p>`;

  html += `<h3>A팀</h3><ul>${teamA.map(n => `<li>${n}</li>`).join("")}</ul>`;
  html += `<h3>B팀</h3><ul>${teamB.map(n => `<li>${n}</li>`).join("")}</ul>`;

  document.getElementById("teamResult").innerHTML = html;
}


function clearCurrentAttendanceInputs() {
  // 선택된 이름 배열과 상태 초기화
  selectedNames = [];
  lateStatus = {};

  // 출석 테이블 삭제
  const table = document.getElementById("selectedTable");
  if (table) table.remove();

  // 지각 상태 테이블도 삭제
  const status = document.getElementById("lateStatusTable");
  if (status) status.remove();

  // 중간 삽입 입력창이 있으면 삭제
  const middleBox = document.getElementById("middleInsertBox");
  if (middleBox) middleBox.remove();

  // 요약 영역 초기화
  const summary = document.getElementById("attendanceSummary");
  if (summary) summary.innerHTML = "";

  // 선택 드롭다운 재로드
  loadRankedAttendance();  // 다시 초기 화면 렌더링
}


function updateSelectOptions(selects) {
  const selectedKeys = [...selectedNames]; // fullKey 기준으로 체크해야 정확

  selects.forEach(select => {
    const current = select.value;
    Array.from(select.options).forEach(option => {
      if (option.value === "") return;

      // 비회원 추가는 항상 표시
      if (option.value === "__비회원__") {
        option.hidden = false;
        return;
      }

      // 이미 선택된 항목은 숨김 (단, 현재 선택한 건 유지)
      option.hidden = selectedKeys.includes(option.value) && option.value !== current;
    });
  });
}

function updateSummary() {
  const summaryDiv = document.getElementById("attendanceSummary");
  let summaryHtml = ""; // ✅ 요약 문자열 초기화

  for (let i = 0; i < 30; i++) {
    const select = document.querySelector(`.name-select[data-index='${i}']`);
    const input = document.querySelector(`.manual-input[data-index='${i}']`);
    const lateCheckbox = document.querySelector(`.late-check[data-index='${i}']`);

    let name = "";

    if (input && input.value.trim() !== "") {
      name = input.value.trim();
    } else if (select && select.value.trim() !== "") {
      name = select.value.trim();
    }

    if (name === "") continue;

    const isLate = lateCheckbox?.checked || false;
    const flagText = isLate ? " (지각)" : "";

    summaryHtml += `${i + 1}등: ${name}${flagText}<br>`;
  }

  summaryDiv.innerHTML = summaryHtml; // ✅ 요약 HTML 표시
}




let savedAttendanceData = [];

function saveAttendance() {
  savedAttendanceData = [];

  for (let i = 0; i < selectedNames.length; i++) {
    const fullKey = selectedNames[i];
    const [name] = fullKey.split("__");

    const late = lateStatus[name] || false;

    savedAttendanceData.push({
      rank: i + 1,
      name,
      late,
      leave: false,
      isNonMember: false,
      score: late ? 5 : 10
    });
  }

  // 날짜 키
  const year = document.getElementById("yearSelect").value;
  const month = document.getElementById("monthSelect").value.padStart(2, '0');
  const day = document.getElementById("daySelect").value.padStart(2, '0');
  const dateKey = `${year}-${month}-${day}`;

  if (!window.attendanceHistoryData) window.attendanceHistoryData = {};
  window.attendanceHistoryData[dateKey] = [...savedAttendanceData];

  localStorage.setItem("attendanceHistoryData", JSON.stringify(attendanceHistoryData));

  alert(`출석 정보가 저장되었습니다 (${dateKey})`);
  renderAttendanceHistory();
}



function updateTeamCounts() {
  const total = savedAttendanceData.filter(p => memberList.map(m => m.name).includes(p.name)).length;
  const cNum = parseInt(document.getElementById("cTeamInput").value || 0);
  const rest = Math.max(0, total - cNum);
  const aNum = Math.ceil(rest / 2);
  const bNum = Math.floor(rest / 2);

  document.getElementById("totalCount").textContent = total;
  document.getElementById("cCount").textContent = cNum;
  document.getElementById("aCount").textContent = aNum;
  document.getElementById("bCount").textContent = bNum;
}


function renderAttendanceHistory() {
  const container = document.getElementById("attendanceHistory");
  if (!window.attendanceHistoryData || Object.keys(attendanceHistoryData).length === 0) {
  container.innerHTML = "<p>저장된 출석 데이터가 없습니다.</p>";
  return;
}


  // 날짜 목록 (열)
  const dates = Object.keys(attendanceHistoryData).sort(); // 날짜순 정렬

  // 회원 목록 (행) - 가나다순
  const sortedMembers = [...memberList].sort((a, b) => a.name.localeCompare(b.name, "ko"));

  // 표 생성
  let html = "<table border='1' cellpadding='6' style='border-collapse: collapse; min-width: 600px; text-align: center;'>";

  // 헤더
  html += "<thead><tr><th>성명</th>";
  dates.forEach(date => {
    html += `<th>${date}</th>`;
  });
  html += "</tr></thead><tbody>";

  // 행 생성
  sortedMembers.forEach(member => {
    html += `<tr><td>${member.name}</td>`;

    dates.forEach(date => {
      const records = attendanceHistoryData[date];
      const entry = records.find(r => r.name === member.name);

      let status = "";
      if (entry) {
        if (entry.late || entry.leave) {
          status = "지각"; // 지각 or 조퇴 or 둘 다 → 지각으로 표시
        } else {
          status = "참석";
        }
      }

      html += `<td>${status}</td>`;
    });

    html += "</tr>";
  });

  html += "</tbody></table>";
  container.innerHTML = html;
}



function updateWeekday() {
  const y = parseInt(yearSelect.value);
  const m = parseInt(monthSelect.value) - 1; // 0-indexed
  const d = parseInt(daySelect.value);
  const date = new Date(y, m, d);
  const weekday = ["일", "월", "화", "수", "목", "금", "토"][date.getDay()];
  
  weekdayDisplay.textContent = `${weekday}`; // ← "요일" 제거, 한 글자만 표시

  // 색상 지정
  let color = "black";
  if (weekday === "토") color = "blue";
  if (weekday === "일") color = "red";
  weekdayDisplay.style.color = color;

  // ✅ 글자 크기 키우기 추가
  weekdayDisplay.style.fontSize = "1.6rem";  // 원하는 크기로 조절 가능
}


// 이벤트 바인딩
yearSelect.addEventListener("change", updateWeekday);
monthSelect.addEventListener("change", updateWeekday);
daySelect.addEventListener("change", updateWeekday);

populateDateSelectors();
setupDateListeners();

let selectedNames = [];
let lateStatus = {};
let memberList = [];

document.getElementById("excelFileInput").addEventListener("change", function (e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];

    const memberData = [];
    let row = 3;

    while (true) {
      const nameCell = sheet[`B${row}`];
      const teamCell = sheet[`D${row}`];
      if (!nameCell && !teamCell) break;

      const name = nameCell ? nameCell.v.trim() : "";
      const team = teamCell ? teamCell.v.trim() : "";

      if (name !== "") {
        memberData.push({ name, team });
      }
      row++;
    }

    // ✅ 기존 memberList와 병합
    const existingNames = new Set(memberList.map(m => m.name));
    const newMembers = memberData.filter(m => !existingNames.has(m.name));
    memberList = [...memberList, ...newMembers];

    // ✅ 저장
    localStorage.setItem("memberList", JSON.stringify(memberList));

    alert("엑셀 파일의 회원 명단을 기존 명단에 추가했습니다.");
    downloadMemberList(); // 화면 출력 갱신
  };
  reader.readAsArrayBuffer(file);
});

let openedEnvelopes = [];
let confirmedSelections = {};
let currentPlayerIndex = 0;
let playerVoteCount = [];  // 이후 단계에서 설정됨
let confirmedIndexes = [];  // ✅ 확정된 쪽지 인덱스를 저장


function renderEnvelopes() {
  showVotingInfo();

  const container = document.getElementById("envelopeArea");
  container.innerHTML = "";

  const playerName = voteOrder[currentPlayerIndex]?.name;

  shuffledNotes.forEach((note, index) => {
    const box = document.createElement("div");
    box.id = `envelope-${index}`;
    box.className = "envelope-box envelope";  // ✅ 여기에 class 추가

    // 🔁 이 부분 수정!
    const isConfirmed = confirmedIndexes.includes(index);
    const isOpened = openedEnvelopes.some(e => e.index === index);

    box.textContent = isConfirmed ? "✅" : isOpened ? "💌" : "✉️";
    box.style.cursor = isConfirmed ? "not-allowed" : "pointer";
    box.style.userSelect = "none";
    box.style.width = "48px";
    box.style.height = "48px";
    box.style.fontSize = "1.4rem";
    box.style.display = "flex";
    box.style.alignItems = "center";
    box.style.justifyContent = "center";
    box.style.border = "1px solid #ccc";
    box.style.borderRadius = "6px";
    box.style.backgroundColor = "#ffffff";
    box.style.margin = "4px";

    if (isOpened || isConfirmed) {
      if (note.startsWith("A팀")) box.style.backgroundColor = "#fff9c4";
      else if (note.startsWith("B팀")) box.style.backgroundColor = "#ffe0b2";
      else if (note.startsWith("C팀")) box.style.backgroundColor = "#bbdefb";
      else if (note.startsWith("A팀 휴식") || note.startsWith("B팀 휴식")) box.style.backgroundColor = "#eee";

      if (note.includes("FW")) {
        box.style.color = "#e53935";
        box.style.fontWeight = "bold";
      } else if (note.includes("MF")) {
        box.style.color = "#388e3c";
        box.style.fontWeight = "bold";
      } else if (note.includes("DF")) {
        box.style.color = "#1565c0";
        box.style.fontWeight = "bold";
      } else if (note.includes("GK")) {
        box.style.color = "#000";
        box.style.fontWeight = "bold";
      }
    }

    if (!isConfirmed) {
      box.onclick = () => handleEnvelopeClick(index);
    } else {
      box.style.pointerEvents = "none";
      box.style.opacity = "0.6";
    }

    container.appendChild(box);
  });
}






function handleEnvelopeClick(index) {
  const box = document.getElementById(`envelope-${index}`);
  if (confirmedSelections[index]) return;

  const voteLimit = playerVoteCount[currentPlayerIndex] || 1;
  if (openedEnvelopes.length >= voteLimit) return;
  if (openedEnvelopes.some(e => e.index === index)) return;

  // 시각적 변경 추가
  box.textContent = "💌";
  box.style.cursor = "default";
  box.classList.add("selected");  // 추가된 부분

  openedEnvelopes.push({ index, value: shuffledNotes[index] });

  if (openedEnvelopes.length === voteLimit) {
    setTimeout(() => {
      showSelectionModal();
    }, 100);
  }
}


function downloadMemberList() {
  const listArea = document.getElementById("memberListDisplay");

  if (memberList.length === 0) {
    listArea.innerHTML = "회원 명단이 없습니다.";
    return;
  }

  // 가나다순 정렬
  memberList.sort((a, b) => a.name.localeCompare(b.name, "ko"));

  let html = "<strong>회원 명단:</strong><br><br>";
  html += `
    <table border="1" cellpadding="6" style="border-collapse: collapse; width: 100%; text-align: center;">
      <thead style="background-color: #f0f0f0;">
        <tr>
          <th>성명</th>
          <th>소속</th>
          ${showEditTeamButtons ? "<th>수정</th>" : ""}
          ${showDeleteButtons ? "<th>삭제</th>" : ""}
        </tr>
      </thead>
      <tbody>
  `;

  memberList.forEach((m, i) => {
    html += `<tr>
      <td>${m.name}</td>
      <td id="teamCell${i}">
        ${m.team || ""}
        ${showEditTeamButtons ? `<button onclick="showEditTeamInput(${i})" style="margin-left: 6px;">수정</button>` : ""}
      </td>`;

    if (showEditTeamButtons) {
      html += `<td id="editCell${i}" style="display:none;">
        <input type="text" id="newTeam${i}" placeholder="수정할 소속 입력" value="${m.team || ""}" />
        <button onclick="saveEditedTeam(${i})">저장</button>
      </td>`;
    }

    if (showDeleteButtons) {
      html += `<td><button onclick="deleteMember(${i})" style="
        background-color: #f8d7da;
        color: #721c24;
        border: none;
        padding: 4px 10px;
        border-radius: 6px;
        cursor: pointer;"
        onmouseover="this.style.backgroundColor='#f5c6cb'" onmouseout="this.style.backgroundColor='#f8d7da'">삭제</button></td>`;
    }

    html += `</tr>`;
  });

  html += "</tbody></table>";
  listArea.innerHTML = html;
}


function addManualMember() {
  const nameInput = document.getElementById("manualName");
  const teamInput = document.getElementById("manualTeam");

  const name = nameInput.value.trim();
  const team = teamInput.value.trim();

  if (name === "") {
    alert("성명을 입력해주세요.");
    return;
  }

  // 회원 추가
  memberList.push({ name, team });

  // ✅ 저장
  localStorage.setItem("memberList", JSON.stringify(memberList));

  // 입력창 초기화
  nameInput.value = "";
  teamInput.value = "";

  alert(`${name} 님이 추가되었습니다.`);
  downloadMemberList();
}




// 🔽 여기에 함께 추가
let showDeleteButtons = false;
let showEditTeamButtons = false;

function toggleIndividualDelete() {
  showDeleteButtons = !showDeleteButtons;
  downloadMemberList(); // 다시 출력
}

function toggleEditTeam() {
  showEditTeamButtons = !showEditTeamButtons;
  downloadMemberList(); // 다시 출력
}
function showEditTeamInput(index) {
  const editCell = document.getElementById(`editCell${index}`);
  if (editCell) editCell.style.display = "table-cell";
}


function deleteMember(index) {
  const pw = prompt("비밀번호를 입력하세요:");
  if (pw !== "0301") {
    alert("비밀번호가 올바르지 않습니다.");
    return;
  }

  if (!confirm("이 회원을 정말 삭제하시겠습니까?")) return;

  memberList.splice(index, 1);

  // ✅ 저장
  localStorage.setItem("memberList", JSON.stringify(memberList));

  downloadMemberList();
  loadRankedAttendance(); // 출석부에도 반영
}
function renderLiveResult() {
  const assigned = {};
  Object.entries(confirmedSelections).forEach(([playerName, position]) => {
    assigned[playerName] = position;
  });

  const rows = voteOrder.map(player => {
    const name = player.name;
    const pos = assigned[name] || "-";

    let team = "-";
    if (pos.includes("A팀")) team = "A팀";
    else if (pos.includes("B팀")) team = "B팀";
    else if (pos.includes("C팀")) team = "C팀";

    return `<tr><td>${name}</td><td>${team}</td><td>${pos}</td></tr>`;
  });

  const html = `
    <h3 style="margin-top:2rem;">실시간 추첨 결과</h3>
    <table border="1" cellpadding="6" style="border-collapse: collapse; width:100%; text-align:center;">
      <thead><tr><th>이름</th><th>팀</th><th>포지션</th></tr></thead>
      <tbody>${rows.join("")}</tbody>
    </table>
  `;

  document.getElementById("liveResultTable").innerHTML = html;
}


function saveEditedTeam(index) {
  const newTeamInput = document.getElementById(`newTeam${index}`);
  const newTeam = newTeamInput.value.trim();

  if (memberList[index]) {
    memberList[index].team = newTeam;

    // ✅ 저장
    localStorage.setItem("memberList", JSON.stringify(memberList));

    alert(`소속이 '${newTeam}'(으)로 변경되었습니다.`);
    downloadMemberList();
  }
}



function deleteAllMembers() {
  const pw = prompt("비밀번호를 입력하세요:");
  if (pw !== "0301") {
    alert("비밀번호가 올바르지 않습니다.");
    return;
  }

  if (!confirm("정말로 모든 회원을 삭제하시겠습니까?")) return;

  memberList = [];

  // ✅ 저장
  localStorage.setItem("memberList", JSON.stringify(memberList));

  document.getElementById("memberListDisplay").innerHTML = "";
  document.getElementById("excelFileInput").value = "";
  alert("회원 명단이 모두 삭제되었습니다.");
  loadRankedAttendance();
}

function assignTiedRanks(data) {
  let rank = 1;
  let skip = 0;
  let prevScore = null;

  return data.map((item, index) => {
    if (item.score === prevScore) {
      skip++;
    } else {
      rank += skip;
      skip = 1;
    }
    prevScore = item.score;
    return { ...item, rank: rank };
  });
}


function showTop10() {
  const startDate = document.getElementById("seasonStart").value;
  const endDate = document.getElementById("seasonEnd").value;
  if (!startDate || !endDate) {
    alert("시즌 시작일과 마감일을 설정해주세요.");
    return;
  }

  const allScores = getAllMemberScores();
const sorted = assignTiedRanks([...allScores].sort((a, b) => b.score - a.score || a.name.localeCompare(b.name, "ko"))).slice(0, 10);

  let html = `<strong>시즌 기간:</strong> ${startDate} ~ ${endDate}<br><br>`;
  html += `
    <table border="1" cellpadding="6" style="border-collapse: collapse; width:100%; text-align:center;">
      <thead style="background-color:#eee;">
        <tr>
          <th>순위</th><th>이름</th><th>포상금 (예정)</th>
        </tr>
      </thead><tbody>
  `;

  sorted.forEach(p => {
    const prize = prizeMap[p.rank] || 0;
    html += `<tr>
      <td>${p.rank}위</td>
      <td>${p.name}</td>
      <td>${prize.toLocaleString("ko-KR")}원</td>
    </tr>`;
  });

  html += `</tbody></table>`;
  document.getElementById("top10Display").innerHTML = html;
}

function getAllMemberScores() {
  if (!window.attendanceHistoryData || !Array.isArray(memberList)) return [];

  const memberNames = memberList.map(m => m.name); // 정식 회원 목록
  const scores = {};

  for (const date in attendanceHistoryData) {
    attendanceHistoryData[date].forEach(entry => {
      if (memberNames.includes(entry.name)) {
        if (!scores[entry.name]) scores[entry.name] = 0;
        scores[entry.name] += entry.score;
      }
    });
  }

  return Object.entries(scores).map(([name, score]) => ({ name, score }));
}

// 기본 포상금 설정 (수정 가능)
let prizeMap = {
  1: 120000,
  2: 70000,
  3: 60000,
  4: 50000,
  5: 50000,
  6: 30000,
  7: 30000,
  8: 30000,
  9: 30000,
  10: 30000,
};

function openRewardSetting() {
  const pw = prompt("포상금 설정을 위해 비밀번호를 입력하세요:");
  if (pw !== "0301") {
    alert("비밀번호가 올바르지 않습니다.\n관리자에게 문의하세요.");
    return;
  }

  const container = document.getElementById("rewardSettingArea");
  container.style.display = "block";

  let html = "<strong>포상금 설정 (₩):</strong><br>";

  for (let i = 1; i <= 10; i++) {
    html += `${i}위: <input type="number" id="prize${i}" value="${prizeMap[i]}" style="width:100px;"> 원<br>`;
  }

  html += `<button onclick="savePrizeMap()" style="margin-top:10px;">저장</button>`;
  container.innerHTML = html;
}


function savePrizeMap() {
  for (let i = 1; i <= 10; i++) {
    const input = document.getElementById(`prize${i}`);
    const value = parseInt(input.value);
    prizeMap[i] = isNaN(value) ? 0 : value;
  }

  document.getElementById("rewardSettingArea").innerHTML = "";
  document.getElementById("rewardSettingArea").style.display = "none";
  alert("포상금이 저장되었습니다.");
}


function showTop10() {
  if (savedAttendanceData.length === 0) {
    alert("출석 저장 후에 확인할 수 있습니다.");
    return;
  }

  const startDate = document.getElementById("seasonStart").value;
  const endDate = document.getElementById("seasonEnd").value;

  if (!startDate || !endDate) {
    alert("시즌 시작일과 마감일을 설정해주세요.");
    return;
  }
  let memberNames = memberList.map(m => m.name);
  let filtered = savedAttendanceData.filter(p => memberNames.includes(p.name));

  // 합산 점수 정렬 (현재는 단일 출석 저장 기준으로 정렬)
  const allScores = getAllMemberScores();
const sorted = assignTiedRanks([...allScores].sort((a, b) => b.score - a.score || a.name.localeCompare(b.name, "ko"))).slice(0, 10);

    let html = `<strong>시즌 기간:</strong> ${startDate} ~ ${endDate}<br><br>`;
html += `
  <table border="1" cellpadding="8" style="border-collapse: collapse; width: 100%; text-align: center;">
    <thead style="background-color: #eee;">
      <tr>
        <th>순위</th>
        <th>이름</th>
        <th>포상금 (예정)</th>
      </tr>
    </thead>
    <tbody>
`;

sorted.forEach((p) => {
  const prize = prizeMap[p.rank] || 0;
  const prizeStr = prize.toLocaleString("ko-KR") + "원";
  html += `
    <tr>
      <td>${p.rank}위</td>
      <td>${p.name}</td>
      <td>${prizeStr}</td>
    </tr>`;
});

html += `</tbody></table>`;
document.getElementById("top10Display").innerHTML = html;

}


function showAllScores() {
  const allScores = getAllMemberScores();
  const sorted = assignTiedRanks([...allScores].sort((a, b) => b.score - a.score || a.name.localeCompare(b.name, "ko")));

  // 테이블 출력
  let maxScore = Math.max(...sorted.map(p => p.score));
let html = `
  <table border="1" cellpadding="6" style="border-collapse: collapse; width:100%; text-align:center;">
    <thead style="background-color:#eee;">
      <tr><th>순위</th><th>이름</th><th>점수</th><th>참여 정도</th></tr>
    </thead><tbody>
`;

sorted.forEach(p => {
  const percent = (p.score / maxScore) * 100;
  html += `
    <tr>
      <td>${p.rank}위</td>
      <td>${p.name}</td>
      <td>${p.score}</td>
      <td>
        <div style="background:#eee; width:100%; height:20px; border-radius:4px; overflow:hidden;">
          <div style="background:#4caf50; width:${percent}%; height:100%;"></div>
        </div>
      </td>
    </tr>
  `;
});

html += `</tbody></table>`;
document.getElementById("allScoresArea").innerHTML = html;

}
function showSelectionModal() {
  const modal = document.getElementById("selectionModal");
  const optionsDiv = document.getElementById("modalOptions");
  const closeBtn = document.getElementById("modalCloseBtn");
if (closeBtn) closeBtn.style.display = "none";
  optionsDiv.innerHTML = "";

  let hasValidButton = false; // 유효한 선택 버튼이 있는지 확인

  openedEnvelopes.forEach((item, i) => {
    if (!item || typeof item.value === "undefined") {
      console.warn("⚠️ openedEnvelopes 항목 오류:", item);
      return; // 유효하지 않으면 건너뜀
    }

    const btn = document.createElement("button");
    btn.textContent = item.value;
    btn.style.padding = "0.8rem 1.2rem";
    btn.style.fontSize = "1.2rem";
    btn.style.cursor = "pointer";
    btn.style.border = "1px solid #ccc";
    btn.style.borderRadius = "8px";
    btn.style.margin = "0.4rem";

    // ✅ 팀별 배경색 구분
    if (item.value.startsWith("A팀")) {
      btn.style.backgroundColor = "#fff9c4"; // 연노랑
    } else if (item.value.startsWith("B팀")) {
      btn.style.backgroundColor = "#ffe0b2"; // 연주황
    } else if (item.value.startsWith("C팀")) {
      btn.style.backgroundColor = "#bbdefb"; // 연파랑
    } else {
      btn.style.backgroundColor = "#ffffff"; // 기본 흰색
    }

    btn.onclick = () => confirmSelection(i);
    optionsDiv.appendChild(btn);
    hasValidButton = true;
  });

  if (!hasValidButton) {
    optionsDiv.innerHTML = `<p style="font-size:1.2rem; color: red; font-weight: bold;">선택 가능한 쪽지가 없습니다.</p>`;
  }

  modal.style.display = "flex";
}


let lastSelection = null; // 최근 선택 기록 저장용

function confirmSelection(selectedIndex) {
  const selected = openedEnvelopes[selectedIndex];
  const player = voteOrder[currentPlayerIndex];
  console.log("🧪 선택된 쪽지 정보:", selected);
  console.log("🧪 selected.index:", selected?.index);
  console.log("🧪 shuffledNotes[selected.index]:", shuffledNotes[selected?.index]);

  if (!selected || typeof selected.value === "undefined" || typeof selected.index === "undefined") {
    console.error("❌ 선택한 쪽지의 값 또는 인덱스가 없습니다:", selected);
    alert("쪽지에 오류가 있어 저장할 수 없습니다.");
    return;
  }

  if (!player || !player.name) {
    console.error("❌ 현재 플레이어 정보가 없습니다:", player);
    alert("선택한 사람의 정보가 없어 저장할 수 없습니다.");
    return;
  }

  const playerName = player.name;

  // ✅ 최근 선택 기억 (되돌릴 때 사용)
  lastSelection = {
    playerName,
    selectedIndex,
    envelopeIndex: selected.index,
    value: selected.value
  };

  // ✅ 확정 저장
  confirmedSelections[playerName] = selected.value;
  confirmedIndexes.push(selected.index);  // ✅ 확정된 인덱스 기록

  console.log("✅ 저장됨:", playerName, "→", selected.value);

  // ✅ 쪽지 이모지 모양 변경 + 비활성화
  const confirmedBox = document.getElementById(`envelope-${selected.index}`);
  if (confirmedBox) {
    confirmedBox.textContent = "✅";
    confirmedBox.style.pointerEvents = "none";
    confirmedBox.style.opacity = "0.6";
  }

  // ✅ 실시간 표 갱신
  updateLiveResultTable();

  // 나머지 쪽지 원래대로
  openedEnvelopes.forEach((item) => {
  if (item.index !== selected.index && typeof item.index !== "undefined") {
    const box = document.getElementById(`envelope-${item.index}`);
    if (box) {
      box.textContent = "✉️";
      box.style.pointerEvents = "auto";
      box.style.opacity = "1";
    }
    }
  });

  // 다음 순서로 이동
  openedEnvelopes = [];
  currentPlayerIndex++;
 // 마지막 플레이어일 경우 모달을 닫지 않음
 if (currentPlayerIndex >= voteOrder.length) {
  document.getElementById("saveDrawButton").style.display = "block";  // 저장 버튼 표시
}


 // ✅ 선택된 쪽지 제외한 인덱스만 셔플 (내용 유지, 위치만 변경)
const selectedIdx = selected.index;
const remainingIndexes = [];

for (let i = 0; i < shuffledNotes.length; i++) {
  if (!confirmedIndexes.includes(i)) remainingIndexes.push(i);
}

// 쪽지 값은 유지하고 위치만 섞음
const remainingValues = remainingIndexes.map(i => shuffledNotes[i]);

// 셔플 함수
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}
shuffle(remainingValues);

// 섞인 값 다시 해당 위치에 재할당
remainingIndexes.forEach((i, idx) => {
  shuffledNotes[i] = remainingValues[idx];
});


  // ✅ 다음 차례 UI 갱신
  if (currentPlayerIndex >= voteOrder.length) {
    displayFinalTeamResults();
  } else {
    renderEnvelopes();  // 🔄 셔플된 결과로 렌더링
  }
}
function getDuplicateNames(memberList) {
  const nameCount = {};
  memberList.forEach(m => {
    nameCount[m.name] = (nameCount[m.name] || 0) + 1;
  });

  return Object.entries(nameCount)
    .filter(([_, count]) => count > 1)
    .map(([name]) => name);
}
function getDisplayName(name) {
  const isDuplicated = duplicateNames.includes(name);
  const member = memberList.find(m => m.name === name);
  return isDuplicated && member && member.team ? `${name} (${member.team})` : name;
}



function updateLiveResultTable() {
  const container = document.getElementById("liveResultTable");

  // ✅ 초기화: 테이블이 없으면 생성
  if (!document.getElementById("liveA")) {
    container.innerHTML = `
      <div>
        <h3 style="text-align: center;">A팀 추첨 결과</h3>
        <table id="liveA" border="1" cellpadding="8" style="background-color: #fff9c4; border-collapse: collapse; width: 45vw; min-width: 150px; max-width: 360px; text-align: center;">
          <thead><tr><th>이름</th><th>포지션</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="liveBWrapper" style="display:none;">
        <h3 style="text-align: center;">B팀 추첨 결과</h3>
        <table id="liveB" border="1" cellpadding="8" style="background-color: #ffe0b2; border-collapse: collapse; width: 45vw; min-width: 150px; max-width: 360px; text-align: center;">
          <thead><tr><th>이름</th><th>포지션</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="liveCWrapper" style="display:none;">
        <h3 style="text-align: center;">C팀 추첨 결과</h3>
        <table id="liveC" border="1" cellpadding="8" style="background-color: #bbdefb; border-collapse: collapse; width: 45vw; min-width: 150px; max-width: 360px; text-align: center;">
          <thead><tr><th>이름</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    `;
  }

  const aTable = document.getElementById("liveA").querySelector("tbody");
  const bContainer = document.getElementById("liveB")?.parentElement;
  const bTable = document.getElementById("liveB")?.querySelector("tbody");
  const cContainer = document.getElementById("liveC")?.parentElement;
  const cTable = document.getElementById("liveC")?.querySelector("tbody");

  aTable.innerHTML = "";
  if (bTable) bTable.innerHTML = "";
  if (cTable) cTable.innerHTML = "";
  if (bContainer) bContainer.style.display = "none";
  if (cContainer) cContainer.style.display = "none";

  let bCount = 0, cCount = 0;

  Object.entries(confirmedSelections).forEach(([name, pos]) => {
    const cleanPos = pos.replace(/^A팀 |^B팀 |^C팀 /, "");
    const row = `<tr><td>${name}</td><td>${cleanPos}</td></tr>`;

    if (pos.startsWith("A팀")) aTable.innerHTML += row;
    else if (pos.startsWith("B팀") && bTable) {
      bTable.innerHTML += row;
      bCount++;
    }
    else if (pos.startsWith("C팀") && cTable) {
      cTable.innerHTML += `<tr><td>${name}</td></tr>`;
      cCount++;
    }
  });

  if (bCount > 0 && bContainer) bContainer.style.display = "block";
  if (cCount > 0 && cContainer) cContainer.style.display = "block";
  else if (cContainer) cContainer.style.display = "none";
}




function displayFinalTeamResults() {
  const { formationA, formationB } = window.matchTeamAssignments;
  const resultDiv = document.getElementById("matchResult");

  const assigned = {};
  Object.entries(confirmedSelections).forEach(([name, pos]) => {
    assigned[name] = pos;
  });

  const teamData = {
    A: [],
    B: [],
    C: []
  };

  Object.entries(assigned).forEach(([name, pos]) => {
    const teamKey = pos.startsWith("A팀") ? "A" :
                    pos.startsWith("B팀") ? "B" : "C";
    teamData[teamKey].push({ name, position: pos.replace(/^[ABC]팀 /, "") });
  });

  // ✅ 동명이인 목록 구하기
  const nameCount = {};
  memberList.forEach(m => {
    nameCount[m.name] = (nameCount[m.name] || 0) + 1;
  });
  const duplicateNames = Object.entries(nameCount)
    .filter(([_, count]) => count > 1)
    .map(([name]) => name);

  // ✅ 이름 표시 함수
  function getDisplayName(name) {
    const isDup = duplicateNames.includes(name);
    const member = memberList.find(m => m.name === name);
    return isDup && member?.team ? `${name} (${member.team})` : name;
  }

  let html = "";

  // ✅ A/B팀 테이블
  ["A", "B"].forEach(teamKey => {
    const team = teamData[teamKey];
    const formation = teamKey === "A" ? formationA : formationB;
    const bgColor = teamKey === "A" ? "#fff9c4" : "#ffe0b2";

    html += `<h3 style="margin-top:2rem;">${teamKey}팀 (${formation})</h3>
    <table border="1" cellpadding="6" style="border-collapse: collapse; width:100%; max-width: 300px; text-align:center; background-color: ${bgColor};">
      <tr><th>이름</th><th>포지션</th></tr>
      ${team.map(p => `<tr><td>${getDisplayName(p.name)}</td><td>${p.position}</td></tr>`).join("")}
    </table>`;
  });

  // ✅ C팀 테이블
  if (Array.isArray(teamData.C) && teamData.C.length > 0) {
    html += `
    <div id="cTeamResultArea" style="margin-top:2rem;">
      <h3 style="text-align: center;">C팀 추첨 결과</h3>
      <table border="1" cellpadding="6" style="border-collapse: collapse; width:100%;  max-width: 300px; text-align:center; background-color: #bbdefb;">
        <tr><th>이름</th></tr>
        ${teamData.C.map(p => `<tr><td>${getDisplayName(p.name)}</td></tr>`).join("")}
      </table>
    </div>`;
  }

  resultDiv.innerHTML = html;
  document.getElementById("drawModalOverlay").style.display = "none";
}

function resetDraw() {
  // 선택 기록 초기화
  openedEnvelopes = [];
  confirmedSelections = {};
  confirmedIndexes = [];
  currentPlayerIndex = 0;

  // UI 초기화
  renderEnvelopes();
  updateLiveResultTable();  // 실시간 결과 테이블도 초기화
  document.getElementById("matchResult").innerHTML = ""; // 결과 테이블 제거
}


function closeSelectionModal() {
  document.getElementById("selectionModal").style.display = "none";
}
let voteOrder = [];           // 투표 순서 (ex. [이름, 이름, ...])


function showVotingInfo() {
  const player = voteOrder[currentPlayerIndex];
  const votes = playerVoteCount[currentPlayerIndex];

  document.getElementById("drawRankCell").textContent = `${currentPlayerIndex + 1}등`;
  document.getElementById("drawNameCell").textContent = player?.name || "-";
  document.getElementById("drawVoteCell").textContent = `${votes}장`;
}

function setupVotingOrder() {
  voteOrder = [...matchPlayers];  // 출석 순서로 복사
  const total = voteOrder.length;
  const half = Math.ceil(total / 2);

  playerVoteCount = voteOrder.map((player, idx) => {
    if (idx <= 1) return 3;          // 1등, 2등
    if (idx < half) return 2;        // 상위 절반
    return 1;                        // 나머지
  });

  currentPlayerIndex = 0;
}

function drawScoreChart(data) {
  const ctx = document.getElementById("scoreChart").getContext("2d");
  if (window.scoreChartInstance) {
    window.scoreChartInstance.destroy();
  }

  const labels = data.map(p => p.name);
  const scores = data.map(p => p.score);

  window.scoreChartInstance = new Chart(ctx, {
  type: 'bar',
  data: {
    labels: labels,
    datasets: [{
      label: '참여 점수',
      data: scores,
      backgroundColor: 'rgba(75, 192, 192, 0.6)',
      borderColor: 'rgba(75, 192, 192, 1)',
      borderWidth: 1
    }]
  },
  options: {
    indexAxis: 'y', // 가로 막대그래프
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: false },
      title: {
        display: true,
        text: '회원별 출석 참여 점수',
        font: { size: 14 }
      }
    },
    scales: {
      x: { beginAtZero: true, precision: 0 }
    }
  }
});

}

function toggleAttendanceHistory() {
  const area = document.getElementById("attendanceHistoryArea");
  if (area.style.display === "none") {
    renderAttendanceHistory(); // 테이블 생성
    area.style.display = "block";
  } else {
    area.style.display = "none";
  }
}

function renderAttendanceHistory() {
  const container = document.getElementById("attendanceHistoryArea");
  if (!window.attendanceHistoryData || Object.keys(attendanceHistoryData).length === 0) {
    container.innerHTML = "<p>저장된 출석 데이터가 없습니다.</p>";
    return;
  }

  const dates = Object.keys(attendanceHistoryData).sort();
  const sortedMembers = [...memberList].sort((a, b) => a.name.localeCompare(b.name, "ko"));

  let html = "<table border='1' cellpadding='6' style='border-collapse: collapse; min-width: 600px; text-align: center;'>";
  html += "<thead><tr><th>성명</th>";
  dates.forEach(date => {
    html += `<th>${date}</th>`;
  });
  html += "</tr></thead><tbody>";

  sortedMembers.forEach(member => {
    html += `<tr><td>${member.name}</td>`;
    dates.forEach(date => {
      const records = attendanceHistoryData[date];
      const entry = records.find(r => r.name === member.name);
      let status = "";
      if (entry) {
        status = (entry.late || entry.leave) ? "지각" : "참석";
      }
      html += `<td>${status}</td>`;
    });
    html += "</tr>";
  });

  html += "</tbody></table>";
  container.innerHTML = html;
}
function confirmResetDrawModal() {
  const proceed = confirm("모든 선택을 리셋합니다.\n포지션 뽑기를 다시 하고 싶다면 확인 버튼을 누르세요.");
  if (proceed) {
    // 상태 초기화
    currentPlayerIndex = 0;
    openedEnvelopes = [];
    confirmedSelections = {};
    confirmedIndexes = []; // ✅ 선택 완료된 쪽지 인덱스도 초기화

    // 쪽지 UI 초기화
    renderEnvelopes(); // ✅ 쪽지 모양 다시 초기 상태(✉️)로

    // 실시간 결과 테이블 초기화
    document.getElementById("liveResultTable").innerHTML = `
      <div>
        <h3 style="text-align: center;">A팀 추첨 결과</h3>
        <table id="liveA" border="1" cellpadding="8" style="background-color: #fff9c4; border-collapse: collapse; width: 45vw; min-width: 150px; max-width: 360px; text-align: center;">
          <thead><tr><th>이름</th><th>포지션</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="liveBWrapper" style="display:none;">
        <h3 style="text-align: center;">B팀 추첨 결과</h3>
        <table id="liveB" border="1" cellpadding="8" style="background-color: #ffe0b2; border-collapse: collapse; width: 45vw; min-width: 150px; max-width: 360px; text-align: center;">
          <thead><tr><th>이름</th><th>포지션</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="liveCWrapper" style="display:none;">
        <h3 style="text-align: center;">C팀 추첨 결과</h3>
        <table id="liveC" border="1" cellpadding="8" style="background-color: #bbdefb; border-collapse: collapse; width: 45vw; min-width: 150px; max-width: 360px; text-align: center;">
          <thead><tr><th>이름</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    `;

    // 현재 순서 UI 초기화
    document.getElementById("drawRankCell").textContent = "-";
    document.getElementById("drawNameCell").textContent = "-";
    document.getElementById("drawVoteCell").textContent = "-";

    // 모달 닫기
    document.getElementById("drawModalOverlay").style.display = "none";

    // 사용자 안내 메시지
    alert("초기화가 완료되었습니다. 다시 뽑기를 시작하려면 '포지션 뽑기' 버튼을 눌러주세요.");
  }
}





function updatePositionHeader() {
  const current = drawOrder[drawIndex];
  const rank = drawIndex + 1;
  const name = current.name;
  const votes = current.votes || 1; // 기본값 1장 (선택적으로 조정 가능)

  const headerText = `${rank}등 ${name} ${votes}장`;
  document.getElementById("positionHeader").textContent = headerText;
}

  </script>
<!-- XLSX 스크립트 추가 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
   window.addEventListener('DOMContentLoaded', () => {
    if (memberList.length > 0) {
  loadRankedAttendance();
}
  // ✅ 출석 이력 복원
  const savedData = localStorage.getItem("attendanceHistoryData");
  if (savedData) {
    try {
      window.attendanceHistoryData = JSON.parse(savedData);
      renderAttendanceHistory();
    } catch (e) {
      console.error("출석 기록 불러오기 오류:", e);
    }
  } else {
    window.attendanceHistoryData = {};
  }

  // ✅ memberList 복원
  const savedMembers = localStorage.getItem("memberList");
  if (savedMembers) {
    try {
      memberList = JSON.parse(savedMembers);
    } catch (e) {
      console.error("회원 명단 불러오기 오류:", e);
      memberList = [];
    }
  } else {
    memberList = [];
  }

// 이 아래에 추가하세요
["dfA", "mfA", "fwA"].forEach(id => {
    document.getElementById(id).addEventListener("input", () => updateRemainingPlayers("A"));
  });

  ["dfB", "mfB", "fwB"].forEach(id => {
    document.getElementById(id).addEventListener("input", () => updateRemainingPlayers("B"));
  });

  // 포메이션 추천 자동 연결
  document.getElementById("matchAStarter").addEventListener("input", () => suggestFormation("A"));
  document.getElementById("matchBStarter").addEventListener("input", () => suggestFormation("B"));
});


  </script>
  
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // 여기에 추가하세요 👇
    window.addEventListener("keydown", function (e) {
  if ((e.key === "F5") || (e.ctrlKey && e.key === "r")) {
    e.preventDefault();
    alert("새로고침이 차단되어 있습니다.");
  }
});

window.addEventListener("beforeunload", function (e) {
  e.preventDefault();
  e.returnValue = "";
});
function closeDrawModal() {
  document.getElementById("drawModalOverlay").style.display = "none";
}
function redoSelection() {
  if (!lastSelection) {
    alert("되돌릴 수 있는 선택이 없습니다.");
    return;
  }

  // 되돌릴 플레이어 정보
  const { playerName, selectedIndex, envelopeIndex, value } = lastSelection;

  // 확정 취소
  delete confirmedSelections[playerName];

  // 현재 플레이어 인덱스 되돌리기
  currentPlayerIndex--;

  // 쪽지 UI 복구
  const box = document.getElementById(`envelope-${envelopeIndex}`);
  if (box) {
    box.textContent = "✉️";
    box.style.pointerEvents = "auto";
    box.style.opacity = "1.0";
  }

  // 실시간 결과 갱신
  updateLiveResultTable();

  // 쪽지 재렌더링 (모달 닫지 않음)
  openedEnvelopes = [];
  renderEnvelopes();

  // 현재 뽑기 순서 정보 갱신
  showVotingInfo();
}

function confirmReset() {
  if (confirm("⚠️ 모든 선택을 리셋합니다.\n포지션 뽑기를 다시 하고 싶다면 '예' 버튼을 누르세요.")) {
    goBackFromDrawModal();
  }
}
function saveDrawResult() {
  const savedResults = { A: [], B: [], C: [] };

  Object.entries(confirmedSelections).forEach(([name, pos]) => {
    const team = pos.startsWith("A팀") ? "A"
              : pos.startsWith("B팀") ? "B"
              : pos.startsWith("C팀") ? "C" : null;

    if (team) {
      const position = pos.replace(/^A팀 |^B팀 |^C팀 /, "");
      savedResults[team].push({ name, position });
    }
  });

  localStorage.setItem("savedDrawResult", JSON.stringify(savedResults));
  alert("✅ 뽑기 결과가 저장되었습니다. 2~4경기에 자동으로 불러옵니다.");

  displayFinalTeamResults();  // 결과 표시
  closeSelectionModal();      // 모달 닫기 (이 시점에서 safe)
}



function loadSavedDrawResult() {
  const data = localStorage.getItem("savedDrawResult");
  if (!data) return;

  const parsed = JSON.parse(data);
  // 예: A팀을 2경기 테이블에 자동 배치
  populateMatchTable("match2A", parsed.A);
  populateMatchTable("match2B", parsed.B);
  populateMatchTable("match2C", parsed.C);
}

function populateMatchTable(tableId, players) {
  const tbody = document.getElementById(tableId)?.querySelector("tbody");
  if (!tbody) return;

  tbody.innerHTML = "";
  players.forEach(player => {
    const row = `<tr><td>${player.name}</td><td>${player.position}</td></tr>`;
    tbody.innerHTML += row;
  });
}
function debugAddRandomAttendance() {
  if (memberList.length === 0) {
    alert("먼저 회원 명단을 업로드해야 합니다.");
    return;
  }

  // ✅ 출석 테이블 없으면 먼저 생성
  if (!document.getElementById("selectedTable")) {
    loadRankedAttendance();
  }

  const candidates = [...memberList]
    .filter(m => !selectedNames.includes(`${m.name}__${m.team || ""}`));

  if (candidates.length < 27) {
    alert("남은 회원이 27명보다 적습니다.");
    return;
  }

  // 랜덤 27명 선택
  const shuffled = candidates.sort(() => Math.random() - 0.5).slice(0, 27);

  shuffled.forEach(m => {
    const key = `${m.name}__${m.team || ""}`;
    selectedNames.push(key);
  });

  updateSelectOptions(document.querySelectorAll(".name-select"));
  renderSelectedTable();
  updateSummary();

  alert("랜덤 27명이 출석 명단에 추가되었습니다.");
}



    </script>
<!-- 선택 모달 (수정 후 버전) -->
<div id="selectionModal" style="
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background-color: rgba(0,0,0,0.6);
  z-index:1001;
  justify-content: flex-start;  /* 중앙 → 상단 */
  align-items: flex-start;
  padding: 4rem 2rem;
  box-sizing: border-box;
  overflow-y: auto;
">
  <div style="background:white; padding:2rem; border-radius:10px; max-width:90%; text-align:center;">
    <h3>추첨 결과</h3>
    <div id="modalOptions" style="display:flex; gap:1rem; justify-content:center; flex-wrap:wrap; margin-top:1rem;"></div>
  </div>
</div>

<!-- 포지션 뽑기 모달 -->
<div id="drawModalOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
  background-color: rgba(0,0,0,0.6); z-index:1000; overflow:auto; justify-content: center; align-items: center;
">

<div style="
background: white;
width: 100%;
height: 100%;
padding: 2rem;
border-radius: 0;
overflow-y: auto;
display: flex;
flex-direction: column;
align-items: center;
gap: 1.5rem;
box-sizing: border-box;">


    <!-- 제목 -->
    <h2 style="font-size: 1.4em; font-weight: bold; margin-bottom: 0.4rem;">
      ✉️ 뽑기 순서
    </h2>
    

    <!-- 테이블 스타일 수정 -->
<table style="
font-size: 1.4rem;             /* 기존보다 살짝 키움 */
border-collapse: collapse;
border: 1px solid #ccc;
min-width: 300px;
text-align: center;            /* ✅ 가운데 정렬 */
margin-bottom: 0.3rem;         /* 제목과의 간격 조정 */
">
      <thead style="background-color: #f9f9f9;">
        <tr>
          <th style="padding: 0.4rem 0.8rem;">순위</th>
          <th style="padding: 0.4rem 0.8rem;">이름</th>
          <th style="padding: 0.4rem 0.8rem;">투표권</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td id="drawRankCell">-</td>
          <td id="drawNameCell">-</td>
          <td id="drawVoteCell">-</td>
        </tr>
      </tbody>
    </table>

    <!-- 쪽지 영역 -->
    <div id="envelopeArea" style="
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.3rem;
      margin-bottom: 1rem;
      max-width: 100%;
    "></div>

    <!-- 결과 테이블 -->
    <div id="liveResultTable" style="
      display: flex;
  flex-direction: row;
  flex-wrap: nowrap;
  overflow-x: auto;
  white-space: nowrap;
  gap: 0.8rem;
  width: 90%;
  justify-content: flex-start;
  align-items: flex-start;
">
      <!-- A/B팀 테이블이 여기에 삽입됨 -->
    </div>

    <!-- 버튼 영역 -->
    <div style="display: flex; justify-content: center; gap: 0.8rem; flex-wrap: wrap;">
      <button onclick="redoSelection()" style="padding: 0.6rem 1.2rem;">↩️ 다시 선택</button>
      <button onclick="confirmResetDrawModal()" style="padding: 0.6rem 1.2rem;">🔄 리셋</button>
      <button onclick="saveDrawResult()" style="padding: 0.6rem 1.2rem;">💾 저장</button>
    </div>
  </div>
</div>
</div>



</body>
</html>