<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì œìŠ¤íŠ¸ ì¶œì„ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
      font-family: 'GmarketSans', sans-serif;
      padding: 1.2rem;
      margin: 0;
      background-color: #f2f2f2;
    }

    .tab-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .tab-buttons button {
      white-space: nowrap;
      flex: 1;
      padding: 0.6rem 1rem;
      text-overflow: ellipsis;
      font-size: clamp(0.9rem, 1.8vw, 1.2rem);
      border: none;
      border-radius: 8px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      font-weight: bold;
      line-height: 1.2;  
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3); /* ê·¸ë¦¼ì ì„¤ì • */
    }

    .tab-buttons button:hover {
      background-color: #45a049;
    }
    .tab-buttons button.active {
  box-shadow: 0 0 0 3px #333 inset;  /* í…Œë‘ë¦¬ ê°•ì¡° íš¨ê³¼ */
  filter: brightness(1.2);           /* ë°ê¸° ê°•ì¡° */
  transform: scale(1.02);            /* ì‚´ì§ í™•ëŒ€ */
}
    .tab {
      display: none;
      padding: 1rem;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }

    .tab.active {
      display: block;
    }

    h2 {
      margin-top: 0;
    }

    /* ê° íƒ­ ë²„íŠ¼ì— ê³ ìœ í•œ ìƒ‰ìƒ ë¶€ì—¬ */
.tab-buttons button:nth-child(1) {
  background-color: #A3B18A; /* ì¶œì„ë¶€ */
}
.tab-buttons button:nth-child(2) {
  background-color: #6C91BF; /* ê²½ê¸° í¸ì„± */
}
.tab-buttons button:nth-child(3) {
  background-color: #D8A7A7; /* íšŒì› ê´€ë¦¬ */
}
.tab-buttons button:nth-child(4) {
  background-color: #E5C07B; /* ê²½ê¸° ì ìˆ˜ */
}
.tab-buttons button:nth-child(5) {
  background-color: #A67B5B; /* ì¶œì„ ê´€ë¦¬ */
}

  </style>
  <style>
    #selectedTable tr {
      height: 48px; /* ë˜ëŠ” 52px ë“± ì›í•˜ëŠ” ê°’ */
    }
  </style>
  <style>
    /* ì¶œì„ë¶€ íƒ­ ë‚´ select ìš”ì†Œ í°íŠ¸ì™€ íŒ¨ë”© í™•ëŒ€ */
    #attendanceTab select {
      font-size: 1.3rem;
      padding: 0.6rem 1rem;
    }
  
    /* ì¶œì„ë¶€ íƒ­ ë‚´ ë²„íŠ¼ë“¤ í°íŠ¸ ë° íŒ¨ë”© í™•ëŒ€ */
    #attendanceTab button {
      font-size: 1.3rem;
      padding: 0.8rem 1.2rem;
    }
  
    /* ì¶œì„ ìš”ì•½ ì˜ì—­ë„ ê°€ë…ì„± ê°œì„  */
    #attendanceSummary {
      font-size: 1.2rem;
      line-height: 1.8rem;
    }
  </style>
  <style>
    /* ê²½ê¸° í¸ì„± íƒ­ ë‚´ ì „ì²´ ê¸€ì í¬ê¸° í™•ëŒ€ */
    #matchTab {
      font-size: 1.3rem;
      line-height: 1.9rem;
    }
  
    /* ì…ë ¥ í•„ë“œì™€ ì…€ë ‰íŠ¸ ë°•ìŠ¤ í¬ê¸° ì¡°ì • */
    #matchTab input,
    #matchTab select {
      font-size: 1.3rem;
      padding: 0.6rem 1rem;
    }
  
    /* ë²„íŠ¼ í¬ê¸° í™•ëŒ€ */
    #matchTab button {
      font-size: 1.3rem;
      padding: 0.8rem 1.2rem;
    }
  
    /* ê²°ê³¼ ì¶œë ¥ ì˜ì—­ í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì • */
    #matchResult {
      font-size: 1.2rem;
      line-height: 1.8rem;
    }
    #suggestA, #suggestB {
  font-size: 1.56rem;  /* 120% í™•ëŒ€ */
  font-weight: bold;
}
.my-custom-style {
      background-color: #fdfbe8;
      border: 2px solid #bbb;
    }
    .name-select {
  transition: background-color 0.3s ease;
}

.name-select.flash {
  background-color: #e0ffe0;
}

#lateStatusTable {
  margin-top: 2rem;
  background: white;
  border-collapse: collapse;
  border: 1px solid #ddd;
}
#lateStatusTable th, #lateStatusTable td {
  padding: 8px;
  text-align: center;
  border: 1px solid #ddd;
}

  </style>
  <style>
    .envelope-box {
      width: 35px;
      height: 35px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      background-color: #fff;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      margin: 6px;
    }
    .envelope.selected {
  background-color: #ccc;
  color: #999;
  border: 2px solid #aaa;
  cursor: not-allowed;
}
    .envelope-box:hover {
      transform: scale(1.06);
      background-color: #f5f5f5;
    }

    #envelopeArea {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 4px;
  margin-top: 0.3rem;
}
#liveResultTable {
  display: flex;
  flex-wrap: wrap;               /* âœ… ìë™ ì¤„ë°”ê¿ˆ í—ˆìš© */
  justify-content: center;       /* ê°€ìš´ë° ì •ë ¬ */
  gap: 1rem;                   /* ê°„ê²© ìœ ì§€ */
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
  padding: 1rem;
}
#teamAddArea {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}
/* íŒ€êµ¬ë¶„ í…Œì´ë¸” ìŠ¤íƒ€ì¼ ê°œì„  */
#teamDivisionResult table {
  border-collapse: separate;
  border-spacing: 0;
  width: 100%;
  font-size: 1.2rem;
  margin-bottom: 1.5rem;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 0 5px rgba(0,0,0,0.15);
}
#teamDivisionResult th, #teamDivisionResult td {
  border: 1px solid #ccc;
  padding: 10px;
  text-align: center;
}
#teamDivisionResult th {
  background-color: #f0f0f0;
}
.team-a-color {
  background-color: #fff9c4;
}
.team-b-color {
  background-color: #ffe0b2;
}
.team-c-color {
  background-color: #bbdefb;
}

  </style>
  
</head>
<body>

  <!-- íƒ­ ë²„íŠ¼ -->
  <div class="tab-buttons">
    <button onclick="showTab('attendanceTab')">ì¶œì„ë¶€</button>
    <button onclick="showTab('teamTab')">íŒ€êµ¬ë¶„</button>
    <button onclick="showTab('matchTab')">ê²½ê¸°<br>í¸ì„±<br>1ê²½ê¸°</button>
    <button onclick="showTab('matchSetup2')">ê²½ê¸°<br>í¸ì„±<br>2-4ê²½ê¸°</button>
    <button onclick="showTab('memberTab')">íšŒì›<br>ê´€ë¦¬</button>
  </div>
  
  <!-- íƒ­ ì½˜í…ì¸  ì˜ì—­ -->
  <div id="attendanceTab" class="tab active">
    
    <!-- ì´í›„ ë‹¨ê³„ì—ì„œ ë‚´ìš© ì¶”ê°€ -->
     <!-- ë‚ ì§œ ì„ íƒ ì˜ì—­ -->
<!-- ì œëª© ì˜¤ë¥¸ìª½ì— ë‚ ì§œ ì„ íƒ UIë¥¼ ë°°ì¹˜ -->
<div style="display: flex; justify-content: space-between; align-items: center;">
    <h2 style="display: none;">ì¶œì„ë¶€</h2>
  
  <div style="display: flex; align-items: center; gap: 6px;">
    <select id="yearSelect" style="width: 100px;"></select>
    <select id="monthSelect" style="width: 85px;"></select>
    <select id="daySelect" style="width: 100px;"></select>
    <span id="weekdayDisplay" style="font-weight: bold;"></span>
  </div>
</div>

  <!-- ìˆœìœ„ë³„ ì„±ëª… ì„ íƒ ë° ì§€ê°/ì¡°í‡´ ì²´í¬ -->
<div style="margin-top: 1rem;">
  <!-- ì¶œì„ ëª…ë‹¨ ë§Œë“¤ê¸° ë²„íŠ¼ - ì‚´ì§ íŒŒë€ ê³„ì—´ë¡œ ë³€ê²½ -->
  <div style="display: flex; gap: 10px; margin-top: 1rem;">
    <button 
      onclick="loadRankedAttendance()" 
      style="background-color: #cce5ff; color: #003366; padding: 0.4rem 0.8rem; font-size: 1rem;">
      ì¶œì„ë¶€ ìƒì„±
    </button>
  
    <button 
      onclick="confirmAndClearAttendance()" 
      style="background-color: #ffe5e5; color: #663333; padding: 0.4rem 0.8rem; font-size: 1rem;">
      ì¶œì„ë¶€ ì‚­ì œ
    </button>
  </div>


  <!-- ğŸ§ª [ê°œë°œììš©] ëœë¤ ì¶œì„ ì¶”ê°€ ë²„íŠ¼ - ë‚˜ì¤‘ì— ì‚­ì œ -->
<div style="margin-top: 1rem;">
  <button onclick="debugAddRandomAttendance()" style="padding: 0.6rem 1.2rem; background-color: #eee;">
    ğŸ§ª ëœë¤ ì¶œì„ 27ëª… ì¶”ê°€
  </button>
</div>


  <div id="matchSetup2" class="tab">
    <h2>ê²½ê¸° í¸ì„± 2-4ê²½ê¸°</h2>
    <p>ì—¬ê¸°ì— 2~4ê²½ê¸° ê´€ë ¨ í¬ì§€ì…˜ ë½‘ê¸° ê¸°ë¡, ìë™ íŒ€ ì¬ë°°ì¹˜ ë“±ì˜ ê¸°ëŠ¥ì´ ë“¤ì–´ê°ˆ ìˆ˜ ìˆì–´ìš”.</p>
  </div>

  <div id="attendanceList" style="margin-top: 1rem;"></div>
  <div style="text-align: center; margin-top: 1rem;">
    <button onclick="saveAttendance()" style="padding: 0.7rem 1.3rem;">ì¶œì„ ì €ì¥</button>
  </div>
  
  <div id="attendanceSummary" style="margin-top: 1rem; background: #f3f3f3; padding: 1rem; border-radius: 8px;"></div>
</div>


  </div>
  <!-- ê²½ê¸° í¸ì„± 1ê²½ê¸° íƒ­ -->
<div id="matchTab" class="tab">
    <h2>ê²½ê¸° í¸ì„± 1ê²½ê¸°</h2>
  
    <!-- ì¶œì„ ë‚ ì§œ ì„ íƒ + ì¶œì„ ì¸ì› ì ìš© -->
    <div style="margin-bottom: 1rem; display: flex; align-items: center;">
        <button onclick="loadMatchPlayers()" style="padding: 0.8rem 1.2rem;">ì¶œì„ë¶€ ì ìš©í•˜ê¸°</button>
        <span style="margin-left: 2rem; font-weight: bold; font-size: 1.2rem;">
            ì°¸ê°€ì: <span id="matchTotal">0</span>ëª… /
        </span>
      </div>
  
    <!-- CíŒ€ ì¸ì› ì„¤ì • -->
    <div style="margin-bottom: 2rem;">
      CíŒ€ ì¸ì› ìˆ˜: <input type="number" id="matchCInput" value="0" min="0" oninput="updateMatchCounts()">
    </div>
  
    <!-- AíŒ€ êµ¬ì—­ -->
<div style="background-color: #fff9c4; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
    <div id="matchAInfo" style="font-weight: bold; font-size: 1.4rem;">AíŒ€ ì¶œì„ ì¸ì›:</div>
    <div style="margin-top: 0.7rem;">
      <label style="font-weight: bold;">AíŒ€ ì„ ë°œ ì¸ì›:</label>
      <div style="display: flex; align-items: center; gap: 10px;">
        <button onclick="adjustStarter('A', 1)">â–²</button>
        <input type="number" id="matchAStarter" value="11" min="1" style="width: 60px; text-align: center;" readonly>
        <button onclick="adjustStarter('A', -1)">â–¼</button>
      </div>
    </div>
    <div style="margin-top: 0.7rem;">
      <label><strong>í¬ë©”ì´ì…˜ ì¶”ì²œ:</strong> <span id="suggestA" style="font-size: 1rem;"></span></label><br>
      <label><strong>AíŒ€ í¬ë©”ì´ì…˜:</strong></label>
      <select id="formationASelect" onchange="toggleCustomFormation('A')">
        <option value="">-- ì¶”ì²œ ì„ íƒ --</option>
        <!-- ìë™ìœ¼ë¡œ ì¶”ì²œê°’ ì¶”ê°€ë¨ -->
      </select>
      <div id="formationACustom" style="display: none; margin-top: 0.5rem;">
        DF: <input type="number" id="dfA" value="0" min="0" style="width: 30px;" />
        MF: <input type="number" id="mfA" value="0" min="0" style="width: 30px;" />
        FW: <input type="number" id="fwA" value="0" min="0" style="width: 30px;" />
      </div>
      <div id="remainingA" style="margin-top: 0.5rem; font-weight: bold;"></div>

    </div>
  </div>
  
  
    <!-- BíŒ€ êµ¬ì—­ -->
<div style="background-color: #e0f7da; padding: 1rem; border-radius: 10px;">
    <div id="matchBInfo" style="font-weight: bold; font-size: 1.4rem;">BíŒ€ ì¶œì„ ì¸ì›:</div>
    <div style="margin-top: 0.7rem;">
      <label style="font-weight: bold;">BíŒ€ ì„ ë°œ ì¸ì›:</label>
      <div style="display: flex; align-items: center; gap: 10px;">
        <button onclick="adjustStarter('B', 1)">â–²</button>
        <input type="number" id="matchBStarter" value="11" min="1" style="width: 60px; text-align: center;" readonly>
        <button onclick="adjustStarter('B', -1)">â–¼</button>
      </div>
    </div>
    <div style="margin-top: 0.7rem;">
      <label><strong>í¬ë©”ì´ì…˜ ì¶”ì²œ:</strong> <span id="suggestB" style="font-size: 1rem;"></span></label><br>
      <label style="display: inline-block; margin-top: 1rem;"><strong>BíŒ€ í¬ë©”ì´ì…˜:</strong></label>
      <select id="formationBSelect" onchange="toggleCustomFormation('B')" style="margin-left: 10px;">
        <option value="">-- ì¶”ì²œ ì„ íƒ --</option>
      </select>
      <div id="formationBCustom" style="display: none; margin-top: 0.5rem;">
        DF: <input type="number" id="dfB" value="0" min="0" style="width: 30px;" />
        MF: <input type="number" id="mfB" value="0" min="0" style="width: 30px;" />
        FW: <input type="number" id="fwB" value="0" min="0" style="width: 30px;" />
      </div>
      <div id="remainingB" style="margin-top: 0.5rem; font-weight: bold;"></div>
    </div>
  </div>
    
    <!-- í¬ì§€ì…˜ ë½‘ê¸° -->
<div style="margin: 2rem 0; text-align: center;">
  <div style="margin: 2rem 0; text-align: center;">
  <button onclick="drawMatchPositions()" style="
    font-size: 1.5rem;
    padding: 1rem 2rem;
    border-radius: 50px;
    background-color: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.2);">
    âš½ í¬ì§€ì…˜ ë½‘ê¸°
  </button>
</div>
  
  </div>
  

    <!-- ê²°ê³¼ ì¶œë ¥ -->
    <div id="matchResult" style="margin-top: 1.5rem;"></div>
  </div>
  
  <div id="teamTab" class="tab">
    <h2>íŒ€êµ¬ë¶„ ê²°ê³¼</h2>
   <!-- â›³ ì¸ì› ì¶”ê°€ ë²„íŠ¼ -->
   <div style="margin-top: 1rem; text-align: center;">
    <button onclick="showTeamAddForm()" style="padding: 0.6rem 1.2rem; font-size: 1.1rem;">
      â• ì¸ì› ì¶”ê°€
    </button>
    <button onclick="showTeamChangeForm()" style="margin-left: 1rem; padding: 0.6rem 1.2rem; font-size: 1.1rem;">
      ğŸ”„ íŒ€ ë³€ê²½
    </button>
     <div id="teamChangeContainer" style="margin-top: 1rem;"></div>
    
  </div>

  <!-- â›³ ì¸ì› ì¶”ê°€ í¼ì´ ë‚˜íƒ€ë‚  ì˜ì—­ -->
  <div id="teamAddArea" style="margin-top: 1rem;"></div>

  <!-- â›³ ê²°ê³¼ ì¶œë ¥ í…Œì´ë¸” -->
  <div id="teamDivisionResult" style="margin-top: 1rem;"></div>
</div>


  <div id="memberTab" class="tab">
    <h2>íšŒì› ê´€ë¦¬</h2>
  
 <!-- íšŒì› ëª…ë‹¨ ì—…ë¡œë“œ -->
<div style="margin-bottom: 2.5rem; font-size: 1.5rem; line-height: 2.2rem;">
    <label style="font-weight: bold;">íšŒì› ëª…ë‹¨ ì—…ë¡œë“œ (ì—‘ì…€):</label><br>
  
    <!-- íŒŒì¼ ì„ íƒ ì˜ì—­ -->
    <div style="margin: 1rem 0;">
      <input type="file" id="excelFileInput" accept=".xlsx, .xls"
        style="font-size: 1.4rem; padding: 0.6rem 1rem; border-radius: 6px;"
        onchange="updateSelectedFileName(this)">
      <div id="fileNameDisplay" style="margin-top: 0.5rem; font-size: 1.5rem; color: #555;"></div>
    </div>
  
    <!-- ë²„íŠ¼ ê·¸ë£¹ -->
    <div style="display: flex; flex-wrap: wrap; gap: 1.2rem; margin-top: 1.5rem;">
      <button onclick="showTab('scoreTab')" style="flex: 1 1 45%; padding: 1.2rem; font-size: 1.3rem;">ê²½ê¸° ì ìˆ˜ ë³´ê¸°</button>
      <button onclick="toggleEditTeam()" style="flex: 1 1 45%; padding: 1.2rem; font-size: 1.3rem;">íšŒì› ì†Œì† ë³€ê²½</button>
      <button onclick="toggleIndividualDelete()" style="flex: 1 1 45%; padding: 1.2rem; font-size: 1.3rem;">íšŒì› ê°œë³„ ì‚­ì œ</button>
      <button onclick="deleteAllMembers()" style="flex: 1 1 45%; padding: 1.2rem; font-size: 1.3rem;">íšŒì› ëª…ë‹¨<br>ì „ì²´ ì‚­ì œ</button>
    </div>
  </div>
  
  <!-- íšŒì› ì§ì ‘ ì¶”ê°€ -->
<div style="margin-top: 3rem; margin-bottom: 2rem; font-size: 1.5rem;">
    <label style="font-weight: bold; display: block; margin-bottom: 1rem;">íšŒì› ì§ì ‘ ì¶”ê°€:</label>
  
    <input type="text" id="manualName" placeholder="ì„±ëª… ì…ë ¥"
      style="width: 160px; font-size: 1.3rem; padding: 0.6rem; margin-right: 1rem; margin-bottom: 1rem;" />
    
    <input type="text" id="manualTeam" placeholder="ì†Œì† ì…ë ¥"
      style="width: 200px; font-size: 1.3rem; padding: 0.6rem; margin-right: 1rem; margin-bottom: 1rem;" />
  
    <br>
    <button onclick="addManualMember()"
      style="padding: 0.7rem 1.4rem; font-size: 1.3rem;">íšŒì› ì§ì ‘ ì¶”ê°€</button>
  </div>
  
  
  
    <!-- íšŒì› ëª…ë‹¨ í‘œì‹œ -->
    <div id="memberListDisplay" style="margin-top:1rem;"></div>
  </div>
  

  </div>
 

<!-- ê²½ê¸° ì ìˆ˜ íƒ­ ì‹œì‘ -->
<!-- âœ… ê²½ê¸° ì ìˆ˜ íƒ­ ì „ì²´ êµ¬ì¡° -->
<div id="scoreTab" class="tab">
    <h2>ê²½ê¸° ì ìˆ˜</h2>
  
    <!-- ì‹œì¦Œ ì„¤ì • -->
    <div style="margin-bottom: 1rem; display: flex; align-items: center; flex-wrap: wrap; gap: 1.5rem;">
      <div style="flex: 1;">
        <label style="font-size: 1.3rem;">ì‹œì¦Œ ì‹œì‘ì¼:</label><br>
        <input type="date" id="seasonStart" value="2025-03-01" style="font-size: 1.3rem; padding: 0.5rem;">
        <br><br>
        <label style="font-size: 1.3rem;">ì‹œì¦Œ ë§ˆê°ì¼:</label><br>
        <input type="date" id="seasonEnd" value="2026-02-28" style="font-size: 1.3rem; padding: 0.5rem;">
      </div>
  
      <!-- í¬ìƒê¸ˆ ì„¤ì • ë²„íŠ¼ -->
      <div style="align-self: center;">
        <button onclick="openRewardSetting()" style="padding: 0.7rem 1.5rem; font-size: 1.1rem;">í¬ìƒê¸ˆ<br>ì„¤ì •</button>
      </div>
    </div>
  
    <!-- í¬ìƒê¸ˆ ì„¤ì • ì…ë ¥ ì˜ì—­ -->
    <div id="rewardSettingArea" style="display: none; margin-top: 1.5rem;"></div>
  
    <!-- ì¶œì„ ê´€ë¦¬ ë²„íŠ¼ + ì˜ì—­ -->
    <div style="margin-bottom: 1.5rem;">
      <button onclick="toggleAttendanceHistory()" style="padding: 0.8rem 1.2rem; font-size: 1.1rem;">ì¶œì„ ê´€ë¦¬</button>
    </div>
    <div id="attendanceHistoryArea" style="display: none; margin-top: 1.5rem; overflow: auto; max-height: 500px; max-width: 100%; border: 1px solid #ccc;"></div>
  
    <!-- TOP10 ìˆœìœ„ ë³´ê¸° -->
    <div style="margin-bottom: 1.5rem;">
      <button onclick="showTop10()" style="font-size: 1.3rem; padding: 1rem 1.5rem;">TOP10 ìˆœìœ„ ë³´ê¸°</button>
      <div id="top10Display" style="margin-top: 1rem; background: #fff8e1; padding: 1rem; border-radius: 8px;"></div>
    </div>
  
    <!-- ì „ì²´ íšŒì› ì ìˆ˜ í™•ì¸ -->
    <div style="margin-bottom: 2rem;">
      <button onclick="showAllScores()" style="font-size: 1.3rem; padding: 1rem 1.5rem;">ì „ì²´ íšŒì› ì ìˆ˜ í™•ì¸</button>
      <div id="allScoresArea" style="margin-top: 1rem;"></div>
      <canvas id="scoreChart" height="300" style="width:100%; max-height:400px;"></canvas>
    </div>
 
  
  <div style="margin-bottom: 1rem;">
    ì´ ì¸ì›: <span id="matchTotal">0</span>ëª… 
    AíŒ€: <span id="matchA">0</span>ëª… /
    BíŒ€: <span id="matchB">0</span>ëª… /
    CíŒ€: <span id="matchC">0</span>ëª…
  </div>
  <div id="scoreTab" class="tab" style="display: none;"></div>
</div>



  <!-- JS ì½”ë“œ -->
  <script>
    let lastSelection = null;
   function confirmAndClearAttendance() {
    if (confirm("ì •ë§ë¡œ ì¶œì„ë¶€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      clearCurrentAttendanceInputs(); // ì›ë˜ ìˆë˜ ì‚­ì œ í•¨ìˆ˜ ì‹¤í–‰
    }
  }

  function showTab(tabId) {
  const tabs = document.querySelectorAll(".tab");
  tabs.forEach(tab => {
    tab.classList.remove("active");
    tab.style.display = "none";
  });

  const selectedTab = document.getElementById(tabId);
  if (selectedTab) {
    selectedTab.classList.add("active");
    selectedTab.style.display = "block";
    console.log("âœ… íƒ­ ì „í™˜ë¨:", tabId);
  }

  // ğŸŸ¢ ë²„íŠ¼ ê°•ì¡° ë™ê¸°í™”
  const buttons = document.querySelectorAll(".tab-buttons button");
  buttons.forEach(btn => {
    const onclickValue = btn.getAttribute("onclick") || "";
    const matches = onclickValue.match(/showTab\('([^']+)'\)/);
    const targetId = matches?.[1];
    if (targetId === tabId) btn.classList.add("active");
    else btn.classList.remove("active");
  });
}




    // ë‚ ì§œ ì„ íƒ ì´ˆê¸°í™”
const yearSelect = document.getElementById("yearSelect");
const monthSelect = document.getElementById("monthSelect");
const daySelect = document.getElementById("daySelect");
const weekdayDisplay = document.getElementById("weekdayDisplay");

function setupDateListeners() {
  const yearSelect = document.getElementById("yearSelect");
  const monthSelect = document.getElementById("monthSelect");
  const daySelect = document.getElementById("daySelect");

  const handler = () => {
    updateWeekday();                 // ìš”ì¼ ê°±ì‹ 
    clearCurrentAttendanceInputs(); // ì…ë ¥ ì´ˆê¸°í™”
    updateSelectOptions(document.querySelectorAll('.name-select'));
  };

  yearSelect.addEventListener("change", handler);
  monthSelect.addEventListener("change", handler);
  daySelect.addEventListener("change", handler);
}
function adjustStarter(team, delta) {
  const input = document.getElementById(`match${team}Starter`);
  let value = parseInt(input.value || 0);
  value += delta;
  if (value < 1) value = 1;
  input.value = value;
  suggestFormation(team);
}
function toggleCustomFormation(team) {
  const select = document.getElementById(`formation${team}Select`);
  const customDiv = document.getElementById(`formation${team}Custom`);

  if (select.value === "custom") {
    customDiv.style.display = "block";
  } else {
    customDiv.style.display = "none";
  }
}
function updateRemainingSpots(team) {
  const starter = parseInt(document.getElementById(`match${team}Starter`).value || 0);
  const df = parseInt(document.getElementById(`df${team}`).value || 0);
  const mf = parseInt(document.getElementById(`mf${team}`).value || 0);
  const fw = parseInt(document.getElementById(`fw${team}`).value || 0);

  const used = 1 + df + mf + fw; // GK 1ëª… í¬í•¨
  const remaining = starter - used;

  const display = document.getElementById(`remaining${team}`);
  display.textContent = `ë‚¨ì€ ì¸ì›: ${remaining >= 0 ? remaining : 0}ëª…`;
}

function toggleCustomFormation(team) {
  const select = document.getElementById(`formation${team}Select`);
  const customDiv = document.getElementById(`formation${team}Custom`);

  if (select.value === "custom") {
    customDiv.style.display = "block";
    updateRemainingSpots(team); // âœ… í‘œì‹œ ì—…ë°ì´íŠ¸
  } else {
    customDiv.style.display = "none";
    document.getElementById(`remaining${team}`).textContent = "";
  }
}

function populateDateSelectors() {
  const now = new Date();

  const shortYears = [2025, 2026, 2027, 2028];
  yearSelect.innerHTML = "";
  shortYears.forEach(y => {
    const option = document.createElement("option");
    option.value = y;
    option.textContent = `${String(y).slice(2)}ë…„`; // 25ë…„, 26ë…„ ë“±
    yearSelect.appendChild(option);
  });

  // ì›” ì´ˆê¸°í™”
  monthSelect.innerHTML = "";
  for (let m = 1; m <= 12; m++) {
    const option = document.createElement("option");
    option.value = m;
    option.textContent = `${m}ì›”`;
    monthSelect.appendChild(option);
  }

  // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ë³¸ê°’ ì„¤ì •
  yearSelect.value = now.getFullYear();
  monthSelect.value = now.getMonth() + 1;

  // ì¼ ì´ˆê¸°í™” (ìš”ì¼ ìƒ‰ìƒ í¬í•¨)
  const selectedYear = parseInt(yearSelect.value);
  const selectedMonth = parseInt(monthSelect.value);
  const lastDay = new Date(selectedYear, selectedMonth, 0).getDate();

  daySelect.innerHTML = "";
  for (let d = 1; d <= lastDay; d++) {
    const date = new Date(selectedYear, selectedMonth - 1, d);
    const weekday = date.getDay();
    let color = "black";
    if (weekday === 0) color = "red";
    else if (weekday === 6) color = "blue";

    const option = document.createElement("option");
    option.value = d;
    option.textContent = `${d}ì¼`;
    option.style.color = color;  // âœ… í•µì‹¬!
    daySelect.appendChild(option);
  }

  daySelect.value = now.getDate();
  updateWeekday();
}
function updateRemainingPlayers(team) {
  const starterInput = document.getElementById(`match${team}Starter`);
  const df = parseInt(document.getElementById(`df${team}`).value) || 0;
  const mf = parseInt(document.getElementById(`mf${team}`).value) || 0;
  const fw = parseInt(document.getElementById(`fw${team}`).value) || 0;

  const starter = parseInt(starterInput.value) || 0;
  const used = 1 + df + mf + fw;
  const remaining = starter - used;

  const target = document.getElementById(`remaining${team}`);
  target.textContent = `ë‚¨ì€ ì¸ì›: ${remaining}ëª…`;
}


function loadRankedAttendance() {
  const container = document.getElementById("attendanceList");
  container.innerHTML = "";

  if (memberList.length === 0) {
    alert("ë¨¼ì € íšŒì› ëª…ë‹¨ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.");
    return;
  }

  if (document.getElementById("selectedTable")) return;

  const wrapper = document.createElement("div");
  wrapper.style.display = "flex";
  wrapper.style.alignItems = "center";
  wrapper.style.gap = "30px";
  wrapper.style.flexWrap = "wrap";

  const select = document.createElement("select");
  select.id = "singleNameSelect";
  select.classList.add("name-select", "my-custom-style");
  select.style.fontSize = "1.3rem";
  select.style.marginBottom = "1rem";

  const defaultOption = document.createElement("option");
  defaultOption.value = "";
  defaultOption.textContent = "-- ì„±ëª… ì„ íƒ --";
  select.appendChild(defaultOption);

  const sortedList = [...memberList].sort((a, b) => a.name.localeCompare(b.name, "ko"));
  sortedList.forEach(member => {
    const key = `${member.name}__${member.team || ""}`;
    if (selectedNames.includes(key)) return;

    const isDuplicate = memberList.filter(m => m.name === member.name).length > 1;

    const option = document.createElement("option");
    option.value = key;
    option.textContent = isDuplicate && member.team
      ? `${member.name}(${member.team})`
      : member.name;

    select.appendChild(option);
  });

  const nonMemberOption = document.createElement("option");
  nonMemberOption.value = "__ë¹„íšŒì›__";
  nonMemberOption.textContent = "â• ë¹„íšŒì› ì¶”ê°€";
  select.appendChild(nonMemberOption);

  select.addEventListener("change", () => {
    const fullKey = select.value;

    if (fullKey === "__ë¹„íšŒì›__") {
      showNonMemberInput(select);
      return;
    }

    if (!fullKey || selectedNames.includes(fullKey)) return;

    if (selectedNames.length >= 35) {
      alert("ìµœëŒ€ 35ëª…ê¹Œì§€ë§Œ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      return;
    }

    selectedNames.push(fullKey);
    updateSelectOptions(document.querySelectorAll('.name-select'));
    renderSelectedTable();
    updateSummary();

    localStorage.setItem("tempSelectedNames", JSON.stringify(selectedNames));
    localStorage.setItem("tempLateStatus", JSON.stringify(lateStatus));

    setTimeout(() => {
      select.selectedIndex = 0;
      updateSelectOptions(document.querySelectorAll(".name-select"));
    }, 500);

    // âœ… ìƒˆ ì¤„ë¡œ ìë™ ìŠ¤í¬ë¡¤ ì´ë™
    setTimeout(() => {
      const lastRow = document.querySelector("#selectedTable tbody")?.lastElementChild;
      if (lastRow) {
        lastRow.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }
    }, 100);
  });

  const insertBtn = document.createElement("button");
  insertBtn.id = "middleInsertButton";
  insertBtn.textContent = "ì¤‘ê°„ ì‚½ì…";
  insertBtn.style.fontSize = "1rem";
  insertBtn.style.padding = "0.5rem 0.7rem";
  insertBtn.style.height = "38px";
  insertBtn.style.lineHeight = "1";
  insertBtn.style.boxSizing = "border-box";
  insertBtn.onclick = () => showMiddleInsertForm();

  wrapper.appendChild(select);
  wrapper.appendChild(insertBtn);
  container.appendChild(wrapper);

  // âœ… í…Œì´ë¸” ë˜í¼ (ìŠ¤í¬ë¡¤ + thead ê³ ì •)
  const tableWrapper = document.createElement("div");
  tableWrapper.id = "selectedTableWrapper";
  tableWrapper.style.maxHeight = "300px";
  tableWrapper.style.overflowY = "auto";
  tableWrapper.style.border = "1px solid #ccc";
  tableWrapper.style.borderRadius = "8px";
  tableWrapper.style.marginTop = "1rem";
  tableWrapper.style.backgroundColor = "#fff";

  const table = document.createElement("table");
table.id = "selectedTable";
table.style.borderCollapse = "collapse";
table.style.width = "100%";
table.innerHTML = `
  <thead style="position: sticky; top: 0; background-color: #f9f9f9; z-index: 1;">
    <tr>
      <th>ìˆœìœ„</th>
      <th>ì„±ëª…</th>
      <th>ì§€ê°</th>
      <th>ë³€ê²½</th>
    </tr>
  </thead>
  <tbody id="selectedTableBody"></tbody>
`;

  tableWrapper.appendChild(table);
  container.appendChild(tableWrapper);

  renderSelectedTable();
  updateSelectOptions(document.querySelectorAll(".name-select"));
  localStorage.setItem("tempSelectedNames", JSON.stringify(selectedNames));
  localStorage.setItem("tempLateStatus", JSON.stringify(lateStatus));
}


function showNonMemberInput(select) {
  // ì´ë¯¸ ì…ë ¥ì°½ì´ ìˆìœ¼ë©´ ì œê±°
  const existing = document.getElementById("nonMemberInputBox");
  if (existing) existing.remove();

  const box = document.createElement("div");
  box.id = "nonMemberInputBox";
  box.style.marginTop = "1rem";
  box.style.display = "flex";
  box.style.gap = "10px";
  box.style.alignItems = "center";

  const input = document.createElement("input");
  input.placeholder = "ë¹„íšŒì› ì„±ëª… ì…ë ¥";
  input.style.fontSize = "1.1rem";
  input.style.padding = "0.4rem";
  input.style.width = "160px";

  const saveBtn = document.createElement("button");
  saveBtn.textContent = "ì €ì¥";
  saveBtn.onclick = () => {
    const name = input.value.trim();
    if (!name) {
      alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }
    if (selectedNames.includes(name)) {
      alert("ì´ë¯¸ ë“±ë¡ëœ ì´ë¦„ì…ë‹ˆë‹¤.");
      return;
    }
    selectedNames.push(name);
    renderSelectedTable();
    updateSummary();
    select.value = "";
    box.remove();
  };

  const cancelBtn = document.createElement("button");
  cancelBtn.textContent = "ì·¨ì†Œ";
  cancelBtn.onclick = () => {
    select.value = "";
    box.remove();
  };

  box.appendChild(input);
  box.appendChild(saveBtn);
  box.appendChild(cancelBtn);

  // select ë°”ë¡œ ì•„ë˜ì— ì‚½ì…
  select.parentNode.insertBefore(box, select.nextSibling);
}

function showMiddleInsertForm() {
  const container = document.getElementById("attendanceList");
  const existing = document.getElementById("middleInsertBox");
  if (existing) existing.remove();

  const box = document.createElement("div");
  box.id = "middleInsertBox";
  box.style.marginTop = "1rem";
  box.style.padding = "1rem";
  box.style.backgroundColor = "#f9f9f9";
  box.style.border = "1px solid #ccc";
  box.style.borderRadius = "8px";
  box.style.display = "flex";
  box.style.gap = "10px";
  box.style.alignItems = "center";
  box.style.flexWrap = "wrap";

  // âœ… ì„±ëª… ì„ íƒ ë“œë¡­ë‹¤ìš´
  const nameSelect = document.createElement("select");
  nameSelect.id = "middleInsertName";
  nameSelect.style.fontSize = "1.1rem";
  
  nameSelect.innerHTML = '<option value="">-- ì„±ëª… ì„ íƒ --</option>';

  const sortedList = [...memberList].sort((a, b) => a.name.localeCompare(b.name, "ko"));
  sortedList.forEach(member => {
  const key = `${member.name}__${member.team || ""}`;
  if (selectedNames.includes(key)) return;

  const option = document.createElement("option");
  const isDuplicate = memberList.filter(m => m.name === member.name).length > 1;
  option.value = key;
  option.textContent = isDuplicate && member.team
    ? `${member.name}(${member.team})`
    : member.name;

  nameSelect.appendChild(option);
});

// âœ… ë¹„íšŒì› í•­ëª© ì¶”ê°€
const nonMemberOption = document.createElement("option");
nonMemberOption.value = "__ë¹„íšŒì›__";
nonMemberOption.textContent = "â• ë¹„íšŒì› ì¶”ê°€";
nameSelect.appendChild(nonMemberOption);


  // âœ… ì¶œì„ ìˆœìœ„ ì„ íƒ ë“œë¡­ë‹¤ìš´
  const rankSelect = document.createElement("select");
  rankSelect.id = "middleInsertRank";
  rankSelect.style.fontSize = "1.1rem";
  rankSelect.style.padding = "0.4rem 0.6rem";

  for (let i = 1; i <= 30; i++) {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = `${i}ë“±`;
    rankSelect.appendChild(option);
  }

  // âœ… ì €ì¥ ë²„íŠ¼
  const saveBtn = document.createElement("button");
  saveBtn.textContent = "ì €ì¥";
  saveBtn.style.fontSize = "1.1rem";
  saveBtn.onclick = () => {
    const fullKey = nameSelect.value;
    const insertIndex = parseInt(rankSelect.value) - 1;

    // ì¤‘ë³µ ì¶”ê°€ ë°©ì§€
    if (selectedNames.includes(fullKey)) {
      alert("ì´ë¯¸ ì„ íƒëœ ì´ë¦„ì…ë‹ˆë‹¤.");
      return;
    }

    if (!fullKey || isNaN(insertIndex) || insertIndex < 0 || insertIndex > selectedNames.length) {
      alert("ì…ë ¥ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      return;
    }

    selectedNames.splice(insertIndex, 0, fullKey);
    renderSelectedTable();
    updateSummary();
    updateSelectOptions(document.querySelectorAll(".name-select"));
    box.remove(); // ì„±ê³µ í›„ ì°½ ë‹«ê¸°
  };

  // âœ… ë‹«ê¸° ë²„íŠ¼
  const closeBtn = document.createElement("button");
  closeBtn.textContent = "ë‹«ê¸°";
  closeBtn.style.fontSize = "1.1rem";
  closeBtn.onclick = () => {
    box.remove(); // ì…ë ¥ì°½ ì œê±°
  };

  // âœ… êµ¬ì„± ìš”ì†Œ ì¶”ê°€
  box.appendChild(nameSelect);
  box.appendChild(rankSelect);
  box.appendChild(saveBtn);
  box.appendChild(closeBtn);
  
  const insertBtn = document.getElementById("middleInsertButton");
if (insertBtn) {
  insertBtn.insertAdjacentElement("afterend", box);  // ë²„íŠ¼ ë°”ë¡œ ì•„ë˜
} else {
  container.appendChild(box); // fallback
}
}


function renderSelectedTable() {
   
  const table = document.getElementById("selectedTable");
if (!table) {
  console.error("âŒ selectedTable í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
  return;
}

let tbody = table.querySelector("tbody");
if (!tbody) {
  tbody = document.createElement("tbody");
  table.appendChild(tbody);
}
tbody.innerHTML = "";  // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
  
  
  selectedNames.forEach((fullKey, idx) => {
    const row = document.createElement("tr");
    row.style.fontSize = "1.3rem";
    row.style.border = "1px solid #ddd";

    const rankTd = document.createElement("td");
    rankTd.textContent = `${idx + 1}`;
    rankTd.style.textAlign = "center";

    const nameTd = document.createElement("td");
    nameTd.style.textAlign = "center";
    const [name, team] = fullKey.split("__");
    const isDuplicate = memberList.filter(m => m.name === name).length > 1;
    const displayName = isDuplicate && team ? `${name}(${team})` : name;
    const nameSpan = document.createElement("span");
    nameSpan.textContent = displayName;
    nameTd.appendChild(nameSpan);

    const lateTd = document.createElement("td");
    lateTd.style.textAlign = "center";
    const lateCheck = document.createElement("input");
    lateCheck.type = "checkbox";
    lateCheck.checked = lateStatus[fullKey] || false;
    lateCheck.style.transform = "scale(1.3)";
    lateCheck.style.marginLeft = "8px";
    lateCheck.onchange = () => {
      lateStatus[fullKey] = lateCheck.checked;
      updateLateStatusTable();
      renderNameDropdown();
      updateSelectOptions(document.querySelectorAll(".name-select"));
    };
    lateTd.appendChild(lateCheck);

    const controlTd = document.createElement("td");
    controlTd.style.textAlign = "center";

    const upBtn = document.createElement("button");
    upBtn.textContent = "â–²";
    upBtn.style.marginRight = "2px";
    upBtn.style.fontSize = "0.8rem";
    upBtn.style.padding = "1px 5px";
    upBtn.style.marginLeft = "6px";
    upBtn.onclick = () => {
      if (idx === 0) return;
      [selectedNames[idx - 1], selectedNames[idx]] = [selectedNames[idx], selectedNames[idx - 1]];
      renderSelectedTable();
      updateSummary();
    };

    const downBtn = document.createElement("button");
    downBtn.textContent = "â–¼";
    downBtn.style.marginRight = "8px";
    downBtn.style.fontSize = "0.8rem";
    downBtn.style.padding = "1px 5px";
    downBtn.onclick = () => {
      if (idx === selectedNames.length - 1) return;
      [selectedNames[idx + 1], selectedNames[idx]] = [selectedNames[idx], selectedNames[idx + 1]];
      renderSelectedTable();
      updateSummary();
    };

    const delBtn = document.createElement("button");
    delBtn.textContent = "ì‚­ì œ";
    delBtn.style.fontSize = "0.8rem";
    delBtn.style.lineHeight = "1";
    delBtn.style.padding = "0.2rem 0.5rem";
    delBtn.style.marginLeft = "0px";
    delBtn.onclick = () => {
  selectedNames.splice(idx, 1);
  renderSelectedTable();
  updateSummary();
  updateLateStatusTable(); // â† ì‚­ì œ í›„ ìƒíƒœ í…Œì´ë¸”ë„ ë°˜ì˜
};


    controlTd.appendChild(upBtn);
    controlTd.appendChild(downBtn);
    controlTd.appendChild(delBtn);

    row.appendChild(rankTd);
    row.appendChild(nameTd);
    row.appendChild(lateTd);
    row.appendChild(controlTd);
    tbody.appendChild(row);
  });

  const wrapper = document.getElementById("attendanceTableWrapper");
  if (wrapper) {
    wrapper.scrollTop = wrapper.scrollHeight;
  }

  updateLateStatusTable(); // ë§ˆì§€ë§‰ì— ê°±ì‹ 
}



function updateLateStatusTable() {
  const existingStatus = document.getElementById("lateStatusTable");
  if (existingStatus) existingStatus.remove();

  const statusTable = document.createElement("table");
  statusTable.id = "lateStatusTable";
  statusTable.style.marginTop = "1.5rem";
  statusTable.style.borderCollapse = "collapse";
  statusTable.style.width = "100%";

  statusTable.innerHTML = `
    <thead>
      <tr style="background:#f0f0f0;">
        <th style="padding: 6px;">ìˆœìœ„</th>
        <th style="padding: 6px;">ì„±ëª…</th>
        <th style="padding: 6px;">ìƒíƒœ</th>
      </tr>
    </thead>
    <tbody>
      ${selectedNames.map((fullKey, idx) => {
        const [name, team] = fullKey.split("__");
        const isDuplicate = memberList.filter(m => m.name === name).length > 1;
        const displayName = isDuplicate && team ? `${name}(${team})` : name;
        const isLate = lateStatus[fullKey] || false;
        const status = isLate
          ? `<span style="color:red; font-weight:bold;">ì§€ê°</span>`
          : "ì •ìƒ";

        return `
          <tr>
            <td style="text-align:center;">${idx + 1}</td>
            <td style="text-align:center;">${displayName}</td>
            <td style="text-align:center;">${status}</td>
          </tr>
        `;
      }).join("")}
    </tbody>
  `;
  const parent = document.getElementById("attendanceList");
if (parent) {
  parent.appendChild(statusTable);
}
}


function renderNameDropdown() {
  const select = document.getElementById("singleNameSelect");
  if (!select) return;

  select.innerHTML = "";

  // ê¸°ë³¸ ì•ˆë‚´ ì˜µì…˜
  const defaultOption = document.createElement("option");
  defaultOption.value = "";
  defaultOption.textContent = "-- ì„±ëª… ì„ íƒ --";
  select.appendChild(defaultOption);

  // ì •ë ¬ëœ ëª…ë‹¨ ê¸°ì¤€ ë“œë¡­ë‹¤ìš´ êµ¬ì„±
  const sortedList = [...memberList].sort((a, b) => a.name.localeCompare(b.name, "ko"));
  sortedList.forEach(member => {
    const fullKey = `${member.name}__${member.team || ""}`;

    if (selectedNames.includes(fullKey)) return; // ì´ë¯¸ ì„ íƒëœ ì‚¬ëŒì€ ì œì™¸

    const isDuplicate = memberList.filter(m => m.name === member.name).length > 1;

    const option = document.createElement("option");
    option.value = fullKey;
    option.textContent = isDuplicate && member.team
      ? `${member.name}(${member.team})`
      : member.name;

    select.appendChild(option);
  });

  // âœ… ë¹„íšŒì› ì¶”ê°€ ì˜µì…˜ì€ í•œ ë²ˆë§Œ!
  const nonMemberOption = document.createElement("option");
  nonMemberOption.value = "__ë¹„íšŒì›__";
  nonMemberOption.textContent = "â• ë¹„íšŒì› ì¶”ê°€";
  select.appendChild(nonMemberOption);

  select.value = "";
}


let matchPlayers = []; // 1ê²½ê¸° ì°¸ê°€ì ì €ì¥ìš©

function loadMatchPlayers() {
    if (!window.attendanceHistoryData || Object.keys(attendanceHistoryData).length === 0) {
    alert("ì¶œì„ ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // ê°€ì¥ ìµœê·¼ ë‚ ì§œë¥¼ ì°¾ìŒ (ì •ë ¬ëœ ë§ˆì§€ë§‰ ê°’)
  const latestDate = Object.keys(attendanceHistoryData).sort().pop();
  const latestData = attendanceHistoryData[latestDate];

  matchPlayers = [...latestData];

  const total = matchPlayers.length;
  const cNum = parseInt(document.getElementById("matchCInput").value || 0);
  const rest = Math.max(0, total - cNum);
  const aNum = Math.ceil(rest / 2);
  const bNum = Math.floor(rest / 2);

  document.getElementById("matchAStarter").value = aNum;
  document.getElementById("matchBStarter").value = bNum;

  updateMatchCounts();

  // âœ… í¬ë©”ì´ì…˜ ì¶”ì²œ ì¦‰ì‹œ í‘œì‹œ
  suggestFormation("A");
  suggestFormation("B");

  console.log(`ìµœê·¼ ì¶œì„ ë‚ ì§œ: ${latestDate}`);
}

function updateMatchCounts() {
  const total = matchPlayers.length;
  const cNum = parseInt(document.getElementById("matchCInput").value || 0);
  const rest = Math.max(0, total - cNum);
  const aNum = Math.ceil(rest / 2);
  const bNum = Math.floor(rest / 2);

  document.getElementById("matchTotal").textContent = total;
  document.getElementById("matchA").textContent = aNum;
  document.getElementById("matchB").textContent = bNum;
  document.getElementById("matchC").textContent = cNum;

  document.getElementById("matchAInfo").textContent = `AíŒ€ ì¶œì„ ì¸ì›: ${aNum}ëª…`;
  document.getElementById("matchBInfo").textContent = `BíŒ€ ì¶œì„ ì¸ì›: ${bNum}ëª…`;
}

function suggestFormation(team) {
  const starter = parseInt(document.getElementById(`match${team}Starter`).value || 0);
  const target = document.getElementById(`suggest${team}`);
  const select = document.getElementById(`formation${team}Select`);
  const list = {
    12: ["4-5-2", "4-4-3", "3-4-4"],
    11: ["4-3-3", "4-4-2", "3-5-2", "3-4-3"], 
    10: ["4-4-1", "3-4-2", "3-5-1", "4-3-2"],
    9: ["3-4-1", "4-3-1", "3-3-2"],
    8: ["3-3-1", "2-4-1", "4-2-1"],
    7: ["3-3-0", "2-3-1", "3-2-1"],
    6: ["2-2-1", "1-2-2", "2-3-0"],
    5: ["1-2-1", "2-2-0", "1-1-2"],
    4: ["1-1-1", "1-2-0"]
  };
  const recommended = list[starter] || [];

  // ì¶”ì²œ í¬ë©”ì´ì…˜ í…ìŠ¤íŠ¸ ì¶œë ¥ (êµµê²Œ + í™•ëŒ€)
  target.textContent = recommended.join(", ");

  // ì…€ë ‰íŠ¸ ë°•ìŠ¤ ì˜µì…˜ ì´ˆê¸°í™”
  select.innerHTML = '<option value="">-- ì¶”ì²œ ì„ íƒ --</option>';

  // ì¶”ì²œ í¬ë©”ì´ì…˜ì„ ì˜µì…˜ìœ¼ë¡œ ì¶”ê°€
  recommended.forEach((form, i) => {
    const option = document.createElement("option");
    option.value = form;
    option.textContent = form;
    if (i === 0) option.selected = true;
    select.appendChild(option);
  });

  // 'ì§ì ‘ ì…ë ¥' ì˜µì…˜ ì¶”ê°€
  const customOption = document.createElement("option");
  customOption.value = "custom";
  customOption.textContent = "ì§ì ‘ ì…ë ¥";
  select.appendChild(customOption);
}
let formationA = null;
let formationB = null;

function prepareMatchPlayers() {
  // savedAttendanceDataë¥¼ matchPlayersë¡œ ë³€í™˜
  if (!Array.isArray(savedAttendanceData) || savedAttendanceData.length === 0) {
    alert("ì¶œì„ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤. ì¶œì„ë¶€ë¥¼ ë¨¼ì € ì ìš©í•´ì£¼ì„¸ìš”.");
    return false;
  }

  window.matchPlayers = savedAttendanceData.filter(p => !p.leave && !p.late); 
  return true;
}


function drawMatchPositions() {
  console.log("ğŸ¯ drawMatchPositions í˜¸ì¶œë¨");
  console.log("âœ… matchPlayers:", matchPlayers);

  if (!matchPlayers || matchPlayers.length === 0) {
    alert("ì¶œì„ë¶€ë¥¼ ë¨¼ì € ì ìš©í•´ì£¼ì„¸ìš”.");
    return;
  }

  const formationASelect = document.getElementById("formationASelect").value;
  const formationBSelect = document.getElementById("formationBSelect").value;
  if (!formationASelect || !formationBSelect) {
    alert("í¬ë©”ì´ì…˜ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  currentPlayerIndex = 0;
  openedEnvelopes = [];
  confirmedSelections = {};

  let formationA, formationB;
  if (formationASelect === "custom") {
    const df = parseInt(document.getElementById("dfA").value || 0);
    const mf = parseInt(document.getElementById("mfA").value || 0);
    const fw = parseInt(document.getElementById("fwA").value || 0);
    const starter = parseInt(document.getElementById("matchAStarter").value || 0);
    const total = 1 + df + mf + fw;
    if (total > starter) {
      alert(`âš ï¸ AíŒ€ í¬ì§€ì…˜ ìˆ˜(${total})ê°€ ì„ ë°œ ì¸ì›(${starter})ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.`);
      return;
    }
    formationA = `${df}-${mf}-${fw}`;
  } else {
    formationA = formationASelect;
  }

  if (formationBSelect === "custom") {
    const df = parseInt(document.getElementById("dfB").value || 0);
    const mf = parseInt(document.getElementById("mfB").value || 0);
    const fw = parseInt(document.getElementById("fwB").value || 0);
    const starter = parseInt(document.getElementById("matchBStarter").value || 0);
    const total = 1 + df + mf + fw;
if (starter === 0 && total > 0) {
  alert(`âš ï¸ BíŒ€ì„ ë½‘ì§€ ì•Šìœ¼ë ¤ë©´ í¬ì§€ì…˜ë„ ëª¨ë‘ 0ì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);
  return;
}
if (total > starter) {
  alert(`âš ï¸ BíŒ€ í¬ì§€ì…˜ ìˆ˜(${total})ê°€ ì„ ë°œ ì¸ì›(${starter})ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.`);
  return;
}
    formationB = `${df}-${mf}-${fw}`;
  } else {
    formationB = formationBSelect;
  }

  const [dfA, mfA, fwA] = formationA.split("-").map(Number);
  const [dfB, mfB, fwB] = formationB.split("-").map(Number);
  const aCount = 1 + dfA + mfA + fwA;
  const bCount = 1 + dfB + mfB + fwB;

  const players = [...matchPlayers];
  const total = players.length;
  const teamA = players.slice(0, aCount);
  const teamB = players.slice(aCount, aCount + bCount);

  // â›³ CíŒ€ ì¸ì›ì€ ì…ë ¥ëœ ê°’ ê¸°ë°˜ìœ¼ë¡œ ê³ ì •
  let cCount = parseInt(document.getElementById("matchCInput").value || 0);
let teamC = [];

if (cCount > 0) {
  teamC = players.slice(aCount + bCount, aCount + bCount + cCount);
} else {
  // ì¸ì› ë‚¨ì•˜ì„ ê²½ìš°, ë‚¨ëŠ” ì¸ì› A/BíŒ€ì— í¬í•¨ë˜ë„ë¡ ìˆ˜ì •
  const restPlayers = players.slice(aCount + bCount);
  const half = Math.ceil(restPlayers.length / 2);
  teamA.push(...restPlayers.slice(0, half));
  teamB.push(...restPlayers.slice(half));
}

  window.matchTeamAssignments = {
    formationA,
    formationB,
    teamA,
    teamB,
    teamC
  };

  const notes = [];

  // AíŒ€ ìª½ì§€
  if (teamA.length > 0) {
    const totalPositions = 1 + dfA + mfA + fwA;
    notes.push("AíŒ€ GK", ...Array(dfA).fill("AíŒ€ DF"), ...Array(mfA).fill("AíŒ€ MF"), ...Array(fwA).fill("AíŒ€ FW"));
    const extra = teamA.length - totalPositions;
    if (extra > 0) notes.push(...Array(extra).fill("AíŒ€ íœ´ì‹"));
  }

  // BíŒ€ ìª½ì§€
  if (teamB.length > 0) {
    const totalPositions = 1 + dfB + mfB + fwB;
    notes.push("BíŒ€ GK", ...Array(dfB).fill("BíŒ€ DF"), ...Array(mfB).fill("BíŒ€ MF"), ...Array(fwB).fill("BíŒ€ FW"));
    const extra = teamB.length - totalPositions;
    if (extra > 0) notes.push(...Array(extra).fill("BíŒ€ íœ´ì‹"));
  }

 // CíŒ€ ìª½ì§€ (ì¸ì› ìˆ˜ ê¸°ì¤€ ìƒì„±)
if (teamC.length > 0) {
  notes.push(...Array(teamC.length).fill("CíŒ€"));
}


  // ì…”í”Œ
  window.shuffledNotes = [...notes];
  window.shuffledNotesOriginal = [...notes];  // â— ì›ë³¸ ë°±ì—…
  for (let i = shuffledNotes.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffledNotes[i], shuffledNotes[j]] = [shuffledNotes[j], shuffledNotes[i]];
  }

document.getElementById("seasonStart").parentElement.style.display = "none";
document.getElementById("rewardSettingArea").style.display = "none";
document.getElementById("top10Display").style.display = "none";
document.getElementById("allScoresArea").style.display = "none";
document.getElementById("attendanceHistoryArea").style.display = "none";

// ëª¨ë‹¬ ë„ìš°ê¸° ì „ì— ì¶”ê°€í•´ì•¼ í•¨
setupVotingOrder();

// 1ï¸âƒ£ ë¨¼ì € ëª¨ë‹¬ì„ ë³´ì—¬ì¤€ë‹¤
const overlay = document.getElementById("drawModalOverlay");
overlay.style.display = "flex";
overlay.style.justifyContent = "center";
overlay.style.alignItems = "center";

// 2ï¸âƒ£ ê·¸ë¦¬ê³  ì•½ê°„ ì§€ì—°ì‹œì¼œì„œ (setTimeout)
setTimeout(() => {
  console.log("ğŸ§© setTimeout ì•ˆ ë“¤ì–´ì™”ë‹¤!");
  showVotingInfo();
  renderEnvelopes();
  updateLiveResultTable();
}, 100);

}

function onDrawButtonClick() {
  if (prepareMatchPlayers()) {
    drawMatchPositions();
  }
  window.voteOrder = voteOrder;

}


function assignTeams() {
  const numPlayers = parseInt(document.getElementById("matchCount").value);
  const formation = document.getElementById("formationSelect").value;
  const [df, mf, fw] = formation.split("-").map(Number);

  const selected = [...savedAttendanceData] // ì¶œì„ ì €ì¥ëœ ëª…ë‹¨
    .filter(p => memberList.map(m => m.name).includes(p.name))
    .slice(0, numPlayers);

  if (selected.length < numPlayers) {
    alert(`ì¶œì„ ì¸ì›ì´ ${numPlayers}ëª…ë³´ë‹¤ ì ìŠµë‹ˆë‹¤.`);
    return;
  }

  // ì…”í”Œ
  const shuffled = [...selected].sort(() => Math.random() - 0.5);

  const GK = shuffled[0].name;
  const DFs = shuffled.slice(1, 1 + df).map(p => p.name);
  const MFs = shuffled.slice(1 + df, 1 + df + mf).map(p => p.name);
  const FWs = shuffled.slice(1 + df + mf, 1 + df + mf + fw).map(p => p.name);

  // íŒ€ ë¶„í•  (ë‚˜ë¨¸ì§€ ì¸ì› ìë™ A/B ë°°ì •)
  const teamA = [], teamB = [];
  shuffled.forEach((p, i) => {
    if (i % 2 === 0) teamA.push(p.name);
    else teamB.push(p.name);
  });

  let html = `<h3>í¬ì§€ì…˜ ë°°ì • (${formation})</h3>`;
  html += `<p><strong>GK:</strong> ${GK}</p>`;
  html += `<p><strong>DF:</strong> ${DFs.join(", ")}</p>`;
  html += `<p><strong>MF:</strong> ${MFs.join(", ")}</p>`;
  html += `<p><strong>FW:</strong> ${FWs.join(", ")}</p>`;

  html += `<h3>AíŒ€</h3><ul>${teamA.map(n => `<li>${n}</li>`).join("")}</ul>`;
  html += `<h3>BíŒ€</h3><ul>${teamB.map(n => `<li>${n}</li>`).join("")}</ul>`;

  document.getElementById("teamResult").innerHTML = html;
}


function clearCurrentAttendanceInputs() {
  // ì„ íƒëœ ì´ë¦„ ë°°ì—´ê³¼ ìƒíƒœ ì´ˆê¸°í™”
  selectedNames = [];
  lateStatus = {};

  // ì¶œì„ í…Œì´ë¸” ì‚­ì œ
  const table = document.getElementById("selectedTable");
  if (table) table.remove();

  // ì§€ê° ìƒíƒœ í…Œì´ë¸”ë„ ì‚­ì œ
  const status = document.getElementById("lateStatusTable");
  if (status) status.remove();

  // ì¤‘ê°„ ì‚½ì… ì…ë ¥ì°½ì´ ìˆìœ¼ë©´ ì‚­ì œ
  const middleBox = document.getElementById("middleInsertBox");
  if (middleBox) middleBox.remove();

  // ìš”ì•½ ì˜ì—­ ì´ˆê¸°í™”
  const summary = document.getElementById("attendanceSummary");
  if (summary) summary.innerHTML = "";

  // ì„ íƒ ë“œë¡­ë‹¤ìš´ ì¬ë¡œë“œ
  loadRankedAttendance();  // ë‹¤ì‹œ ì´ˆê¸° í™”ë©´ ë Œë”ë§
}


function updateSelectOptions(selects) {
  const selectedKeys = [...selectedNames]; // fullKey ê¸°ì¤€ìœ¼ë¡œ ì²´í¬í•´ì•¼ ì •í™•

  selects.forEach(select => {
    const current = select.value;
    Array.from(select.options).forEach(option => {
      if (option.value === "") return;

      // ë¹„íšŒì› ì¶”ê°€ëŠ” í•­ìƒ í‘œì‹œ
      if (option.value === "__ë¹„íšŒì›__") {
        option.hidden = false;
        return;
      }

      // ì´ë¯¸ ì„ íƒëœ í•­ëª©ì€ ìˆ¨ê¹€ (ë‹¨, í˜„ì¬ ì„ íƒí•œ ê±´ ìœ ì§€)
      option.hidden = selectedKeys.includes(option.value) && option.value !== current;
    });
  });
}

function updateSummary() {
  const summaryDiv = document.getElementById("attendanceSummary");
  let summaryHtml = ""; // âœ… ìš”ì•½ ë¬¸ìì—´ ì´ˆê¸°í™”

  for (let i = 0; i < 30; i++) {
    const select = document.querySelector(`.name-select[data-index='${i}']`);
    const input = document.querySelector(`.manual-input[data-index='${i}']`);
    const lateCheckbox = document.querySelector(`.late-check[data-index='${i}']`);

    let name = "";

    if (input && input.value.trim() !== "") {
      name = input.value.trim();
    } else if (select && select.value.trim() !== "") {
      name = select.value.trim();
    }

    if (name === "") continue;

    const isLate = lateCheckbox?.checked || false;
    const flagText = isLate ? " (ì§€ê°)" : "";

    summaryHtml += `${i + 1}ë“±: ${name}${flagText}<br>`;
  }

  summaryDiv.innerHTML = summaryHtml; // âœ… ìš”ì•½ HTML í‘œì‹œ
}




let savedAttendanceData = [];

function saveAttendance() {
  savedAttendanceData = [];

  for (let i = 0; i < selectedNames.length; i++) {
    const fullKey = selectedNames[i];
    const [name] = fullKey.split("__");

    const late = lateStatus[name] || false;
    const leave = (confirmedSelections[name] || "").includes("ì¡°í‡´"); // âœ… ì¡°í‡´ ë°˜ì˜

    savedAttendanceData.push({
      rank: i + 1,
      name,
      late,
      leave, // âœ… ì¶”ê°€
      isNonMember: false,
      score: late ? 5 : 10
    });
  }

  const year = document.getElementById("yearSelect").value;
  const month = document.getElementById("monthSelect").value.padStart(2, '0');
  const day = document.getElementById("daySelect").value.padStart(2, '0');
  const dateKey = `${year}-${month}-${day}`;

  if (!window.attendanceHistoryData) window.attendanceHistoryData = {};
  window.attendanceHistoryData[dateKey] = [...savedAttendanceData];

  localStorage.setItem("attendanceHistoryData", JSON.stringify(attendanceHistoryData));

  alert(`ì¶œì„ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (${dateKey})`);
  renderAttendanceHistory();
}




function updateTeamCounts() {
  const total = savedAttendanceData.filter(p => memberList.map(m => m.name).includes(p.name)).length;
  const cNum = parseInt(document.getElementById("cTeamInput").value || 0);
  const rest = Math.max(0, total - cNum);
  const aNum = Math.ceil(rest / 2);
  const bNum = Math.floor(rest / 2);

  document.getElementById("totalCount").textContent = total;
  document.getElementById("cCount").textContent = cNum;
  document.getElementById("aCount").textContent = aNum;
  document.getElementById("bCount").textContent = bNum;
}


function renderAttendanceHistory() {
  const container = document.getElementById("attendanceHistory");
  if (!window.attendanceHistoryData || Object.keys(attendanceHistoryData).length === 0) {
  container.innerHTML = "<p>ì €ì¥ëœ ì¶œì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
  return;
}


  // ë‚ ì§œ ëª©ë¡ (ì—´)
  const dates = Object.keys(attendanceHistoryData).sort(); // ë‚ ì§œìˆœ ì •ë ¬

  // íšŒì› ëª©ë¡ (í–‰) - ê°€ë‚˜ë‹¤ìˆœ
  const sortedMembers = [...memberList].sort((a, b) => a.name.localeCompare(b.name, "ko"));

  // í‘œ ìƒì„±
  let html = "<table border='1' cellpadding='6' style='border-collapse: collapse; min-width: 600px; text-align: center;'>";

  // í—¤ë”
  html += "<thead><tr><th>ì„±ëª…</th>";
  dates.forEach(date => {
    html += `<th>${date}</th>`;
  });
  html += "</tr></thead><tbody>";

  // í–‰ ìƒì„±
  sortedMembers.forEach(member => {
    html += `<tr><td>${member.name}</td>`;

    dates.forEach(date => {
      const records = attendanceHistoryData[date];
      const entry = records.find(r => r.name === member.name);

      let status = "";
      if (entry) {
        if (entry.late || entry.leave) {
          status = "ì§€ê°"; // ì§€ê° or ì¡°í‡´ or ë‘˜ ë‹¤ â†’ ì§€ê°ìœ¼ë¡œ í‘œì‹œ
        } else {
          status = "ì°¸ì„";
        }
      }

      html += `<td>${status}</td>`;
    });

    html += "</tr>";
  });

  html += "</tbody></table>";
  container.innerHTML = html;
}



function updateWeekday() {
  const y = parseInt(yearSelect.value);
  const m = parseInt(monthSelect.value) - 1; // 0-indexed
  const d = parseInt(daySelect.value);
  const date = new Date(y, m, d);
  const weekday = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "][date.getDay()];
  
  weekdayDisplay.textContent = `${weekday}`; // â† "ìš”ì¼" ì œê±°, í•œ ê¸€ìë§Œ í‘œì‹œ

  // ìƒ‰ìƒ ì§€ì •
  let color = "black";
  if (weekday === "í† ") color = "blue";
  if (weekday === "ì¼") color = "red";
  weekdayDisplay.style.color = color;

  // âœ… ê¸€ì í¬ê¸° í‚¤ìš°ê¸° ì¶”ê°€
  weekdayDisplay.style.fontSize = "1.6rem";  // ì›í•˜ëŠ” í¬ê¸°ë¡œ ì¡°ì ˆ ê°€ëŠ¥
}


// ì´ë²¤íŠ¸ ë°”ì¸ë”©
yearSelect.addEventListener("change", updateWeekday);
monthSelect.addEventListener("change", updateWeekday);
daySelect.addEventListener("change", updateWeekday);

populateDateSelectors();
setupDateListeners();

let selectedNames = [];
let lateStatus = {};
let memberList = [];

document.getElementById("excelFileInput").addEventListener("change", function (e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];

    const memberData = [];
    let row = 3;

    while (true) {
      const nameCell = sheet[`B${row}`];
      const teamCell = sheet[`D${row}`];
      if (!nameCell && !teamCell) break;

      const name = nameCell ? nameCell.v.trim() : "";
      const team = teamCell ? teamCell.v.trim() : "";

      if (name !== "") {
        memberData.push({ name, team });
      }
      row++;
    }

    // âœ… ê¸°ì¡´ memberListì™€ ë³‘í•©
    const existingNames = new Set(memberList.map(m => m.name));
    const newMembers = memberData.filter(m => !existingNames.has(m.name));
    memberList = [...memberList, ...newMembers];

    // âœ… ì €ì¥
    localStorage.setItem("memberList", JSON.stringify(memberList));

    alert("ì—‘ì…€ íŒŒì¼ì˜ íšŒì› ëª…ë‹¨ì„ ê¸°ì¡´ ëª…ë‹¨ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.");
    downloadMemberList(); // í™”ë©´ ì¶œë ¥ ê°±ì‹ 
  };
  reader.readAsArrayBuffer(file);
});

let openedEnvelopes = [];
let confirmedSelections = {};
let currentPlayerIndex = 0;
let playerVoteCount = [];  // ì´í›„ ë‹¨ê³„ì—ì„œ ì„¤ì •ë¨
let confirmedIndexes = [];  // âœ… í™•ì •ëœ ìª½ì§€ ì¸ë±ìŠ¤ë¥¼ ì €ì¥


function renderEnvelopes() {
  console.log("ğŸ§© renderEnvelopes() í•¨ìˆ˜ ì§„ì…");

  if (!Array.isArray(voteOrder) || voteOrder.length === 0) {
    console.error("âŒ voteOrderê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
    return;
  }

  if (!voteOrder[currentPlayerIndex]) {
    console.error("âŒ currentPlayerIndex ë²”ìœ„ ì´ˆê³¼");
    return;
  }

  const container = document.getElementById("envelopeArea");
  container.innerHTML = "";

  shuffledNotes.forEach((note, index) => {
    const box = document.createElement("div");
    box.id = `envelope-${index}`;
    box.className = "envelope-box envelope";

    const isConfirmed = Object.values(confirmedSelections).includes(note);
    const isOpened = openedEnvelopes.some(e => e.index === index);

    if (isConfirmed) {
      box.textContent = "âœ…"; 
      box.style.cursor = "not-allowed"; 
      box.style.opacity = "0.6";
    } else if (isOpened) {
      box.textContent = "ğŸ’Œ"; 
      box.style.cursor = "pointer";
    } else {
      box.textContent = "âœ‰ï¸";
      box.style.cursor = "pointer";
    }

    box.style.userSelect = "none";
    box.style.width = "48px";
    box.style.height = "48px";
    box.style.fontSize = "1.4rem";
    box.style.display = "flex";
    box.style.alignItems = "center";
    box.style.justifyContent = "center";
    box.style.border = "1px solid #ccc";
    box.style.borderRadius = "6px";
    box.style.backgroundColor = "#ffffff";
    box.style.margin = "4px";

    if (isOpened && !isConfirmed) {
      if (note.startsWith("AíŒ€")) box.style.backgroundColor = "#fff9c4";
      else if (note.startsWith("BíŒ€")) box.style.backgroundColor = "#ffe0b2";
      else if (note.startsWith("CíŒ€")) box.style.backgroundColor = "#bbdefb";
      else if (note.includes("íœ´ì‹")) box.style.backgroundColor = "#eee";

      if (note.includes("FW")) {
        box.style.color = "#e53935";
        box.style.fontWeight = "bold";
      } else if (note.includes("MF")) {
        box.style.color = "#388e3c";
        box.style.fontWeight = "bold";
      } else if (note.includes("DF")) {
        box.style.color = "#1565c0";
        box.style.fontWeight = "bold";
      } else if (note.includes("GK")) {
        box.style.color = "#000000";
        box.style.fontWeight = "bold";
      }
    }

    if (!isConfirmed) {
      box.onclick = () => handleEnvelopeClick(index);
    }

    container.appendChild(box);
  });

  showVotingInfo();
}



function handleEnvelopeClick(index) {
  const box = document.getElementById(`envelope-${index}`);
  const playerName = voteOrder[currentPlayerIndex]?.name;
  
  if (!playerName) return;

  // ì´ë¯¸ í™•ì • ì„ íƒí•œ ê²½ìš° ë§‰ê¸°
  if (confirmedSelections[playerName]) return;

  const voteLimit = playerVoteCount[currentPlayerIndex] || 1;

  const openedIndex = openedEnvelopes.findIndex(e => e.index === index);

  if (openedIndex !== -1) {
    // ì´ë¯¸ ì—´ì—ˆë˜ ìª½ì§€ë¥¼ ë‹¤ì‹œ í´ë¦­ => ë‹«ê¸°
    openedEnvelopes.splice(openedIndex, 1);
    box.textContent = "âœ‰ï¸";
    box.style.cursor = "pointer";
    box.classList.remove("selected");
    return;
  }

  if (openedEnvelopes.length >= voteLimit) return;

  // ìƒˆë¡œ ì—´ê¸°
  box.textContent = "ğŸ’Œ";
  box.style.cursor = "default";
  box.classList.add("selected");

  openedEnvelopes.push({ index, value: shuffledNotes[index] });

  if (openedEnvelopes.length === voteLimit) {
    setTimeout(() => {
      showSelectionModal();
    }, 100);
  }
}

function downloadMemberList() {
  const listArea = document.getElementById("memberListDisplay");

  if (memberList.length === 0) {
    listArea.innerHTML = "íšŒì› ëª…ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.";
    return;
  }

  // ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬
  memberList.sort((a, b) => a.name.localeCompare(b.name, "ko"));

  let html = "<strong>íšŒì› ëª…ë‹¨:</strong><br><br>";
  html += `
    <table border="1" cellpadding="6" style="border-collapse: collapse; width: 100%; text-align: center;">
      <thead style="background-color: #f0f0f0;">
        <tr>
          <th>ì„±ëª…</th>
          <th>ì†Œì†</th>
          ${showEditTeamButtons ? "<th>ìˆ˜ì •</th>" : ""}
          ${showDeleteButtons ? "<th>ì‚­ì œ</th>" : ""}
        </tr>
      </thead>
      <tbody>
  `;

  memberList.forEach((m, i) => {
    html += `<tr>
      <td>${m.name}</td>
      <td id="teamCell${i}">
        ${m.team || ""}
        ${showEditTeamButtons ? `<button onclick="showEditTeamInput(${i})" style="margin-left: 6px;">ìˆ˜ì •</button>` : ""}
      </td>`;

    if (showEditTeamButtons) {
      html += `<td id="editCell${i}" style="display:none;">
        <input type="text" id="newTeam${i}" placeholder="ìˆ˜ì •í•  ì†Œì† ì…ë ¥" value="${m.team || ""}" />
        <button onclick="saveEditedTeam(${i})">ì €ì¥</button>
      </td>`;
    }

    if (showDeleteButtons) {
      html += `<td><button onclick="deleteMember(${i})" style="
        background-color: #f8d7da;
        color: #721c24;
        border: none;
        padding: 4px 10px;
        border-radius: 6px;
        cursor: pointer;"
        onmouseover="this.style.backgroundColor='#f5c6cb'" onmouseout="this.style.backgroundColor='#f8d7da'">ì‚­ì œ</button></td>`;
    }

    html += `</tr>`;
  });

  html += "</tbody></table>";
  listArea.innerHTML = html;
}


function addManualMember() {
  const nameInput = document.getElementById("manualName");
  const teamInput = document.getElementById("manualTeam");

  const name = nameInput.value.trim();
  const team = teamInput.value.trim();

  if (name === "") {
    alert("ì„±ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  // íšŒì› ì¶”ê°€
  memberList.push({ name, team });

  // âœ… ì €ì¥
  localStorage.setItem("memberList", JSON.stringify(memberList));

  // ì…ë ¥ì°½ ì´ˆê¸°í™”
  nameInput.value = "";
  teamInput.value = "";

  alert(`${name} ë‹˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  downloadMemberList();
}


// ğŸ”½ ì—¬ê¸°ì— í•¨ê»˜ ì¶”ê°€
let showDeleteButtons = false;
let showEditTeamButtons = false;

function toggleIndividualDelete() {
  showDeleteButtons = !showDeleteButtons;
  downloadMemberList(); // ë‹¤ì‹œ ì¶œë ¥
}

function toggleEditTeam() {
  showEditTeamButtons = !showEditTeamButtons;
  downloadMemberList(); // ë‹¤ì‹œ ì¶œë ¥
}
function showEditTeamInput(index) {
  const editCell = document.getElementById(`editCell${index}`);
  if (editCell) editCell.style.display = "table-cell";
}


function deleteMember(index) {
  const pw = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
  if (pw !== "0301") {
    alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  if (!confirm("ì´ íšŒì›ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  memberList.splice(index, 1);

  // âœ… ì €ì¥
  localStorage.setItem("memberList", JSON.stringify(memberList));

  downloadMemberList();
  loadRankedAttendance(); // ì¶œì„ë¶€ì—ë„ ë°˜ì˜
}
function renderLiveResult() {
  const assigned = {};
  Object.entries(confirmedSelections).forEach(([playerName, position]) => {
    assigned[playerName] = position;
  });

  const rows = voteOrder.map(player => {
    const name = player.name;
    const pos = assigned[name] || "-";

    let team = "-";
    if (pos.includes("AíŒ€")) team = "AíŒ€";
    else if (pos.includes("BíŒ€")) team = "BíŒ€";
    else if (pos.includes("CíŒ€")) team = "CíŒ€";

    return `<tr><td>${name}</td><td>${team}</td><td>${pos}</td></tr>`;
  });

  const html = `
    <h3 style="margin-top:2rem;">ì‹¤ì‹œê°„ ì¶”ì²¨ ê²°ê³¼</h3>
    <table border="1" cellpadding="6" style="border-collapse: collapse; width:100%; text-align:center;">
      <thead><tr><th>ì´ë¦„</th><th>íŒ€</th><th>í¬ì§€ì…˜</th></tr></thead>
      <tbody>${rows.join("")}</tbody>
    </table>
  `;

  document.getElementById("liveResultTable").innerHTML = html;
}


function saveEditedTeam(index) {
  const newTeamInput = document.getElementById(`newTeam${index}`);
  const newTeam = newTeamInput.value.trim();

  if (memberList[index]) {
    memberList[index].team = newTeam;

    // âœ… ì €ì¥
    localStorage.setItem("memberList", JSON.stringify(memberList));

    alert(`ì†Œì†ì´ '${newTeam}'(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    downloadMemberList();
  }
}



function deleteAllMembers() {
  const pw = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
  if (pw !== "0301") {
    alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  if (!confirm("ì •ë§ë¡œ ëª¨ë“  íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  memberList = [];

  // âœ… ì €ì¥
  localStorage.setItem("memberList", JSON.stringify(memberList));

  document.getElementById("memberListDisplay").innerHTML = "";
  document.getElementById("excelFileInput").value = "";
  alert("íšŒì› ëª…ë‹¨ì´ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
  loadRankedAttendance();
}

function assignTiedRanks(data) {
  let rank = 1;
  let skip = 0;
  let prevScore = null;

  return data.map((item, index) => {
    if (item.score === prevScore) {
      skip++;
    } else {
      rank += skip;
      skip = 1;
    }
    prevScore = item.score;
    return { ...item, rank: rank };
  });
}


function showTop10() {
  if (!Array.isArray(savedAttendanceData) || savedAttendanceData.length === 0) {
    alert("ì¶œì„ ì €ì¥ í›„ì— í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    return;
  }

  const startDate = document.getElementById("seasonStart").value;
  const endDate = document.getElementById("seasonEnd").value;
  if (!startDate || !endDate) {
    alert("ì‹œì¦Œ ì‹œì‘ì¼ê³¼ ë§ˆê°ì¼ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.");
    return;
  }

  const memberNames = memberList.map(m => m.name);
  const filtered = savedAttendanceData.filter(p => memberNames.includes(p.name));

  const allScores = getAllMemberScores(); // ì ìˆ˜ ê³„ì‚°
  const sorted = assignTiedRanks([...allScores].sort((a, b) => 
    b.score - a.score || a.name.localeCompare(b.name, "ko")
  )).slice(0, 10);

  let html = `<strong>ì‹œì¦Œ ê¸°ê°„:</strong> ${startDate} ~ ${endDate}<br><br>`;
  html += `
    <table border="1" cellpadding="8" style="border-collapse: collapse; width: 100%; text-align: center;">
      <thead style="background-color: #eee;">
        <tr>
          <th>ìˆœìœ„</th>
          <th>ì´ë¦„</th>
          <th>í¬ìƒê¸ˆ (ì˜ˆì •)</th>
        </tr>
      </thead>
      <tbody>
  `;

  sorted.forEach(p => {
    const prize = prizeMap[p.rank] || 0;
    html += `
      <tr>
        <td>${p.rank}ìœ„</td>
        <td>${p.name}</td>
        <td>${prize.toLocaleString("ko-KR")}ì›</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  document.getElementById("top10Display").innerHTML = html;
}


function getAllMemberScores() {
  if (!window.attendanceHistoryData || !Array.isArray(memberList)) return [];

  const memberNames = memberList.map(m => m.name);
  const scores = {};

  for (const date in attendanceHistoryData) {
    attendanceHistoryData[date].forEach(entry => {
      if (memberNames.includes(entry.name)) {
        if (!scores[entry.name]) scores[entry.name] = 0;
        scores[entry.name] += entry.score;
      }
    });
  }

  return Object.entries(scores).map(([name, score]) => ({ name, score }));
}


// ê¸°ë³¸ í¬ìƒê¸ˆ ì„¤ì • (ìˆ˜ì • ê°€ëŠ¥)
let prizeMap = {
  1: 120000,
  2: 70000,
  3: 60000,
  4: 50000,
  5: 50000,
  6: 30000,
  7: 30000,
  8: 30000,
  9: 30000,
  10: 30000,
};

function openRewardSetting() {
  const pw = prompt("í¬ìƒê¸ˆ ì„¤ì •ì„ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
  if (pw !== "0301") {
    alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
    return;
  }

  const container = document.getElementById("rewardSettingArea");
  container.style.display = "block";

  let html = "<strong>í¬ìƒê¸ˆ ì„¤ì • (â‚©):</strong><br>";

  for (let i = 1; i <= 10; i++) {
    html += `${i}ìœ„: <input type="number" id="prize${i}" value="${prizeMap[i]}" style="width:100px;"> ì›<br>`;
  }

  html += `<button onclick="savePrizeMap()" style="margin-top:10px;">ì €ì¥</button>`;
  container.innerHTML = html;
}


function savePrizeMap() {
  for (let i = 1; i <= 10; i++) {
    const input = document.getElementById(`prize${i}`);
    const value = parseInt(input.value);
    prizeMap[i] = isNaN(value) ? 0 : value;
  }

  document.getElementById("rewardSettingArea").innerHTML = "";
  document.getElementById("rewardSettingArea").style.display = "none";
  alert("í¬ìƒê¸ˆì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

function showAllScores() {
  const allScores = getAllMemberScores();
  const sorted = assignTiedRanks([...allScores].sort((a, b) => b.score - a.score || a.name.localeCompare(b.name, "ko")));

  // í…Œì´ë¸” ì¶œë ¥
  let maxScore = Math.max(...sorted.map(p => p.score));
let html = `
  <table border="1" cellpadding="6" style="border-collapse: collapse; width:100%; text-align:center;">
    <thead style="background-color:#eee;">
      <tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ì ìˆ˜</th><th>ì°¸ì—¬ ì •ë„</th></tr>
    </thead><tbody>
`;

sorted.forEach(p => {
  const percent = (p.score / maxScore) * 100;
  html += `
    <tr>
      <td>${p.rank}ìœ„</td>
      <td>${p.name}</td>
      <td>${p.score}</td>
      <td>
        <div style="background:#eee; width:100%; height:20px; border-radius:4px; overflow:hidden;">
          <div style="background:#4caf50; width:${percent}%; height:100%;"></div>
        </div>
      </td>
    </tr>
  `;
});

html += `</tbody></table>`;
document.getElementById("allScoresArea").innerHTML = html;

}
function showSelectionModal() {
  const modal = document.getElementById("selectionModal");
  const optionsDiv = document.getElementById("modalOptions");
  const closeBtn = document.getElementById("modalCloseBtn");

  if (closeBtn) closeBtn.style.display = "none";
  optionsDiv.innerHTML = "";

  let hasValidButton = false;

  openedEnvelopes.forEach((item) => {
    if (!item || typeof item.index !== "number" || typeof item.value === "undefined") {
      console.warn("âš ï¸ openedEnvelopes í•­ëª© ì˜¤ë¥˜:", item);
      return;
    }

    const btn = document.createElement("button");
    btn.textContent = item.value;
    applyButtonStyle(btn, item.value); // ğŸ¯ ìŠ¤íƒ€ì¼ í•¨ìˆ˜ ë”°ë¡œ!

    btn.onclick = () => confirmSelection(item.index);  // âœ… ì£¼ì˜: index ì•„ë‹ˆë¼ ì‹¤ì œ item.index!
    optionsDiv.appendChild(btn);
    hasValidButton = true;
  });

  if (!hasValidButton) {
    optionsDiv.innerHTML = `<p style="font-size:1.2rem; color: red; font-weight: bold;">ì„ íƒ ê°€ëŠ¥í•œ ìª½ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
  }

  modal.style.display = "flex";
}

// ğŸ¯ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì ìš© í•¨ìˆ˜
function applyButtonStyle(button, value) {
  button.style.padding = "0.8rem 1.2rem";
  button.style.fontSize = "1.2rem";
  button.style.cursor = "pointer";
  button.style.border = "1px solid #ccc";
  button.style.borderRadius = "8px";
  button.style.margin = "0.4rem";

  if (value.startsWith("AíŒ€")) button.style.backgroundColor = "#fff9c4";
  else if (value.startsWith("BíŒ€")) button.style.backgroundColor = "#ffe0b2";
  else if (value.startsWith("CíŒ€")) button.style.backgroundColor = "#bbdefb";
}



function confirmSelection(selectedIndex) {
  const selectedNote = openedEnvelopes.find(e => e.index === selectedIndex);
  const player = voteOrder[currentPlayerIndex];

  if (!selectedNote) {
    console.error("âŒ ì„ íƒí•œ ìª½ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", selectedIndex);
    alert("ìª½ì§€ ì˜¤ë¥˜ ë°œìƒ");
    return;
  }

  // âœ… ì „ì—­ ê°ì²´ë¡œ ì´ˆê¸°í™” ë³´ì¥
  if (!window.confirmedSelections) window.confirmedSelections = {};

  window.confirmedSelections[player.name] = selectedNote.value;
  console.log(`âœ… í™•ì •ëœ ì„ íƒ: ${player.name} â†’ ${selectedNote.value}`);

  const selectionModal = document.getElementById("selectionModal");
  if (selectionModal) {
    selectionModal.style.display = "none";
  }

  openedEnvelopes = [];
  renderEnvelopes();
  updateLiveResultTable();

  currentPlayerIndex++;

  if (currentPlayerIndex < voteOrder.length) {
    setTimeout(() => {
      showVotingInfo();
      renderEnvelopes();
    }, 300);
  } else {
    console.log("âœ… ëª¨ë“  ìª½ì§€ ì„ íƒ ì™„ë£Œ");
    console.log("âœ… í™•ì •ëœ ì„ íƒ ìˆ˜:", Object.keys(window.confirmedSelections).length, "/", voteOrder.length);
    moveToTeamTab();
  }
}




function moveToTeamTab() {
  // âœ… ëª¨ë‹¬ ë‹«ê¸°
  ["resultModalOverlay", "drawModalOverlay", "selectionModal"].forEach(id => {
    const modal = document.getElementById(id);
    if (modal) {
      modal.style.display = "none";
      modal.style.visibility = "hidden";
    }
  });

  showTab("teamTab");
  console.log("âœ… íƒ­ ì „í™˜ë¨: teamTab");

  if (window.confirmedSelections && Object.keys(window.confirmedSelections).length > 0) {
    const finalResults = { A: [], B: [], C: [] };

    Object.entries(window.confirmedSelections).forEach(([name, pos]) => {
      const match = pos.trim().match(/^(AíŒ€|BíŒ€|CíŒ€)\s*(.*)$/);
      if (!match) {
        console.warn(`âš ï¸ íŒ€ í¬ë§· í•´ì„ ì‹¤íŒ¨: ${name} = '${pos}'`);
        return;
      }

      const teamStr = match[1];
      const position = match[2].trim();

      const team = teamStr === "AíŒ€" ? "A" :
                   teamStr === "BíŒ€" ? "B" :
                   teamStr === "CíŒ€" ? "C" : null;

      if (!team) {
        console.warn(`âš ï¸ íŒ€ ë§¤í•‘ ì‹¤íŒ¨: ${teamStr}`);
        return;
      }

      finalResults[team].push({ name, position });
    });

    window.finalTeamResults = finalResults;
    localStorage.setItem("finalTeamResults", JSON.stringify(finalResults));
    console.log("âœ… ìµœì¢… íŒ€ ê²°ê³¼ ì €ì¥ë¨:", finalResults);

    displayFinalTeamResults();
  } else {
    console.warn("â— confirmedSelectionsê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
  }

  if (window.confirmedSelections) {
    localStorage.setItem("finalTeamSelections", JSON.stringify(window.confirmedSelections));
  }

  window.scrollTo(0, 0);
}




function saveFinalTeamResults() {
  const finalResults = { A: [], B: [], C: [] };

  Object.entries(confirmedSelections).forEach(([name, pos]) => {
    const trimmed = pos.trim(); // ğŸ”¥ ê³µë°± ì œê±°

    const team = trimmed.startsWith("AíŒ€") ? "A" :
                 trimmed.startsWith("BíŒ€") ? "B" :
                 trimmed.startsWith("CíŒ€") ? "C" : null;

    if (!team) {
      console.warn(`âš ï¸ íŒ€ êµ¬ë¶„ ì‹¤íŒ¨: ${name} = '${pos}'`);
      return;
    }

    const position = trimmed.replace(/^(AíŒ€ |BíŒ€ |CíŒ€ )/, "");

    finalResults[team].push({ name, position });
  });

  console.log("âœ… ìµœì¢… ì €ì¥í•  íŒ€ ê²°ê³¼:", finalResults);

  window.finalTeamResults = finalResults;
  localStorage.setItem("finalTeamResults", JSON.stringify(finalResults));
}




function reshuffleRemainingEnvelopes() {
  // 1. í™•ì •ëœ ìª½ì§€ ë¹¼ê³ 
  const confirmedValues = Object.values(confirmedSelections);
  const remainingNotes = shuffledNotes.filter(note => !confirmedValues.includes(note));

  // 2. ë‚¨ì€ ìª½ì§€ ì‹¤ì œë¡œ ì…”í”Œ
  for (let i = remainingNotes.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [remainingNotes[i], remainingNotes[j]] = [remainingNotes[j], remainingNotes[i]];
  }

  // 3. í™•ì •ëœ ìª½ì§€ + ìƒˆë¡œ ì„ì€ ìª½ì§€ í•©ì³ì„œ ë‹¤ì‹œ shuffledNotes ë§Œë“ ë‹¤
  const finalNotes = [];
  let remainingIdx = 0;

  shuffledNotes.forEach(note => {
    if (confirmedValues.includes(note)) {
      finalNotes.push(note); // í™•ì •ëœ ìª½ì§€ëŠ” ê³ ì •
    } else {
      finalNotes.push(remainingNotes[remainingIdx++]); // ë‚¨ì€ ìª½ì§€ëŠ” ìƒˆë¡œ ì„ì€ ìˆœì„œëŒ€ë¡œ
    }
  });

  shuffledNotes = finalNotes;
}





// ì „ì—­ ì¤‘ë³µ ì´ë¦„ ë¦¬ìŠ¤íŠ¸
let duplicateNames = [];

function getDuplicateNames(memberList) {
  const nameCount = {};
  memberList.forEach(m => {
    nameCount[m.name] = (nameCount[m.name] || 0) + 1;
  });

  return Object.entries(nameCount)
    .filter(([_, count]) => count > 1)
    .map(([name]) => name);
}

function getDisplayName(name) {
  const isDup = duplicateNames.includes(name);
  const member = memberList.find(m => m.name === name);
  return isDup && member?.team ? `${name} (${member.team})` : name;
}






function updateLiveResultTable() {
  const container = document.getElementById("liveResultTable");

  // âœ… ì´ˆê¸°í™”: í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ ìƒì„±
  if (!document.getElementById("liveA")) {
    container.innerHTML = `
      <div>
        <h3 style="text-align: center;">AíŒ€ ì¶”ì²¨ ê²°ê³¼</h3>
        <table id="liveA" border="1" cellpadding="8" style="background-color: #fff9c4; border-collapse: collapse; width: 45vw; min-width: 150px; max-width: 360px; text-align: center;">
          <thead><tr><th>ì´ë¦„</th><th>í¬ì§€ì…˜</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="liveBWrapper" style="display:none;">
        <h3 style="text-align: center;">BíŒ€ ì¶”ì²¨ ê²°ê³¼</h3>
        <table id="liveB" border="1" cellpadding="8" style="background-color: #ffe0b2; border-collapse: collapse; width: 45vw; min-width: 150px; max-width: 360px; text-align: center;">
          <thead><tr><th>ì´ë¦„</th><th>í¬ì§€ì…˜</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="liveCWrapper" style="display:none;">
        <h3 style="text-align: center;">CíŒ€ ì¶”ì²¨ ê²°ê³¼</h3>
        <table id="liveC" border="1" cellpadding="8" style="background-color: #bbdefb; border-collapse: collapse; width: 45vw; min-width: 150px; max-width: 360px; text-align: center;">
          <thead><tr><th>ì´ë¦„</th><th>í¬ì§€ì…˜</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    `;
  }

  const aTable = document.getElementById("liveA").querySelector("tbody");
  const bContainer = document.getElementById("liveB")?.parentElement;
  const bTable = document.getElementById("liveB")?.querySelector("tbody");
  const cContainer = document.getElementById("liveC")?.parentElement;
  const cTable = document.getElementById("liveC")?.querySelector("tbody");

  aTable.innerHTML = "";
  if (bTable) bTable.innerHTML = "";
  if (cTable) cTable.innerHTML = "";
  if (bContainer) bContainer.style.display = "none";
  if (cContainer) cContainer.style.display = "none";

  let bCount = 0, cCount = 0;

  const cTeamHasPositions = (window.finalTeamResults?.C || []).some(p => p.position);

  Object.entries(confirmedSelections).forEach(([name, pos]) => {
    const cleanPos = pos.replace(/^AíŒ€ |^BíŒ€ |^CíŒ€ /, "");
    const displayName = getDisplayName(name);
    const team = pos.slice(0, 2); // AíŒ€ / BíŒ€ / CíŒ€

    if (team === "AíŒ€") {
      aTable.innerHTML += `<tr><td>${displayName}</td><td>${cleanPos}</td></tr>`;
    } else if (team === "BíŒ€" && bTable) {
      bTable.innerHTML += `<tr><td>${displayName}</td><td>${cleanPos}</td></tr>`;
      bCount++;
    } else if (team === "CíŒ€" && cTable) {
      const row = `<tr><td>${displayName}</td><td>${cTeamHasPositions ? cleanPos : ""}</td></tr>`;
      cTable.innerHTML += row;
      cCount++;
    }
  });

  if (bCount > 0 && bContainer) bContainer.style.display = "block";
  if (cCount > 0 && cContainer) cContainer.style.display = "block";
}




function displayFinalTeamResults() {
  const container = document.getElementById("teamDivisionResult");
  if (!container) {
    console.error("âŒ teamDivisionResult divê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // âœ… window.finalTeamResults ì§ì ‘ ì‚¬ìš©
  const finalResults = window.finalTeamResults;
  if (!finalResults || Object.keys(finalResults).length === 0) {
    console.warn("âš ï¸ finalTeamResultsê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
    return;
  }

  console.log("âœ… ìµœì¢… íŒ€ ê²°ê³¼ (ì¦‰ì‹œ):", finalResults);

  const teamStyles = { A: "#fff9c4", B: "#ffe0b2", C: "#bbdefb" };

  let html = `<div style="display:flex; gap:2rem; justify-content:center; flex-wrap:wrap;">`;

  ["A", "B"].forEach(teamKey => {
    const team = finalResults[teamKey] || [];
    if (team.length > 0) {
      html += `
        <div>
          <h3 style="text-align:center;">${teamKey}íŒ€</h3>
          <table border="1" cellpadding="6" style="border-collapse: collapse; width:300px; background-color:${teamStyles[teamKey]}; text-align:center;">
            <thead>
              <tr><th>ìˆœ</th><th>ì´ë¦„</th><th>í¬ì§€ì…˜</th></tr>
            </thead>
            <tbody>
              ${team.map((p, idx) => `
                <tr>
                  <td>${idx + 1}</td>
                  <td>${p.name}</td>
                  <td>${p.position || ""}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `;
    }
  });

  if ((finalResults["C"] || []).length > 0) {
    const team = finalResults["C"];
    html += `
      <div style="margin-top:2rem;">
        <h3 style="text-align:center;">CíŒ€</h3>
        <table border="1" cellpadding="6" style="border-collapse: collapse; width:300px; background-color:${teamStyles.C}; text-align:center;">
          <thead>
            <tr><th>ìˆœ</th><th>ì´ë¦„</th></tr>
          </thead>
          <tbody>
            ${team.map((p, idx) => `
              <tr>
                <td>${idx + 1}</td>
                <td>${p.name}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    `;
  }

  html += `</div>`;

  container.innerHTML = html;
}



function finalizeSelections() {
  if (!window.confirmedSelections || Object.keys(confirmedSelections).length === 0) {
    alert("í™•ì •ëœ ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // 1. ìµœì¢… ê²°ê³¼ë¥¼ localStorageì— ì €ì¥
  localStorage.setItem("confirmedSelections", JSON.stringify(confirmedSelections));

  // 2. íŒ€ ê²°ê³¼ í…Œì´ë¸” ìƒì„± ë° í‘œì‹œ
  displayFinalTeamResults();

  // 3. íƒ­ ì´ë™ (íŒ€ êµ¬ë¶„ íƒ­ìœ¼ë¡œ)
  showTab("teamTab");

  // 4. ìµœìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
  window.scrollTo(0, 0);

  // 5. ì™„ë£Œ ì•Œë¦¼
  alert("âœ… ìµœì¢… ë½‘ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
}



function closeResultModal() {
  const modal = document.getElementById("resultModalOverlay");
  if (modal) modal.style.display = "none";
}

function markLeave(name, teamKey) {
  if (!confirm(`${name} ë‹˜ì„ ${teamKey}íŒ€ì—ì„œ ì¡°í‡´ ì²˜ë¦¬í• ê¹Œìš”?`)) return;

  delete confirmedSelections[name];

  if (!window.attendanceHistoryData) return alert("ì¶œì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
  const dateKey = Object.keys(attendanceHistoryData).sort().pop();
  const data = attendanceHistoryData[dateKey];
  if (!data) return alert("í•´ë‹¹ ë‚ ì§œì˜ ì¶œì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

  const entry = data.find(p => p.name === name);
  if (entry) {
    entry.leave = true;
    entry.late = false;
  }

  localStorage.setItem("attendanceHistoryData", JSON.stringify(attendanceHistoryData));
  displayFinalTeamResults();
}

function resetDraw() {
  openedEnvelopes = [];
  confirmedSelections = {};
  confirmedIndexes = [];
  currentPlayerIndex = 0;

  renderEnvelopes();
  updateLiveResultTable();

  const resultEl = document.getElementById("matchResult");
  if (resultEl) resultEl.innerHTML = "";
}

function closeSelectionModal() {
  const modal = document.getElementById("selectionModal");
  if (modal) modal.style.display = "none";
}


let voteOrder = [];

function showVotingInfo() {
  console.log("ğŸ§© showVotingInfo() í•¨ìˆ˜ ì§„ì…");
  console.log("ğŸ¯ currentPlayerIndex:", currentPlayerIndex);
console.log("ğŸ¯ voteOrder:", voteOrder);
console.log("ğŸ¯ voteOrder[currentPlayerIndex]:", voteOrder[currentPlayerIndex]);


  if (!voteOrder[currentPlayerIndex]) {
    console.error("âŒ voteOrder[currentPlayerIndex]ê°€ ì—†ìŒ!");
    return;
  }

  const player = voteOrder[currentPlayerIndex];
  const votes = playerVoteCount[currentPlayerIndex];

  const rankCell = document.getElementById("drawRankCell");
  const nameCell = document.getElementById("drawNameCell");
  const voteCell = document.getElementById("drawVoteCell");

  if (!rankCell || !nameCell || !voteCell) {
    console.error("âŒ drawRankCell / drawNameCell / drawVoteCell ì¤‘ í•˜ë‚˜ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  rankCell.textContent = `${currentPlayerIndex + 1}ë“±`;
  nameCell.textContent = player?.name || "-";
  voteCell.textContent = `${votes}ì¥`;
}




function setupVotingOrder() {
  if (!Array.isArray(matchPlayers) || matchPlayers.length === 0) {
    console.warn("âš ï¸ matchPlayersê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
    return;
  }
  voteOrder = matchPlayers.filter(p => !p.leave);
  playerVoteCount = voteOrder.map((_, idx) => {
    if (idx <= 1) return 3;
    if (idx < Math.ceil(voteOrder.length / 2)) return 2;
    return 1;
  });

  console.log("ğŸ’¬ setupVotingOrder í˜¸ì¶œë¨, matchPlayers:", matchPlayers);
console.log("ğŸ’¬ setupVotingOrder ì™„ë£Œ, voteOrder:", voteOrder);

}







function drawScoreChart(data) {
  const canvas = document.getElementById("scoreChart");
  if (!canvas) return console.error("âŒ scoreChart ìº”ë²„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  if (!Array.isArray(data) || data.length === 0) {
    console.warn("âš ï¸ ì ìˆ˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const ctx = canvas.getContext("2d");
  if (window.scoreChartInstance) {
    window.scoreChartInstance.destroy();
  }

  const labels = data.map(p => p.name);
  const scores = data.map(p => p.score);

  window.scoreChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'ì°¸ì—¬ ì ìˆ˜',
        data: scores,
        backgroundColor: 'rgba(75, 192, 192, 0.6)',
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 1
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: 'íšŒì›ë³„ ì¶œì„ ì°¸ì—¬ ì ìˆ˜',
          font: {
            size: 14,
            family: "'GmarketSans', sans-serif"
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          precision: 0
        }
      }
    }
  });
}


function toggleAttendanceHistory() {
  const area = document.getElementById("attendanceHistoryArea");
  if (area.style.display === "none") {
    renderAttendanceHistory(); // í…Œì´ë¸” ìƒì„±
    area.style.display = "block";
  } else {
    area.style.display = "none";
  }
}

function renderAttendanceHistory() {
  const container = document.getElementById("attendanceHistoryArea");
  if (!window.attendanceHistoryData || Object.keys(attendanceHistoryData).length === 0) {
    container.innerHTML = "<p>ì €ì¥ëœ ì¶œì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    return;
  }

  const dates = Object.keys(attendanceHistoryData).sort();
  const sortedMembers = [...memberList].sort((a, b) => a.name.localeCompare(b.name, "ko"));

  let html = "<table border='1' cellpadding='6' style='border-collapse: collapse; min-width: 600px; text-align: center;'>";
  html += "<thead><tr><th>ì„±ëª…</th>";
  dates.forEach(date => {
    html += `<th>${date}</th>`;
  });
  html += "</tr></thead><tbody>";

  sortedMembers.forEach(member => {
    html += `<tr><td>${member.name}</td>`;
    dates.forEach(date => {
      const records = attendanceHistoryData[date];
      const entry = records.find(r => r.name === member.name);
      let status = "";
      if (entry) {
        if (entry.leave) {
          status = "ì¡°í‡´";
        } else if (entry.late) {
          status = "ì§€ê°";
        } else {
          status = "ì°¸ì„";
        }
      }
      html += `<td>${status}</td>`;
    });
    html += "</tr>";
  });

  html += "</tbody></table>";
  container.innerHTML = html;
}

function renderTeamDivisionResult() {
  const container = document.getElementById("teamDivisionResult");
  container.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

  const finalResults = JSON.parse(localStorage.getItem("finalTeamResults") || "{}");
  const teams = {
    A: finalResults["AíŒ€"] || [],
    B: finalResults["BíŒ€"] || [],
    C: finalResults["CíŒ€"] || []
  };
  const colors = { A: "#fff9c4", B: "#ffe0b2", C: "#bbdefb" };

  for (const team in teams) {
    if (teams[team].length === 0) continue;

    const teamBox = document.createElement("div");
    teamBox.style.display = "inline-block";
    teamBox.style.verticalAlign = "top";
    teamBox.style.margin = "0 1.5rem 2rem 0";
    teamBox.style.background = colors[team];
    teamBox.style.padding = "1rem";
    teamBox.style.borderRadius = "10px";
    teamBox.style.minWidth = "230px";

    const title = document.createElement("h3");
    title.textContent = `${team}íŒ€`;
    teamBox.appendChild(title);

    const table = document.createElement("table");
    table.style.borderCollapse = "collapse";
    table.style.width = "100%";

    const thead = document.createElement("thead");
    thead.innerHTML = "<tr><th>ìˆœ</th><th>ì´ë¦„</th><th>í¬ì§€ì…˜</th></tr>";
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    teams[team].forEach((player, i) => {
      const row = document.createElement("tr");
      row.innerHTML = `<td>${i + 1}</td><td>${player.name}</td><td>${player.position || ""}</td>`;
      tbody.appendChild(row);
    });

    table.appendChild(tbody);
    teamBox.appendChild(table);
    container.appendChild(teamBox);
  }
}


function confirmResetDrawModal() {
  const proceed = confirm("ëª¨ë“  ì„ íƒì„ ë¦¬ì…‹í•©ë‹ˆë‹¤.\ní¬ì§€ì…˜ ë½‘ê¸°ë¥¼ ë‹¤ì‹œ í•˜ê³  ì‹¶ë‹¤ë©´ í™•ì¸ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.");
  if (!proceed) return;

  // ìƒíƒœ ì´ˆê¸°í™”
  currentPlayerIndex = 0;
  openedEnvelopes = [];
  confirmedSelections = {};
  confirmedIndexes = [];

  // ìª½ì§€ UI ì´ˆê¸°í™”
  renderEnvelopes();

  // ì‹¤ì‹œê°„ ê²°ê³¼ í…Œì´ë¸” ì´ˆê¸°í™”
  const liveResultTable = document.getElementById("liveResultTable");
  if (liveResultTable) {
    liveResultTable.innerHTML = `
      <div>
        <h3 style="text-align: center;">AíŒ€ ì¶”ì²¨ ê²°ê³¼</h3>
        <table id="liveA" border="1" cellpadding="8" style="background-color: #fff9c4; border-collapse: collapse; width: 45vw; min-width: 150px; max-width: 360px; text-align: center;">
          <thead><tr><th>ì´ë¦„</th><th>í¬ì§€ì…˜</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="liveBWrapper" style="display:none;">
        <h3 style="text-align: center;">BíŒ€ ì¶”ì²¨ ê²°ê³¼</h3>
        <table id="liveB" border="1" cellpadding="8" style="background-color: #ffe0b2; border-collapse: collapse; width: 45vw; min-width: 150px; max-width: 360px; text-align: center;">
          <thead><tr><th>ì´ë¦„</th><th>í¬ì§€ì…˜</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="liveCWrapper" style="display:none;">
        <h3 style="text-align: center;">CíŒ€ ì¶”ì²¨ ê²°ê³¼</h3>
        <table id="liveC" border="1" cellpadding="8" style="background-color: #bbdefb; border-collapse: collapse; width: 45vw; min-width: 150px; max-width: 360px; text-align: center;">
          <thead><tr><th>ì´ë¦„</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    `;
  }

  // í˜„ì¬ ìˆœì„œ UI ì´ˆê¸°í™”
  const rankCell = document.getElementById("drawRankCell");
  const nameCell = document.getElementById("drawNameCell");
  const voteCell = document.getElementById("drawVoteCell");
  if (rankCell) rankCell.textContent = "-";
  if (nameCell) nameCell.textContent = "-";
  if (voteCell) voteCell.textContent = "-";

  // ëª¨ë‹¬ ë‹«ê¸°
  const modal = document.getElementById("drawModalOverlay");
  if (modal) modal.style.display = "none";

  // ì‚¬ìš©ì ì•Œë¦¼
  alert("ì´ˆê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë½‘ê¸°ë¥¼ ì‹œì‘í•˜ë ¤ë©´ 'í¬ì§€ì…˜ ë½‘ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
}






function updatePositionHeader() {
  if (!Array.isArray(drawOrder) || drawIndex < 0 || drawIndex >= drawOrder.length) {
    console.warn("â— drawOrder ë˜ëŠ” drawIndexê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  const current = drawOrder[drawIndex];
  const rank = drawIndex + 1;
  const name = current.name || "ì´ë¦„ ì—†ìŒ";
  const votes = current.votes || 1;

  const headerText = `${rank}ë“± ${name} ${votes}ì¥`;
  const headerEl = document.getElementById("positionHeader");
  if (headerEl) headerEl.textContent = headerText;
  else console.warn("â— positionHeader ìš”ì†Œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
}


  </script>
 
<!-- XLSX ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
   
   window.addEventListener('DOMContentLoaded', () => {
  // âœ… ì¶œì„ ì´ë ¥ ë³µì›
  const savedData = localStorage.getItem("attendanceHistoryData");
  if (savedData) {
    try {
      window.attendanceHistoryData = JSON.parse(savedData);
      renderAttendanceHistory();
    } catch (e) {
      console.error("ì¶œì„ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", e);
    }
  } else {
    window.attendanceHistoryData = {};
  }

  // âœ… memberList ë³µì›
  const savedMembers = localStorage.getItem("memberList");
  if (savedMembers) {
    try {
      memberList = JSON.parse(savedMembers);
    } catch (e) {
      console.error("íšŒì› ëª…ë‹¨ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", e);
      memberList = [];
    }
  } else {
    memberList = [];
  }

  // âœ… memberList ë³µì› ì´í›„ì— ì‹¤í–‰
  if (memberList.length > 0) {
    loadRankedAttendance();
  }

  // âœ… ì—¬ê¸°ë¡œ ì˜®ê¸°ê¸°!!
  const finalTeamA = window.matchTeamAssignments?.teamA || [];
  const finalTeamB = window.matchTeamAssignments?.teamB || [];
  const finalTeamC = window.matchTeamAssignments?.teamC || [];

  // ì´ë²¤íŠ¸ ë°”ì¸ë”©
  ["dfA", "mfA", "fwA"].forEach(id => {
    document.getElementById(id).addEventListener("input", () => updateRemainingPlayers("A"));
  });

  ["dfB", "mfB", "fwB"].forEach(id => {
    document.getElementById(id).addEventListener("input", () => updateRemainingPlayers("B"));
  });

  document.getElementById("matchAStarter").addEventListener("input", () => suggestFormation("A"));
  document.getElementById("matchBStarter").addEventListener("input", () => suggestFormation("B"));
});


  </script>
  
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // ì—¬ê¸°ì— ì¶”ê°€í•˜ì„¸ìš” ğŸ‘‡
    window.addEventListener("keydown", function (e) {
  if ((e.key === "F5") || (e.ctrlKey && e.key === "r")) {
    e.preventDefault();
    alert("ìƒˆë¡œê³ ì¹¨ì´ ì°¨ë‹¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
  }
});

window.addEventListener("beforeunload", function (e) {
  e.preventDefault();
  e.returnValue = "";
});
function closeDrawModal() {
  document.getElementById("drawModalOverlay").style.display = "none";
}
function redoSelection() {
  if (!lastSelection || !lastSelection.envelopesSnapshot) {
    alert("ë˜ëŒë¦´ ìˆ˜ ìˆëŠ” ì„ íƒì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const { playerName, envelopeIndex, envelopesSnapshot, value, playerIndex } = lastSelection;

  // âœ… 1. í™•ì •ëœ ì„ íƒ ì·¨ì†Œ
  delete confirmedSelections[playerName];

  // âœ… 2. confirmedIndexes ê´€ë¦¬ (í•„ìš”í•œ ê²½ìš°)
  if (typeof confirmedIndexes !== "undefined") {
    const idx = confirmedIndexes.indexOf(envelopeIndex);
    if (idx !== -1) confirmedIndexes.splice(idx, 1);
  }

  // âœ… 3. currentPlayerIndex ë˜ëŒë¦¬ê¸°
  currentPlayerIndex = playerIndex;

  // âœ… 4. íŒ€ê²°ê³¼í‘œì—ì„œ ì‚­ì œ
  removeFromLiveResult(playerName);

  // âŒ shuffledNotes.push(value); âŒ í•˜ë©´ ì•ˆ ëœë‹¤!

  // âœ… 5. ì—´ë¦° ìª½ì§€ ìƒíƒœ ë³µêµ¬
  openedEnvelopes = [...envelopesSnapshot];

  // âœ… 6. ìª½ì§€ UI ë‹¤ì‹œ ê·¸ë¦¬ê¸°
  renderEnvelopes();

  // âœ… 7. ì„ íƒ ëª¨ë‹¬ ë‹¤ì‹œ ë„ìš°ê¸°
  showSelectionModal();

  // âœ… 8. ê²°ê³¼ í…Œì´ë¸” ê°±ì‹ 
  updateLiveResultTable();

  // âœ… 9. ì„ íƒ ê¸°ë¡ ì´ˆê¸°í™”
  lastSelection = null;

  // âœ… 10. í˜„ì¬ ì‚¬ëŒ í‘œì‹œ
  showVotingInfo();
}






function removeFromLiveResult(playerName) {
  const tables = ['liveResultTableA', 'liveResultTableB', 'liveResultTableC'];
  tables.forEach(tableId => {
    const table = document.getElementById(tableId);
    if (!table) return;
    const rows = table.querySelectorAll('tr');
    rows.forEach(row => {
      const cells = row.querySelectorAll('td');
      if (cells.length > 0 && cells[0].textContent.trim() === playerName) {
        row.remove(); // ì´ë¦„ì´ ì¼ì¹˜í•˜ëŠ” í–‰ ì‚­ì œ
      }
    });
  });
}




function confirmReset() {
  if (confirm("âš ï¸ ëª¨ë“  ì„ íƒì„ ë¦¬ì…‹í•©ë‹ˆë‹¤.\ní¬ì§€ì…˜ ë½‘ê¸°ë¥¼ ë‹¤ì‹œ í•˜ê³  ì‹¶ë‹¤ë©´ 'ì˜ˆ' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.")) {
    goBackFromDrawModal();
  }
}

function loadSavedDrawResult() {
  const data = localStorage.getItem("savedDrawResult");
  if (!data) return;

  const parsed = JSON.parse(data);
  populateMatchTable("match2A", parsed.A || []);
  populateMatchTable("match2B", parsed.B || []);
  populateMatchTable("match2C", parsed.C || []);
}


function populateMatchTable(tableId, players) {
  const tbody = document.getElementById(tableId)?.querySelector("tbody");
  if (!tbody) return;

  let rows = "";
  players.forEach(player => {
    rows += `<tr><td>${player.name}</td><td>${player.position}</td></tr>`;
  });

  tbody.innerHTML = rows;
}


function debugAddRandomAttendance() {
  if (memberList.length === 0) {
    alert("ë¨¼ì € íšŒì› ëª…ë‹¨ì„ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤.");
    return;
  }

  // âœ… ì¶œì„ í…Œì´ë¸” ì—†ìœ¼ë©´ ë¨¼ì € ìƒì„±
  if (!document.getElementById("selectedTable")) {
    loadRankedAttendance();
  }

  const candidates = [...memberList]
    .filter(m => !selectedNames.includes(`${m.name}__${m.team || ""}`));

  if (candidates.length < 27) {
    alert("ë‚¨ì€ íšŒì›ì´ 27ëª…ë³´ë‹¤ ì ìŠµë‹ˆë‹¤.");
    return;
  }

  // ëœë¤ 27ëª… ì„ íƒ
  const shuffled = candidates.sort(() => Math.random() - 0.5).slice(0, 27);

  shuffled.forEach(m => {
    const key = `${m.name}__${m.team || ""}`;
    selectedNames.push(key);
  });

  updateSelectOptions(document.querySelectorAll(".name-select"));
  renderSelectedTable();
  updateSummary();

  alert("ëœë¤ 27ëª…ì´ ì¶œì„ ëª…ë‹¨ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
}
function showTeamAddForm() {
  const container = document.getElementById("teamAddArea");
  container.innerHTML = "";

  // ì„±ëª… ì„ íƒ ë“œë¡­ë‹¤ìš´ì— í‘œì‹œí•  ì´ë¦„ í•„í„°
  const currentNames = Object.keys(confirmedSelections);

  // íŒ€ í…Œì´ë¸”ì— ì´ë¯¸ ì¶”ê°€ëœ ì´ë¦„ë„ í™•ì¸
  const allAssignedNames = [
    ...(window.matchTeamAssignments?.teamA || []).map(p => p.name),
    ...(window.matchTeamAssignments?.teamB || []).map(p => p.name),
    ...(window.matchTeamAssignments?.teamC || []).map(p => p.name),
  ];

  // âœ… íŒ€ ì„ íƒ ì˜µì…˜ êµ¬ì„± (ì˜¤ë¥˜ í•´ê²°)
  const teamOptions = [];
  if (window.matchTeamAssignments?.teamA?.length > 0) teamOptions.push("AíŒ€");
  if (window.matchTeamAssignments?.teamB?.length > 0) teamOptions.push("BíŒ€");
  if (window.matchTeamAssignments?.teamC?.length > 0) teamOptions.push("CíŒ€");

  // ì„±ëª… ì„ íƒ ë“œë¡­ë‹¤ìš´
const nameSelect = document.createElement("select");
nameSelect.style.marginRight = "10px";
nameSelect.style.fontSize = "1.1rem";
nameSelect.style.height = "2rem";
nameSelect.style.lineHeight = "2rem";

nameSelect.innerHTML = `<option value="">-- ì„±ëª… ì„ íƒ --</option>`;
memberList.forEach(m => {
  const att = getAttendanceStatus(m.name);
const isValid =
  (!att || (att.late !== true && att.leave !== true && att.present !== true)) &&
  !allAssignedNames.includes(m.name);
  if (isValid) {
    const label = getDisplayName(m.name);
    nameSelect.innerHTML += `<option value="${m.name}">${label}</option>`;
  }
});
nameSelect.innerHTML += `<option value="__ë¹„íšŒì›__">â• ë¹„íšŒì› ì¶”ê°€</option>`;

nameSelect.addEventListener("change", () => {
  if (nameSelect.value === "__ë¹„íšŒì›__") {
    const manualInput = prompt("ë¹„íšŒì› ì„±ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:");
    if (!manualInput) {
      nameSelect.value = "";
      return;
    }
    if ([...nameSelect.options].some(opt => opt.value === manualInput)) {
      alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.");
      nameSelect.value = "";
      return;
    }
    nameSelect.innerHTML += `<option value="${manualInput}">${manualInput}</option>`;
    nameSelect.value = manualInput;
  }
});

  // íŒ€ ì„ íƒ ë“œë¡­ë‹¤ìš´
  const teamSelect = document.createElement("select");
  teamSelect.style.marginRight = "10px";
  teamSelect.style.fontSize = "1.1rem";
  teamSelect.style.height = "2rem";
teamSelect.style.lineHeight = "2rem";
  teamSelect.innerHTML = `<option value="">-- íŒ€ ì„ íƒ --</option>`;
  teamOptions.forEach(t => {
    teamSelect.innerHTML += `<option value="${t}">${t}</option>`;
  });

  // ì €ì¥ ë²„íŠ¼
  const saveBtn = document.createElement("button");
  saveBtn.textContent = "ì €ì¥";
  saveBtn.style.fontSize = "1.2rem";
  saveBtn.style.padding = "0.4rem 1rem";
  saveBtn.style.marginLeft = "1rem";
  saveBtn.onclick = () => {
    const name = nameSelect.value;
    const team = teamSelect.value;

    if (!name || !team) return alert("ì´ë¦„ê³¼ íŒ€ì„ ì„ íƒí•˜ì„¸ìš”.");

    const position = "ì§€ê°";
    confirmedSelections[name] = `${team} ${position}`;

// âœ… matchTeamAssignmentsì—ë„ ì¶”ê°€
const teamKey = team === "AíŒ€" ? "teamA" :
                  team === "BíŒ€" ? "teamB" :
                  team === "CíŒ€" ? "teamC" : null;
  if (!window.matchTeamAssignments[teamKey]) window.matchTeamAssignments[teamKey] = [];
  window.matchTeamAssignments[teamKey].push({ name, position });


  // âœ… ì´ ë¶€ë¶„ ì¶”ê°€
  if (!window.finalTeamResults) window.finalTeamResults = {};
  if (!finalTeamResults[team]) finalTeamResults[team] = [];

  finalTeamResults[team].push({ name, position });
  localStorage.setItem("finalTeamResults", JSON.stringify(finalTeamResults));
    if (name !== "__ë¹„íšŒì›__") {
  if (!window.attendanceHistoryData) window.attendanceHistoryData = {};
  const dateKeys = Object.keys(attendanceHistoryData || {});
if (dateKeys.length === 0) return alert("ì¶œì„ ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");

const dateKey = dateKeys.sort().pop();
const data = attendanceHistoryData[dateKey];
  const existing = data.find(p => p.name === name);
  if (existing) {
    existing.leave = false;
    existing.late = true;
  } else {
    data.push({
      name,
      rank: data.length + 1,
      late: true,
      leave: false,
      isNonMember: false,
      score: 5
    });
  }
} else {
  // âœ… ë¹„íšŒì› ì²˜ë¦¬
  if (!window.attendanceHistoryData) window.attendanceHistoryData = {};
  const dateKey = Object.keys(attendanceHistoryData).sort().pop();
  if (!attendanceHistoryData[dateKey]) attendanceHistoryData[dateKey] = [];
  const data = attendanceHistoryData[dateKey];
  data.push({
    name,
    rank: data.length + 1,
    late: true,
    leave: false,
    isNonMember: true,
    score: 5
  });


      localStorage.setItem("attendanceHistoryData", JSON.stringify(attendanceHistoryData));
    }

    alert("ì„ íƒëœ ì‚¬ëŒì´ ì§€ê°ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
    updateLiveResultTable();
    displayFinalTeamResults();
    container.innerHTML = "";
  };

  // ë‹«ê¸° ë²„íŠ¼
const closeBtn = document.createElement("button");
closeBtn.textContent = "ë‹«ê¸°";
closeBtn.style.fontSize = "1.2rem";
closeBtn.style.padding = "0.4rem 1rem";
closeBtn.style.marginLeft = "1rem";
closeBtn.style.cursor = "pointer";
closeBtn.onclick = () => container.innerHTML = "";

  container.appendChild(nameSelect);
  container.appendChild(teamSelect);
  container.appendChild(saveBtn);
  container.appendChild(closeBtn);
}


function getAttendanceStatus(name) {
  if (!window.attendanceHistoryData) return null;

  const dateKey = Object.keys(attendanceHistoryData).sort().pop();
  const attendanceList = attendanceHistoryData[dateKey];
  if (!attendanceList) return null;

  const record = attendanceList.find(p => p.name === name);
  if (!record) return null;

  return {
    late: record.late,
    leave: record.leave
  };
}

function updateTeamAssignmentTables() {
  const teamMap = {
    teamA: { tableId: "teamA-table", color: "#fff9c4" }, // ì—°ë…¸ë‘
    teamB: { tableId: "teamB-table", color: "#ffe0b2" }, // ì—°ì£¼í™©
    teamC: { tableId: "teamC-table", color: "#e1f5fe" }  // ì—°íŒŒë‘ (ì¶”ê°€)
  };

  const createRow = (player, index, bgColor) => `
    <tr style="background-color: ${bgColor};">
      <td>${index + 1}</td>
      <td>${player.name}</td>
      <td>${player.position || ""}</td>
      <td><button onclick="markEarlyLeave('${player.name}')">ì¡°í‡´</button></td>
    </tr>
  `;

  for (const [teamKey, info] of Object.entries(teamMap)) {
    const table = document.getElementById(info.tableId);
    if (!table) continue;

    table.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ë¹„ìš°ê¸°

    const players = window.matchTeamAssignments[teamKey] || [];
    players.forEach((player, index) => {
      table.insertAdjacentHTML("beforeend", createRow(player, index, info.color));
    });

    // CíŒ€ ë¹„ì—ˆì„ ê²½ìš° wrapper ìˆ¨ê¸°ê¸°
    if (teamKey === "teamC") {
      const wrapper = document.getElementById("teamC-wrapper");
      if (wrapper) wrapper.style.display = players.length === 0 ? "none" : "block";
    }
  }
}


function movePlayerToTeam() {
  const name = document.getElementById("moveNameSelect").value;
  const newTeam = document.getElementById("moveTeamSelect").value;

  if (!name || !newTeam) {
    alert("ì´ë¦„ê³¼ ì´ë™í•  íŒ€ì„ ëª¨ë‘ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  if (!window.finalTeamResults) {
    console.error("âŒ finalTeamResultsê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // í˜„ì¬ ì†í•œ íŒ€ ì°¾ê¸°
  let currentTeam = null;
  for (const team in finalTeamResults) {
    if (finalTeamResults[team].some(player => player.name === name)) {
      currentTeam = team;
      break;
    }
  }

  if (!currentTeam) {
    alert("ì„ íƒí•œ ì´ë¦„ì´ ì–´ë–¤ íŒ€ì—ë„ ì†í•´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  if (currentTeam === newTeam) {
    alert("ê°™ì€ íŒ€ìœ¼ë¡œëŠ” ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // ê¸°ì¡´ íŒ€ì—ì„œ í•´ë‹¹ ì„ ìˆ˜ ì œê±°
  const currentList = finalTeamResults[currentTeam];
  const playerIndex = currentList.findIndex(player => player.name === name);
  if (playerIndex === -1) {
    alert("ì„ ìˆ˜ë¥¼ ê¸°ì¡´ íŒ€ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const player = currentList.splice(playerIndex, 1)[0]; // ê¸°ì¡´ íŒ€ì—ì„œ ì œê±°

  // ìƒˆë¡œìš´ íŒ€ì— ì¶”ê°€ (ìˆœë²ˆ ìœ ì§€)
  if (!finalTeamResults[newTeam]) finalTeamResults[newTeam] = [];

  // insertIndex ê²°ì •: ë™ì¼í•œ í¬ì§€ì…˜ ì¤‘ ë§ˆì§€ë§‰ ìœ„ì¹˜ ë‹¤ìŒ
  const targetList = finalTeamResults[newTeam];
  const samePositionIndex = targetList.map(p => p.position).lastIndexOf(player.position);
  const insertIndex = samePositionIndex >= 0 ? samePositionIndex + 1 : targetList.length;

  targetList.splice(insertIndex, 0, player);

  localStorage.setItem("finalTeamResults", JSON.stringify(finalTeamResults));
  displayFinalTeamResults();

  console.log("âœ… ì´ë™ ì™„ë£Œ:", name, "ğŸ‘‰", newTeam);
}


function showTeamChangeForm() {
  const container = document.getElementById("teamChangeContainer");
  if (!container) return console.error("âŒ teamChangeContainer ìš”ì†Œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");

  let formArea = container.querySelector(".form-area");
  if (!formArea) {
    formArea = document.createElement("div");
    formArea.className = "form-area";
    container.appendChild(formArea);
  }

  formArea.innerHTML = "";

  // âœ… ì¡°í‡´ ì•„ë‹Œ ì¸ì›ë§Œ ì¶”ì¶œ (confirmedSelections ê¸°ì¤€)
  const validNames = Object.entries(confirmedSelections)
    .filter(([_, val]) => !val.includes("ì¡°í‡´"))
    .map(([name]) => name);

  // âœ… íŒ€ ëª©ë¡ + confirmedSelections ë³‘í•©í•˜ì—¬ ì´ë¦„ ìˆ˜ì§‘
  const allAssigned = [
    ...(window.matchTeamAssignments?.teamA || []),
    ...(window.matchTeamAssignments?.teamB || []),
    ...(window.matchTeamAssignments?.teamC || []),
  ];
  const allNames = [...new Set([
    ...allAssigned.map(p => p.name),
    ...Object.keys(confirmedSelections)
  ])];

  const selectableNames = allNames.filter(name => validNames.includes(name));

  // âœ… ì´ë¦„ ë“œë¡­ë‹¤ìš´
  const nameSelect = document.createElement("select");
  nameSelect.style.fontSize = "1.2rem";
  nameSelect.style.marginRight = "2rem";
  nameSelect.style.height = "2rem";
nameSelect.style.lineHeight = "2rem";
  nameSelect.innerHTML = "<option value=''>-- ì´ë¦„ ì„ íƒ --</option>";
  selectableNames.forEach(n => {
    nameSelect.innerHTML += `<option value="${n}">${getDisplayName(n)}</option>`;
  });

  // âœ… íŒ€ ë“œë¡­ë‹¤ìš´
  const teamSelect = document.createElement("select");
  teamSelect.style.fontSize = "1.2rem";
  teamSelect.style.marginRight = "2.5rem";
  teamSelect.style.height = "2rem";
teamSelect.style.lineHeight = "2rem";
  teamSelect.innerHTML = "<option value=''>-- íŒ€ ì„ íƒ --</option>";
  if ((window.matchTeamAssignments?.teamA || []).length > 0) teamSelect.innerHTML += `<option value="AíŒ€">AíŒ€</option>`;
  if ((window.matchTeamAssignments?.teamB || []).length > 0) teamSelect.innerHTML += `<option value="BíŒ€">BíŒ€</option>`;
  if ((window.matchTeamAssignments?.teamC || []).length > 0) teamSelect.innerHTML += `<option value="CíŒ€">CíŒ€</option>`;

  // âœ… ì´ë™ ë²„íŠ¼
  const confirmButton = document.createElement("button");
  confirmButton.textContent = "ì´ë™";
  confirmButton.style.fontSize = "1.2rem";
  confirmButton.style.padding = "0.4rem 1rem";
  confirmButton.style.cursor = "pointer";
  confirmButton.onclick = () => {
    const selectedName = nameSelect.value;
    const selectedTeam = teamSelect.value;
    if (selectedName && selectedTeam) {
      movePlayerToTeam(selectedName, selectedTeam);
      displayFinalTeamResults();  // ê²°ê³¼ ë°˜ì˜
    }
  };

  // âœ… ë‹«ê¸° ë²„íŠ¼
  const closeBtn = document.createElement("button");
  closeBtn.textContent = "ë‹«ê¸°";
  closeBtn.style.fontSize = "1.2rem";
  closeBtn.style.padding = "0.4rem 1rem";
  closeBtn.style.marginLeft = "1rem";
  closeBtn.style.cursor = "pointer";
  closeBtn.onclick = () => formArea.innerHTML = "";

  // âœ… ë Œë”ë§
  container.appendChild(nameSelect);
container.appendChild(teamSelect);
container.appendChild(confirmButton);
container.appendChild(closeBtn);

}

function getTeamColorClass(team) {
  if (team === "AíŒ€") return "team-a";
  if (team === "BíŒ€") return "team-b";
  if (team === "CíŒ€") return "team-c";
  return "";
}





    </script>
<!-- ì„ íƒ ëª¨ë‹¬ (ìˆ˜ì • í›„ ë²„ì „) -->
<div id="selectionModal" style="
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background-color: rgba(0,0,0,0.6);
  z-index:1001;
  justify-content: flex-start;  /* ì¤‘ì•™ â†’ ìƒë‹¨ */
  align-items: flex-start;
  padding: 4rem 2rem;
  box-sizing: border-box;
  overflow-y: auto;
">
  <div style="background:white; padding:2rem; border-radius:10px; max-width:90%; text-align:center;">
    <h3>ì¶”ì²¨ ê²°ê³¼</h3>
    <div id="modalOptions" style="display:flex; gap:1rem; justify-content:center; flex-wrap:wrap; margin-top:1rem;"></div>
  </div>
</div>

<!-- í¬ì§€ì…˜ ë½‘ê¸° ëª¨ë‹¬ -->
<div id="drawModalOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
  background-color: rgba(0,0,0,0.6); z-index:1000; overflow:auto; justify-content: center; align-items: center;
">

<div style="
background: white;
width: 100%;
height: 100%;
padding: 2rem;
border-radius: 0;
overflow-y: auto;
display: flex;
flex-direction: column;
align-items: center;
gap: 1.5rem;
box-sizing: border-box;">


    <!-- ì œëª© -->
    <h2 style="font-size: 1.4em; font-weight: bold; margin-bottom: 0.4rem;">
      âœ‰ï¸ ë½‘ê¸° ìˆœì„œ
    </h2>
    

    <!-- í…Œì´ë¸” ìŠ¤íƒ€ì¼ ìˆ˜ì • -->
<table style="
font-size: 1.4rem;             /* ê¸°ì¡´ë³´ë‹¤ ì‚´ì§ í‚¤ì›€ */
border-collapse: collapse;
border: 1px solid #ccc;
min-width: 300px;
text-align: center;            /* âœ… ê°€ìš´ë° ì •ë ¬ */
margin-bottom: 0.3rem;         /* ì œëª©ê³¼ì˜ ê°„ê²© ì¡°ì • */
">
      <thead style="background-color: #f9f9f9;">
        <tr>
          <th style="padding: 0.4rem 0.8rem;">ìˆœìœ„</th>
          <th style="padding: 0.4rem 0.8rem;">ì´ë¦„</th>
          <th style="padding: 0.4rem 0.8rem;">íˆ¬í‘œê¶Œ</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td id="drawRankCell">-</td>
          <td id="drawNameCell">-</td>
          <td id="drawVoteCell">-</td>
        </tr>
      </tbody>
    </table>

    <!-- ìª½ì§€ ì˜ì—­ -->
    <div id="envelopeArea" style="
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.3rem;
      margin-bottom: 1rem;
      max-width: 100%;
    "></div>

    <!-- ê²°ê³¼ í…Œì´ë¸” -->
    <div id="liveResultTable" style="
      display: flex;
  flex-direction: row;
  flex-wrap: nowrap;
  overflow-x: auto;
  white-space: nowrap;
  gap: 0.8rem;
  width: 90%;
  justify-content: flex-start;
  align-items: flex-start;
">
      <!-- A/BíŒ€ í…Œì´ë¸”ì´ ì—¬ê¸°ì— ì‚½ì…ë¨ -->
    </div>

    <!-- ë²„íŠ¼ ì˜ì—­ -->
    <div style="display: flex; justify-content: center; gap: 0.8rem; flex-wrap: wrap;">
      <button onclick="redoSelection()" style="padding: 0.6rem 1.2rem;">â†©ï¸ ë‹¤ì‹œ ì„ íƒ</button>
      <button onclick="confirmResetDrawModal()" style="padding: 0.6rem 1.2rem;">ğŸ”„ ë¦¬ì…‹</button>
    </div>
  </div>
</div>
</div>
<script>
  function updateSelectedFileName(input) {
    const display = document.getElementById("fileNameDisplay");
    if (input.files.length > 0) {
      display.textContent = input.files[0].name;
    } else {
      display.textContent = "ì„ íƒëœ íŒŒì¼ ì—†ìŒ";
    }
  }
</script>

<!-- âœ… ë„“ì€ í­ ì ìš© -->
<div id="resultModalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 9999;">
  <div id="resultModalContent" style="background: white; width: 80vw; max-height: 80%; overflow-y: auto;
    padding: 1.5rem; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.4); text-align: center;">
    <button onclick="closeResultModal()" style="float: right; margin-bottom: 1rem;">ë‹«ê¸°</button>
    <div id="resultModalBody"></div>
  </div>
</div>


</body>
</html>