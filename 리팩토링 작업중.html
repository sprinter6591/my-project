<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì œìŠ¤íŠ¸ ì¶œì„ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <!-- âœ… XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
   <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* âœ… ì „ì²´ í˜ì´ì§€ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    body {
      font-family: 'GmarketSans', sans-serif;
      padding: 1.2rem;
      overflow-x: hidden;
      max-width: 100%;
      margin: 0;
      background-color: #f2f2f2;
    }
    .container {
      width: 100%;
      max-width: 500px; /* ëª¨ë°”ì¼ ê¸°ì¤€ ë„ˆë¹„ ì¡°ì • */
      margin: 0 auto;
    }

    /* âœ… íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .tab-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 1rem;
    }
  
    .tab-buttons button {
      flex: 1;
      white-space: nowrap;
      padding: 0.6rem 1rem;
      font-size: clamp(0.9rem, 1.8vw, 1.2rem);
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-weight: bold;
      line-height: 1.2;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }
  
    /* âœ… ê° íƒ­ ë²„íŠ¼ ìƒ‰ìƒ */
    .tab-buttons button:nth-child(1) { background-color: #A3B18A; } /* ì—°ë…¹ìƒ‰ */
    .tab-buttons button:nth-child(2) { background-color: #6C91BF; } /* ì—°íŒŒë‘ */
    .tab-buttons button:nth-child(3) { background-color: #D8A7A7; } /* ì—°í•‘í¬ */
    .tab-buttons button:nth-child(4) { background-color: #E5C07B; } /* ì—°ë…¸ë‘ */
    .tab-buttons button:nth-child(5) { background-color: #A67B5B; } /* ì—°ê°ˆìƒ‰ */


    /* âœ… íƒ­ ë²„íŠ¼ í™œì„±í™” íš¨ê³¼ */
    .tab-buttons button:hover {
      background-color: #45a049;
    }
    .tab-buttons button.active {
      filter: contrast(1.2) saturate(1.5);     /* ìƒ‰ê° ì§„í•˜ê²Œ */
      transform: scale(1.02) translateY(-1px); /* ì•½ê°„ ìœ„ë¡œ ì˜¬ë¼ì˜¤ê²Œ */
      color: rgb(14, 12, 12) !important;

      /* âœ… ì…ì²´ê° ì£¼ëŠ” ê·¸ë¦¼ì íš¨ê³¼ */
      box-shadow: 
        0 4px 6px rgba(0, 0, 0, 0.541),         /* ë°”ê¹¥ ê·¸ë¦¼ì â†’ ë–  ìˆëŠ” ëŠë‚Œ */
        inset 0 1px 0 rgba(255, 255, 255, 0.6);/* ì•ˆìª½ ë¹› ë°˜ì‚¬ íš¨ê³¼ â†’ ë³¼ë¥¨ê° */
      border: none; /* ê²€ì • í…Œë‘ë¦¬ ì œê±° */
    }

    /* âœ… íƒ­ ì½˜í…ì¸  ì˜ì—­ */
    .tab {
      display: none;
      padding: 1rem;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .tab.active {
      display: block;
    }
  
    h2 {
      margin-top: 0;
    }
  
    .member-table input[type="text"] {
      font-size: 0.7rem;
      padding: 2px 4px;
    }

    .name-input {
      width: 50%;
    }

    .affiliation-input {
      width: 90%;
    }

    .member-table {
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      border-radius: 8px;
      overflow: hidden;
      font-size: 0.85rem;
    }

    .member-table thead {
      background-color: #f4f6f8;
      color: #333;
    }

    .member-table th, .member-table td {
      padding: 6px 8px;
      text-align: center;
      border-bottom: 1px solid #e0e0e0;
    }

    .member-table th:nth-child(1),
    .member-table td:nth-child(1) {
    width: 32px;      /* ìˆœë²ˆ */
    max-width: 32px;
    font-size: 0.8rem;
    padding: 4px;
    }

    .member-table th:nth-child(2),
    .member-table td:nth-child(2) {
      width: auto;
      max-width: none;
      padding: 0.6rem;
      font-size: 1rem;
      white-space: nowrap;
    }


    .member-table th:nth-child(3),
    .member-table td:nth-child(3) {
      width: auto;      /* ì†Œì†ì€ ë‚˜ë¨¸ì§€ ê³µê°„ ì‚¬ìš© */
    }

    .member-table tr:hover {
      background-color: #f9f9f9;
    }


    /* âœ… ì¶œì„ë¶€ íƒ­ ìŠ¤íƒ€ì¼ */
    #attendanceTab select,
    #attendanceTab button {
      font-size: 1.3rem;
      padding: 0.6rem 1rem;
    }
    #attendanceTab button {
      padding: 0.8rem 1.2rem;
    }
    #attendanceSummary {
      font-size: 1.2rem;
      line-height: 1.8rem;
    }
  
    /* âœ… ê²½ê¸° í¸ì„± íƒ­ ìŠ¤íƒ€ì¼ */
    #matchTab {
      font-size: 1.3rem;
      line-height: 1.9rem;
    }
    #matchTab input,
    #matchTab select,
    #matchTab button {
      font-size: 1.3rem;
      padding: 0.6rem 1rem;
    }
    #matchTab button {
      padding: 0.8rem 1.2rem;
    }
    #matchResult {
      font-size: 1.2rem;
      line-height: 1.8rem;
    }
    #suggestA, #suggestB {
      font-size: 1.56rem;
      font-weight: bold;
    }
        /* âœ… í¬ì§€ì…˜ ë½‘ê¸°ìš© ìª½ì§€ ìŠ¤íƒ€ì¼ */
    .envelope-box {
      aspect-ratio: 16 / 9;              /* ğŸ“ ê°€ë¡œê°€ ê¸´ ì§ì‚¬ê°í˜• */
      flex: 1 0 calc((100% - 35px) / 7); /* âœ… 8ê°œì”© ë°°ì¹˜, ê°„ê²© í¬í•¨ ê³„ì‚° */
      max-width: calc((100% - 35px) / 7);
      height: auto;                      /* aspect-ratioì— ì˜í•´ ìë™ ê²°ì •ë¨ */
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      font-weight: bold;
      background-color: #f5f5f5;
      border: 1px solid #aaa;
      border-radius: 6px;
      margin: 1px;                     /* ê°€ë¡œ/ì„¸ë¡œ ê°„ê²© 5px â†’ ì ˆë°˜ ì ìš© */
      cursor: pointer;
      transition: transform 0.2s ease-in-out;
    }
    .envelope.selected {
      background-color: #ccc;
      color: #999;
      border: 2px solid #aaa;
      cursor: not-allowed;
    }
    .envelope-box:hover {
      transform: scale(1.05);
      background-color: #e0e0e0;
    }
    .selection-note {
  position: relative;
  width: 80px;
  height: 80px;
  font-size: 1.1rem;
  border: 1px solid #bbb;
  border-radius: 10px;
  background-color: white;
  text-align: center;
  padding: 0.5rem;
  overflow: hidden;
}

.selection-note::before {
  content: attr(data-icon);
  position: absolute;
  font-size: 3.5rem;
  opacity: 0.15;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
}

    #envelopeArea {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 2px;
    }
  
    /* âœ… íŒ€êµ¬ë¶„ ê²°ê³¼ í…Œì´ë¸” */
    #teamDivisionResult table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      font-size: 1.2rem;
      margin-bottom: 1.5rem;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 5px rgba(0,0,0,0.15);
    }
    #teamDivisionResult th, #teamDivisionResult td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    #teamDivisionResult th {
      background-color: #f0f0f0;
    }
    .team-a-color { background-color: #fff9c4; }
    .team-b-color { background-color: #ffe0b2; }
    .team-c-color { background-color: #bbdefb; }
  
    /* âœ… ì¸ì› ì¶”ê°€ ë° ì‹¤ì‹œê°„ í…Œì´ë¸” */
    #teamAddArea {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    #liveResultTable {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      width: 100%;
      box-sizing: border-box;
      padding: 1rem;
    }
  
    /* âœ… ê¸°íƒ€ ìœ í‹¸ ìš”ì†Œë“¤ */
    .name-select {
      background-color: #fffde7;
      font-size: 1.1rem;
      padding: 0.5rem 0.8rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      min-width: 200px;
      transition: background-color 0.3s ease;
      line-height: 1.3;
    }


    .name-select.flash {
      background-color: #e0ffe0;
    }

    .delete-btn {
      padding: 0.3rem 0.6rem;
      font-size: 0.85rem;
      background-color: #ffebee;
      border: 1px solid #e57373;
      border-radius: 4px;
      cursor: pointer;
      color: #d32f2f;
    }

    .delete-btn:hover {
      background-color: #ffcdd2;
    }

    .team-wrapper {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  align-items: center;
}
#modalOptions {
  display: flex;
  flex-wrap: nowrap;
  justify-content: center;
  gap: 1rem;
  margin-top: 1rem;
}

#modalOptions button {
  white-space: normal;
  width: 90px;
  height: 60px;
  font-size: 1rem;
}

/* ì¢Œìš°ë¡œ ë‚˜ë€íˆ */
.row-ab {
  display: flex;
  flex-wrap: wrap;       /* âœ… í™”ë©´ì´ ì¢ìœ¼ë©´ ì¤„ ë°”ê¿ˆ */
  gap: 0.4rem;
  align-items: flex-start;
  justify-content: space-between; /* âœ… ì—¬ë°± ì œê±° */
}

/* CíŒ€ì€ AíŒ€ ì•„ë˜ ì •ë ¬ */
.row-c {
  margin-top: 1rem;
  display: flex;
}

.team-box {
  flex: 1 1 48%;;
  min-width: 48%;
  max-width: 48%;
  box-sizing: border-box;
  padding: 0.3rem;
  border-radius: 8px;
  background-color: transparent; /* âœ… ë°”ê¹¥ ë°°ê²½ ì œê±° */
}
/* CíŒ€ì€ ì™¼ìª½ ì •ë ¬ë˜ë„ë¡ */
.row-c .team-box {
  margin-left: 0;  /* í•„ìš”ì‹œ ì—¬ë°± ì¡°ì ˆ */
}
/* í…Œì´ë¸” ë‚´ë¶€ ìƒ‰ìƒ ì ìš© */
.team-box table {
  width: 100%;
  border-collapse: collapse;
  background-color: #fff9c4; /* AíŒ€ìš© (JSì—ì„œ ë™ì ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥) */
  border-radius: 8px;
  overflow: hidden;
  font-size: 0.9rem; /* âœ… ê¸€ì”¨ ì¤„ì´ê¸° */
}

/* í…Œì´ë¸” ì œëª© ì¤„ */
.team-title {
  background-color: transparent;
  font-size: 1rem;
  font-weight: bold;
  text-align: center;
  margin: 0.4rem 0;
}
.control-cell {
  display: none;
}
.control-mode-active .control-cell {
  display: table-cell !important;
}
.diagonal-box {
  position: relative;
  width: 110px;
  height: 70px;
  border: 1px solid #ccc;
  border-radius: 10px;
  overflow: hidden;
  font-weight: bold;
  box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
  cursor: pointer;
  box-sizing: border-box;
  padding: 0;

  opacity: 0;
  transform: translateY(20px);
  animation: fadeSlideIn 0.4s ease forwards;
}
td, th {
  white-space: nowrap;  /* âœ… ì¤„ë°”ê¿ˆ ë°©ì§€ */
  text-align: center;
  padding: 0.4rem;
}

/* ì¢Œìƒë‹¨: íŒ€ */
.diagonal-box .team {
  position: absolute;
  top: 8px;
  left: 10px;
  font-size: 1.4rem;
  color: #111;
}

/* ìš°í•˜ë‹¨: í¬ì§€ì…˜ */
.diagonal-box .position {
  position: absolute;
  bottom: 8px;
  right: 10px;
  font-size: 1rem;
  color: #444;
}

/* ì€ì€í•œ ë°°ê²½ íš¨ê³¼ */
.diagonal-box::before {
  content: attr(data-icon);
  position: absolute;
  font-size: 2.7rem;
  opacity: 0.27;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
}

/* ì• ë‹ˆë©”ì´ì…˜ ì •ì˜ */
@keyframes fadeSlideIn {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

  
    /* âœ… ì¡°í‡´ í…Œì´ë¸” */
    #lateStatusTable {
      margin-top: 2rem;
      background: white;
      border-collapse: collapse;
      border: 1px solid #ddd;
    }
    #lateStatusTable th, #lateStatusTable td {
      padding: 8px;
      text-align: center;
      border: 1px solid #ddd;
    }
  
    /* âœ… ì¶œì„ë¶€ ì„ íƒ í…Œì´ë¸” ë†’ì´ ì¡°ì • */
    #selectedTable tr {
      height: 48px;
    }
    #selectedTable thead th {
      position: sticky;
      top: 0;
      background-color: #f0f8ff;
      z-index: 1;
    }
  </style>
</head>

<body>

  <!-- íƒ­ ë²„íŠ¼ -->
  <div class="tab-buttons" id="tabButtons">
    <button onclick="showTab('attendanceTab')">ì¶œì„ë¶€</button>
    <button id="teamTabButton" onclick="showTab('teamTab')" style="display:none;">íŒ€êµ¬ë¶„</button>
    <button id="matchTabButton" onclick="showTab('matchTab')" style="display:none;">ê²½ê¸°<br>í¸ì„±<br>1ê²½ê¸°</button>
    <button id="matchSetup2Button" onclick="showTab('matchSetup2')" style="display:none;">ê²½ê¸°<br>í¸ì„±<br>2-4ê²½ê¸°</button>
  <button onclick="showTab('memberTab')">íšŒì›<br>ê´€ë¦¬</button>
  </div>

  <!-- ì¶œì„ë¶€ íƒ­ -->
  <div id="attendanceTab" class="tab active">
  
    <!-- ì œëª© ì˜¤ë¥¸ìª½ì— ë‚ ì§œ ì„ íƒ UIë¥¼ ë°°ì¹˜ -->
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h2 style="display: none;">ì¶œì„ë¶€</h2>
      <div style="display: flex; align-items: center; gap: 6px;">
      <select id="yearSelect" style="width: 100px;"></select>
      <select id="monthSelect" style="width: 85px;"></select>
      <select id="daySelect" style="width: 100px;"></select>
      <span id="weekdayDisplay" style="font-weight: bold;"></span>
      </div>
    </div>

      <!-- ìˆœìœ„ë³„ ì„±ëª… ì„ íƒ ë° ì§€ê°/ì¡°í‡´ ì²´í¬ -->
    <div style="margin-top: 1rem;">
      <!-- ì¶œì„ ëª…ë‹¨ ë§Œë“¤ê¸° ë²„íŠ¼ - ì‚´ì§ íŒŒë€ ê³„ì—´ë¡œ ë³€ê²½ -->
      <div style="display: flex; gap: 10px; margin-top: 1rem;">
        <button 
          onclick="loadRankedAttendance()" 
          style="background-color: #cce5ff; color: #003366; padding: 0.4rem 0.8rem; font-size: 1rem;">
          ì¶œì„ ëª…ë‹¨ ìƒì„±
        </button>
        <button 
          onclick="confirmAndClearAttendance()" 
          style="background-color: #ffe5e5; color: #663333; padding: 0.4rem 0.8rem; font-size: 1rem;">
          ì¶œì„ ëª…ë‹¨ ì‚­ì œ
        </button>
      </div>

      <!-- ğŸ§ª [ê°œë°œììš©] ëœë¤ ì¶œì„ ì¶”ê°€ ë²„íŠ¼ë“¤ -->
      <div style="margin-top: 1rem; display: flex; gap: 1rem;">
        <button onclick="debugAddRandomAttendance(27)" style="padding: 0.6rem 1.2rem; background-color: #eee;">
          ğŸ§ª ëœë¤ ì¶œì„ 27ëª… ì¶”ê°€
        </button>
        <button onclick="debugAddRandomAttendance(8)" style="padding: 0.6rem 1.2rem; background-color: #eee;">
          ğŸ§ª ëœë¤ ì¶œì„ 8ëª… ì¶”ê°€
        </button>
      </div>
    </div>

    <!-- ì¶œì„ ìˆ˜ë™ ì¶”ê°€ ë° ì¤‘ê°„ ì‚½ì… í¼ -->
    <div style="margin-top: 1rem; display: flex; gap: 10px; align-items: flex-start; flex-wrap: wrap;">
    
      <!-- ë¹„íšŒì› ìˆ˜ë™ ì…ë ¥ì°½ (ê¸°ë³¸ì€ ìˆ¨ê¹€) -->
      <input type="text" id="nonMemberInput" placeholder="ë¹„íšŒì› ì´ë¦„ ì…ë ¥"
        style="display: none; padding: 0.5rem; font-size: 1rem; min-width: 150px;" />

      <button id="middleInsertButton">ì¤‘ê°„ ì‚½ì…</button>
      <div id="attendanceList" style="margin-top: 1rem;"></div>

    </div>

    <div id="attendanceTableWrapper" style="
      max-height: 20rem;  /* âœ… ë†’ì´ ì œí•œ (6ëª… ì •ë„ì— ë§ì¶¤) */
      overflow-y: auto;
      margin-top: 1.1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.05);
    ">
      <table id="selectedTable" class="attendance-table" style="
        width: 100%;
        border-collapse: collapse;
        font-size: 1.1rem;
        min-width: 320px;
      ">
        <thead>
          <tr style="background-color: #f0f8ff;">
            <th style="width: 50px; text-align: center; padding: 0.6rem;">ìˆœ</th>
            <th style="text-align: center; padding: 0.6rem;">ì„±ëª…</th>
            <th style="width: 80px; text-align: center; padding: 0.6rem;">ì§€ê°</th>
            <th class="control-cell" style="width: 120px; text-align: center; padding: 0.6rem;">ì¡°ì‘</th>
          </tr>
        </thead>
        <tbody>
          <!-- JSì—ì„œ ìë™ ì±„ì›€ -->
        </tbody>
      </table>
    </div>

    <div id="attendanceControlBar" style="
  position: sticky;
  bottom: 0;
  background: white;
  padding: 0.6rem;
  border-top: 1px solid #ccc;
  box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
  display: flex;
  justify-content: center;
  gap: 1rem;
  z-index: 10;
  margin-top: 1rem;
">
  <button onclick="toggleReorderMode()" style="padding: 0.5rem 1rem;">ìˆœì„œ ë³€ê²½</button>
  <button onclick="toggleDeleteMode()" style="padding: 0.5rem 0.9rem;">ì‚­ì œ</button>
  <button onclick="saveAttendance()" style="
    padding: 0.5rem 1rem;
    background-color: #6fd972;
    color: white;
    border: none;
    border-radius: 5px;
    font-weight: bold;
    box-shadow: 1px 1px 3px rgba(13, 14, 12, 0.1);
  ">ğŸ’¾ ì €ì¥</button>
    </div>
  </div> 

  <!-- ê²½ê¸° í¸ì„± 2-4ê²½ê¸° íƒ­ -->
  <div id="matchSetup2" class="tab">
     <h2 style="text-align: center; margin-bottom: 1.5rem;">ê²½ê¸° í¸ì„± 2-4ê²½ê¸°</h2>
    
    <div style="display: flex; flex-direction: column; gap: 1rem; align-items: center;">
      <button id="drawTeamAButton" onclick="startTeamDraw('A')" 
      style="width: 90%; padding: 1.5rem; font-size: 1.4rem; background-color: #fff9c4; border: 1px solid #ccc; border-radius: 10px;">
      AíŒ€ ë½‘ê¸°
    </button>
    
    <button id="drawTeamBButton" onclick="startTeamDraw('B')" 
      style="width: 90%; padding: 1.5rem; font-size: 1.4rem; background-color: #ffe0b2; border: 1px solid #ccc; border-radius: 10px;">
      BíŒ€ ë½‘ê¸°
    </button>
    
    <button id="drawTeamCButton" onclick="startTeamDraw('C')" 
      style="width: 90%; padding: 1.5rem; font-size: 1.4rem; background-color: #e1f5fe; border: 1px solid #ccc; border-radius: 10px;">
      CíŒ€ ë½‘ê¸°
    </button>
    </div>
    <div id="matchDrawArea" style="margin-top: 2rem;"></div>
  </div>
  

  <!-- ê²½ê¸° í¸ì„± 1ê²½ê¸° íƒ­ -->
  <div id="matchTab" class="tab">
    <h2 style="display: none;">ê²½ê¸° í¸ì„± 1ê²½ê¸°</h2>

    <!-- ì¶œì„ ë‚ ì§œ ì„ íƒ + ì¶œì„ ì¸ì› ì ìš© -->
    <div style="margin-bottom: 1rem; display: flex; align-items: center;">
      <!-- ë²„íŠ¼ ìˆ¨ê¹€ -->
      <span style="font-weight: bold; font-size: 1.3rem;">1ê²½ê¸° ì°¸ê°€ì: <span id="matchTotal">0</span>ëª…</span>
      <button onclick="assignAllToATeam()" style="margin-left: 2rem; padding: 0.5rem 1rem; font-size: 1rem; background-color: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer;">
        1íŒ€ ë½‘ê¸°
      </button>
    </div>
  
    <!-- CíŒ€ ì¸ì› ì„¤ì • -->
    <div style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px;">
      <label style="font-weight: bold;">CíŒ€ ì¸ì› ìˆ˜:</label>
      <button onclick="adjustCCount(-1)" style="font-size: 1rem; padding: 0.3rem 0.5rem;">â–¼</button>
      <input type="number" id="matchCInput" value="0" min="0"
            style="width: 40px; padding: 2px; font-size: 1.3rem; text-align: center;" readonly>
      <button onclick="adjustCCount(1)" style="font-size: 1rem; padding: 0.3rem 0.5rem;">â–²</button>
    </div>


    <!-- AíŒ€ êµ¬ì—­ -->
    <div style="background-color: #fff9c4; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">

      <div id="matchAInfo" style="font-weight: bold; font-size: 1.4rem; display: flex; align-items: center;">
        <div>AíŒ€ ì¶œì„ ì¸ì›: <span id="matchACount">0</span>ëª…</div>
        <div style="margin: 0 1rem;">|</div>
        <div>íœ´ì‹: <span id="restACount">0</span>ëª…</div>
      </div>
    
      <div style="margin-top: 1rem; display: flex; align-items: center; gap: 10px;">
        <label style="font-weight: bold;">AíŒ€ ì„ ë°œ ì¸ì›:</label>
        <button onclick="adjustStarter('A', -1)" style="font-size: 1rem; padding: 0.3rem 0.5rem;">â–¼</button>
        <input type="number" id="matchAStarter" value="11" min="1"   style="width: 40px; padding: 2px; font-size: 1.3rem; text-align: center;">
        <button onclick="adjustStarter('A', 1)" style="font-size: 1rem; padding: 0.3rem 0.5rem;">â–²</button>
      </div>
  
      <div style="margin-top: 0.7rem;">
        <label style="display: none;"><strong>í¬ë©”ì´ì…˜ ì¶”ì²œ:</strong> <span id="suggestA" style="font-size: 1rem;"></span></label>
        <label><strong>AíŒ€ í¬ë©”ì´ì…˜:</strong></label>
        <select id="formationASelect" onchange="toggleCustomFormation('A')">
          <option value="">-- ì¶”ì²œ ì„ íƒ --</option>
        </select>
        <div id="formationACustom" style="display: none; margin-top: 0.5rem;">
          DF: <input type="number" id="dfA" value="0" min="0" max="9" style="width: 28px; padding: 0; text-align: center;" />
          MF: <input type="number" id="mfA" value="0" min="0" max="9" style="width: 28px; padding: 0; text-align: center;" />
          FW: <input type="number" id="fwA" value="0" min="0" max="9" style="width: 28px; padding: 0; text-align: center;" />
        </div>
        <div id="remainingA" style="margin-top: 0.5rem; font-weight: bold;"></div>
      </div>
    </div> <!-- âœ… AíŒ€ ìƒì ë‹«ê¸° -->
  
     <!-- âœ… BíŒ€ êµ¬ì—­ ì‹œì‘ -->
    <div style="background-color: #e0f7da; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
      <div id="matchBInfo" style="font-weight: bold; font-size: 1.4rem; display: flex; align-items: center;">
        <div>BíŒ€ ì¶œì„ ì¸ì›: <span id="matchBCount">0</span>ëª…</div>
        <div style="margin: 0 1rem;">|</div>
        <div>íœ´ì‹: <span id="restBCount">0</span>ëª…</div>
      </div>
  
      <!-- ì„ ë°œ ì¸ì› ì„¤ì • -->
      <div style="margin-top: 1rem; display: flex; align-items: center; gap: 10px;">
        <label style="font-weight: bold;">BíŒ€ ì„ ë°œ ì¸ì›:</label>
        <button onclick="adjustStarter('B', -1)" style="font-size: 1rem; padding: 0.3rem 0.5rem;">â–¼</button>
        <input type="number" id="matchBStarter" value="11" min="1" style="width: 40px; padding: 2px; font-size: 1.3rem; text-align: center;">
        <button onclick="adjustStarter('B', 1)" style="font-size: 1rem; padding: 0.3rem 0.5rem;">â–²</button>
      </div>

      <!-- í¬ë©”ì´ì…˜ ì„¤ì • -->
      <div style="margin-top: 0.7rem;">
        <label style="display: none;"><strong>í¬ë©”ì´ì…˜ ì¶”ì²œ:</strong> <span id="suggestB" style="font-size: 1rem;"></span></label>
        <label style="display: inline-block; margin-top: 1rem;"><strong>BíŒ€ í¬ë©”ì´ì…˜:</strong></label>
        <select id="formationBSelect" onchange="toggleCustomFormation('B')" style="margin-left: 10px;">
          <option value="">-- ì¶”ì²œ ì„ íƒ --</option>
        </select>

        <div id="formationBCustom" style="display: none; margin-top: 0.5rem;">
          DF: <input type="number" id="dfB" value="0" min="0" max="9" style="width: 28px; padding: 0; text-align: center;" />
          MF: <input type="number" id="mfB" value="0" min="0" max="9" style="width: 28px; padding: 0; text-align: center;" />
          FW: <input type="number" id="fwB" value="0" min="0" max="9" style="width: 28px; padding: 0; text-align: center;" />
        </div>

        <div id="remainingB" style="margin-top: 0.5rem; font-weight: bold;"></div>
      </div>
    </div> <!-- âœ… BíŒ€ ìƒì ë‹«í˜ (ì´ ìœ„ì¹˜ì— ì •í™•íˆ ìˆì–´ì•¼ í•¨) -->
  
     <!-- í¬ì§€ì…˜ ë½‘ê¸° -->
   <div style="margin: 2rem 0; text-align: center;">
      <button onclick="drawMatchPositions()" style='
        font-size: 1.5rem;
        padding: 1rem 2rem;
        border-radius: 50px;
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.2);'>
        âš½ í¬ì§€ì…˜ ë½‘ê¸°
      </button>
    </div>

  
   <!-- ê²°ê³¼ ì¶œë ¥ -->
    <div id="matchResult" style="margin-top: 1.5rem;"></div>
  </div> <!-- âœ… ì´ ì¤„ì´ í•µì‹¬: matchTab ë‹«ê¸° -->




  <!-- ë‹¤ìŒ íƒ­ -->
  <div id="teamTab" class="tab">
    <h2>íŒ€êµ¬ë¶„ ê²°ê³¼</h2>
    <!-- â›³ ì¸ì› ì¶”ê°€ ë²„íŠ¼ -->
   <div style="margin-top: 1rem; text-align: center; display: flex; justify-content: center; flex-wrap: wrap; gap: 0.5rem;">
      <button onclick="showTeamAddForm()" style="padding: 0.5rem 0.9rem; font-size: 1rem;">
        â• ì¸ì› ì¶”ê°€
      </button>
      <button onclick="showTeamChangeForm()" style="padding: 0.5rem 0.9rem; font-size: 1rem;">
        ğŸ”„ íŒ€ ë³€ê²½
      </button>
        <button onclick="showLeaveForm()" style="padding: 0.5rem 0.9rem; font-size: 1rem;">
      ğŸšª ì¡°í‡´ ì²˜ë¦¬
    </button>
      <div id="teamChangeContainer" style="margin-top: 1rem;"></div>
      
    </div>

    <!-- â›³ ì¸ì› ì¶”ê°€ í¼ì´ ë‚˜íƒ€ë‚  ì˜ì—­ -->
    <div id="teamAddArea" style="margin-top: 1rem;"></div>

    <!-- â›³ ê²°ê³¼ ì¶œë ¥ í…Œì´ë¸” -->
    <div id="teamDivisionResult" style="margin-top: 1rem;"></div>
  </div>

  <div id="memberTab" class="tab">
    <h2>íšŒì› ê´€ë¦¬</h2>
  
    <!-- íšŒì› ëª…ë‹¨ ì—…ë¡œë“œ -->
    <div style="margin-bottom: 1rem; font-size: 1.5rem; line-height: 2rem;">
      <label for="excelFileInput" style="font-weight: bold; display: block; margin-bottom: 0.4rem;">
        ğŸ“‚ íšŒì› ëª…ë‹¨ ì—…ë¡œë“œ
      </label>
      <small style="font-size: 0.8rem; color: #666; display: block; margin: 0;">
        â€» ì—‘ì…€ íŒŒì¼ì˜ <strong>Bì—´ = ì„±ëª…</strong>, <strong>Dì—´ = ì†Œì†</strong>ìœ¼ë¡œ ì‘ì„±(2í–‰ë¶€í„° ì½ìŒ)
      </small>      
    </div>
    
    <!-- íŒŒì¼ ì„ íƒ ì˜ì—­ -->
    <div style="margin: 0.5rem 0 0.3rem;">
      <input type="file" id="excelFileInput" accept=".xlsx, .xls"
        style="font-size: 1.3rem; padding: 0.6rem 1rem; border-radius: 6px;"
        onchange="updateSelectedFileName(this)">
      <div id="fileNameDisplay" style="margin-top: 0rem; font-size: 0.6rem; color: #555;"></div>
    </div>
  
    <!-- ë²„íŠ¼ ê·¸ë£¹ -->
    <div style="display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 1.5rem;">
      <button onclick="showTab('scoreTab')" style="flex: 1 1 45%; padding: 0.6rem 1.2rem; font-size: 1.3rem;">ê²½ê¸° ì ìˆ˜ ë³´ê¸°</button>
      <button onclick="toggleEditTeam()" style="flex: 1 1 45%; padding: 0.6rem 1.2rem; font-size: 1.3rem;">íšŒì› ì†Œì† ë³€ê²½</button>
      <button onclick="toggleIndividualDelete()" style="flex: 1 1 45%; padding: 0.6rem 1.2rem; font-size: 1.3rem;">íšŒì› ê°œë³„ ì‚­ì œ</button>
      <button onclick="deleteAllMembers()" style="flex: 1 1 45%; padding: 0.6rem 1.2rem; font-size: 1.3rem;">íšŒì› ì „ì²´ ì‚­ì œ</button>
    </div>
  
    <!-- íšŒì› ì§ì ‘ ì¶”ê°€ -->
    <div style="margin-top: 1.2rem; margin-bottom: 0.4rem; font-size: 1.4rem;">
      <label style="font-weight: bold; display: block; margin-bottom: 1rem;">íšŒì› ì§ì ‘ ì¶”ê°€</label>
    
      <div style="display: flex; gap: 8px; flex-wrap: nowrap; align-items: center;">
        <input type="text" id="manualName" placeholder="ì„±ëª… ì…ë ¥"
          style="flex: 0 0 35%; max-width: 35%; font-size: 1rem; padding: 0.5rem;" />
      
        <input type="text" id="manualTeam" placeholder="ì†Œì† ì…ë ¥"
          style="flex: 0 0 50%; max-width: 50%; font-size: 1rem; padding: 0.5rem;" />
      </div>
      <button onclick="addManualMember()" style="margin-top: 0.6rem; padding: 0.6rem 1.2rem; font-size: 1.1rem;">ì§ì ‘ ì¶”ê°€</button>
      </div>
    
    <!-- íšŒì› ëª…ë‹¨ í‘œì‹œ -->
    <div id="memberListDisplay" style="margin-top:1rem;"></div>
    <h3>íšŒì› ëª…ë‹¨</h3>
    <table class="member-table">
      <thead>
        <tr>
          <th>ìˆœ</th>
          <th>ì´ë¦„</th>
          <th>ì†Œì†</th>
          <!-- ì‚­ì œ ì—´ì€ JSì—ì„œ ë™ì ìœ¼ë¡œ ì‚½ì…ë¨ -->
        </tr>
      </thead>
      <tbody id="memberTableBody"></tbody>
    </table>

      <button onclick="downloadMemberList()" style="padding: 0.9rem 1.2rem; font-size: 1.1rem;">
        ğŸ’¾ íšŒì› ëª…ë‹¨ ë‹¤ìš´ë¡œë“œ
      </button>
    </div>
  </div>
  
<!-- ê²½ê¸° ì ìˆ˜ íƒ­ ì‹œì‘ -->
<div id="scoreTab" class="tab">
  <h2>ê²½ê¸° ì ìˆ˜</h2>

  <!-- ì‹œì¦Œ ì‹œì‘ì¼ -->
<div style="margin-bottom: 0.8rem; display: flex; align-items: center; gap: 0.6rem; flex-wrap: nowrap;">
  <label style="font-size: 1.1rem;">ì‹œì¦Œ ì‹œì‘ì¼:</label>
  <input type="date" id="seasonStart" value="2025-03-01"
    style="font-size: 1rem; padding: 0.4rem; width: 160px;">
</div>

<!-- ì‹œì¦Œ ë§ˆê°ì¼ -->
<div style="margin-bottom: 0.8rem; display: flex; align-items: center; gap: 0.6rem; flex-wrap: nowrap;">
  <label style="font-size: 1.1rem;">ì‹œì¦Œ ë§ˆê°ì¼:</label>
  <input type="date" id="seasonEnd" value="2026-02-28"
    style="font-size: 1rem; padding: 0.4rem; width: 160px;">
</div>

  <!-- í¬ìƒê¸ˆ + ì¶œì„ ë²„íŠ¼: ë‚˜ë€íˆ ë°°ì¹˜ -->
  <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
    <button onclick="openRewardSetting()" style="padding: 0.8rem 1.2rem; font-size: 1.1rem; flex: 1 1 48%;">
      í¬ìƒê¸ˆ ì„¤ì •
    </button>
    <button onclick="toggleAttendanceHistory()" style="padding: 0.8rem 1.2rem; font-size: 1.1rem; flex: 1 1 48%;">
      ì¶œì„ ê´€ë¦¬
    </button>
  </div>

  <!-- ë³´ìƒ ì„¤ì • ì˜ì—­ -->
  <div id="rewardSettingArea" style="display: none; margin-top: 1rem; padding: 1rem; border: 1px solid #ccc; border-radius: 8px;">
    <h3 style="margin-bottom: 1rem;">ğŸ† ìˆœìœ„ë³„ ë³´ìƒ ê¸ˆì•¡ ì…ë ¥</h3>
  
    <div style="display: flex; flex-direction: column; gap: 0.4rem;">
      <!-- 1ë“±~10ë“± ê°œë³„ ì…ë ¥ -->
      <div style="display: flex; align-items: center; gap: 0.6rem;">
        <label style="width: 4rem;">1ë“±:</label>
        <input type="number" id="reward1" style="width: 140px; padding: 0.3rem;" />
      </div>
      <div style="display: flex; align-items: center; gap: 0.6rem;">
        <label style="width: 4rem;">2ë“±:</label>
        <input type="number" id="reward2" style="width: 140px; padding: 0.3rem;" />
      </div>
      <div style="display: flex; align-items: center; gap: 0.6rem;">
        <label style="width: 4rem;">3ë“±:</label>
        <input type="number" id="reward3" style="width: 140px; padding: 0.3rem;" />
      </div>
      <div style="display: flex; align-items: center; gap: 0.6rem;">
        <label style="width: 4rem;">4ë“±:</label>
        <input type="number" id="reward4" style="width: 140px; padding: 0.3rem;" />
      </div>
      <div style="display: flex; align-items: center; gap: 0.6rem;">
        <label style="width: 4rem;">5ë“±:</label>
        <input type="number" id="reward5" style="width: 140px; padding: 0.3rem;" />
      </div>
      <div style="display: flex; align-items: center; gap: 0.6rem;">
        <label style="width: 4rem;">6ë“±:</label>
        <input type="number" id="reward6" style="width: 140px; padding: 0.3rem;" />
      </div>
      <div style="display: flex; align-items: center; gap: 0.6rem;">
        <label style="width: 4rem;">7ë“±:</label>
        <input type="number" id="reward7" style="width: 140px; padding: 0.3rem;" />
      </div>
      <div style="display: flex; align-items: center; gap: 0.6rem;">
        <label style="width: 4rem;">8ë“±:</label>
        <input type="number" id="reward8" style="width: 140px; padding: 0.3rem;" />
      </div>
      <div style="display: flex; align-items: center; gap: 0.6rem;">
        <label style="width: 4rem;">9ë“±:</label>
        <input type="number" id="reward9" style="width: 140px; padding: 0.3rem;" />
      </div>
      <div style="display: flex; align-items: center; gap: 0.6rem;">
        <label style="width: 4rem;">10ë“±:</label>
        <input type="number" id="reward10" style="width: 140px; padding: 0.3rem;" />
      </div>
    </div>
  
    <button onclick="saveRewardList()" style="margin-top: 1rem;">ì €ì¥</button>
    <button onclick="closeRewardSetting()" style="margin-top: 1rem; margin-left: 0.5rem;">ë‹«ê¸°</button>
  </div>
  
<!-- ì¶œì„ íˆìŠ¤í† ë¦¬ ì˜ì—­ -->
  <div id="attendanceHistory" style="display: none; margin-top: 1.5rem; overflow: auto; max-height: 500px; max-width: 100%; border: 1px solid #ccc;"></div>



      <!-- TOP10 ìˆœìœ„ ë³´ê¸° -->
      <div style="margin-bottom: 1.5rem;">
        <button onclick="toggleTop10()" style="font-size: 1.3rem; padding: 1rem 1.5rem; width: 100%;">
          ğŸ† TOP10 ìˆœìœ„ ë³´ê¸°
        </button>
        <div id="top10Display" style="display: none; margin-top: 1rem; background: #fff8e1; padding: 1rem; border-radius: 8px;"></div>
      </div>

  <!-- ì „ì²´ íšŒì› ì ìˆ˜ í™•ì¸ -->
  <div style="margin-bottom: 2rem;">
    <button onclick="toggleAllScores()" style="font-size: 1.3rem; padding: 1rem 1.5rem; width: 100%;">
      ğŸ“Š ì „ì²´ íšŒì› ì ìˆ˜ í™•ì¸
    </button>
    <div id="allScoresArea" style="display: none; margin-top: 1rem;"></div>
  </div>
</div>
  
  

  <!-- JS ì½”ë“œ -->
<script>
// ë³€ìˆ˜ ì„ ì–¸

let lastSelection = null;
let showDeleteButtons = false;
let memberList = [];
let showEditTeamButtons = false;
let fixedNotes = []; // ì„ íƒ ì™„ë£Œëœ ìª½ì§€: { index, value }
let confirmedIndexesMap = {}; // ì„ íƒì ì´ë¦„ â†’ index
let prizeMap = {};
const saved = JSON.parse(localStorage.getItem("rewardList") || "null");
if (saved) {
  saved.forEach((amount, idx) => {
    prizeMap[idx + 1] = amount;
  });
} else {
  // ê¸°ë³¸ê°’
  prizeMap = {
    1: 120000,
    2: 70000,
    3: 60000,
    4: 50000,
    5: 50000,
    6: 30000,
    7: 30000,
    8: 30000,
    9: 30000,
    10: 30000,
  };
}
let pickedIndexes = [];
let openedEnvelopes = [];
let confirmedSelections = { A: {}, B: {}, C: {} };
let confirmedIndexes = [];
// ë‚ ì§œ ì„ íƒ ì´ˆê¸°í™”
const yearSelect = document.getElementById("yearSelect");
const monthSelect = document.getElementById("monthSelect");
const daySelect = document.getElementById("daySelect");
const weekdayDisplay = document.getElementById("weekdayDisplay");

let reorderMode = false;
let deleteMode = false;

function toggleReorderMode() {
  reorderMode = !reorderMode;
  deleteMode = false;
  renderSelectedTable(); // ì¬ë Œë”ë§
}

function toggleDeleteMode() {
  deleteMode = !deleteMode;
  reorderMode = false;
  renderSelectedTable(); // ì¬ë Œë”ë§
}

function confirmAndClearAttendance() {
    if (confirm("ì •ë§ë¡œ ì¶œì„ë¶€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      clearCurrentAttendanceInputs(); // ì›ë˜ ìˆë˜ ì‚­ì œ í•¨ìˆ˜ ì‹¤í–‰
    }
    }

function showTab(tabId) {
    const tabs = document.querySelectorAll(".tab");
    tabs.forEach(tab => {
      tab.classList.remove("active");
      tab.style.display = "none";
    });

    const selectedTab = document.getElementById(tabId);
    if (selectedTab) {
      selectedTab.classList.add("active");
      selectedTab.style.display = "block";
      console.log("âœ… íƒ­ ì „í™˜ë¨:", tabId);
    }

    // ğŸŸ¢ ë²„íŠ¼ ê°•ì¡° ë™ê¸°í™”
    const buttons = document.querySelectorAll(".tab-buttons button");
    buttons.forEach(btn => {
      const onclickValue = btn.getAttribute("onclick") || "";
      const matches = onclickValue.match(/showTab\('([^']+)'\)/);
      const targetId = matches?.[1];
      if (targetId === tabId) btn.classList.add("active");
      else btn.classList.remove("active");
    });
}

function getTeamMatchOrder(teamName) {
  const teamMembers = finalTeamResults[teamName] || [];
  if (teamMembers.length === 0) return [];

  // ì¶œì„ ìˆœì„œë¥¼ ë°˜ì˜í•œ ë§µ ìƒì„±
  const attendanceList = JSON.parse(localStorage.getItem("attendanceList")) || [];
  const attendanceOrderMap = {};
  attendanceList.forEach((member, index) => {
    if (member.status === "ì¶œì„" || member.status === "ì§€ê°") {
      // ì´ë¦„ + ì†Œì† ê¸°ì¤€ìœ¼ë¡œ ê³ ìœ  ì‹ë³„
      const key = member.name + "|" + (member.affiliation || "");
      attendanceOrderMap[key] = index;
    }
  });

  // íŒ€ì› ì¶œì„ìˆœ ì¶”ì¶œ
  const membersWithIndex = teamMembers.map(player => {
    const key = player.name + "|" + (player.affiliation || "");
    const order = attendanceOrderMap[key] ?? 9999; // ì¶œì„ ì•ˆ í–ˆìœ¼ë©´ ë’¤ë¡œ ë³´ë‚´ê¸°
    return { ...player, attendanceIndex: order };
  });

  // ì¶œì„ 1ë“± ì°¾ê¸°
  const firstAttender = membersWithIndex.reduce((min, cur) =>
    cur.attendanceIndex < min.attendanceIndex ? cur : min
  , membersWithIndex[0]);

  // ë‚˜ë¨¸ì§€ ë¶„ë¥˜
  const judges = membersWithIndex.filter(p => p.position === "ì‹¬íŒ" && p.name !== firstAttender.name);
  const rests = membersWithIndex.filter(p => p.position === "íœ´ì‹" && p.name !== firstAttender.name);
  const gks    = membersWithIndex.filter(p => p.position === "GK" && p.name !== firstAttender.name);
  const others = membersWithIndex.filter(p =>
    !["ì‹¬íŒ", "íœ´ì‹", "GK"].includes(p.position) && p.name !== firstAttender.name
  );

  // ì •ë ¬ ì ìš©
  rests.sort((a, b) => a.attendanceIndex - b.attendanceIndex);
  others.sort((a, b) => a.attendanceIndex - b.attendanceIndex);

  // ìµœì¢… voteOrder êµ¬ì„±
  const ordered = [
    firstAttender,
    ...judges,
    ...rests,
    ...gks,
    ...others
  ];

  return ordered.map(p => p.name);
}

function setupDateListeners() {
  const yearSelect = document.getElementById("yearSelect");
  const monthSelect = document.getElementById("monthSelect");
  const daySelect = document.getElementById("daySelect");

  const handler = () => {
    updateWeekday();                 // ìš”ì¼ ê°±ì‹ 
    clearCurrentAttendanceInputs(); // ì…ë ¥ ì´ˆê¸°í™”
    updateSelectOptions(document.querySelectorAll('.name-select'));
  };

  yearSelect.addEventListener("change", handler);
  monthSelect.addEventListener("change", handler);
  daySelect.addEventListener("change", handler);
}

function adjustStarter(team, delta) { // íŠ¹ì • íŒ€(AíŒ€, BíŒ€, CíŒ€)ì˜ ì„ ë°œ ì¸ì› ìˆ˜ë¥¼ ì¦ê°€í•˜ê±°ë‚˜ ê°ì†Œì‹œí‚¤ëŠ” ê¸°ëŠ¥
  const input = document.getElementById(`match${team}Starter`);
  let value = parseInt(input.value || 0);
  value += delta;
  if (value < 1) value = 1;
  input.value = value;

  input.dataset.manual = "true"; // âœ… ìˆ˜ë™ ì¡°ì‘ í‘œì‹œ

  suggestFormation(team);       // í¬ë©”ì´ì…˜ ì¶”ì²œì€ ìœ ì§€
  updateMatchCounts();          // âœ… íœ´ì‹ ì¸ì› ë“± ì‹¤ì‹œê°„ ê°±ì‹  ì¶”ê°€
}

function adjustCCount(delta) { // CíŒ€ ì¸ì› ìˆ˜(matchCInput)ë¥¼ ì¦ê°ì‹œí‚¤ëŠ” ë²„íŠ¼ìš© í•¨ìˆ˜
  const input = document.getElementById("matchCInput");
  let value = parseInt(input.value || 0);
  value += delta;
  if (value < 0) value = 0;
  input.value = value;

  updateMatchCounts();  // âš½ ì‹¤ì‹œê°„ ë°˜ì˜
}

function toggleCustomFormation(team) {
  const select = document.getElementById(`formation${team}Select`);
  const customDiv = document.getElementById(`formation${team}Custom`);

  if (select.value === "custom") {
    customDiv.style.display = "block";
    updateRemainingSpots(team); // ì‚¬ìš©ì í¬ì§€ì…˜ ì”ì—¬ í™•ì¸
  } else {
    customDiv.style.display = "none";
    document.getElementById(`remaining${team}`).textContent = "";
  }
}


function updateRemainingSpots(team) { // íŠ¹ì • íŒ€(A/B/CíŒ€)ì˜ í¬ë©”ì´ì…˜ ì„¤ì • ì‹œ ë‚¨ì€ ì¸ì›ì´ ëª‡ ëª…ì¸ì§€ ì‹¤ì‹œê°„ìœ¼ë¡œ ê³„ì‚°í•˜ì—¬ í™”ë©´ì— í‘œì‹œ
  const starter = parseInt(document.getElementById(`match${team}Starter`).value || 0);
  const df = parseInt(document.getElementById(`df${team}`).value || 0);
  const mf = parseInt(document.getElementById(`mf${team}`).value || 0);
  const fw = parseInt(document.getElementById(`fw${team}`).value || 0);

  const used = 1 + df + mf + fw; // GK 1ëª… í¬í•¨
  const remaining = starter - used;

  const display = document.getElementById(`remaining${team}`);
  display.textContent = `ë‚¨ì€ ì¸ì›: ${remaining >= 0 ? remaining : 0}ëª…`;
}

function toggleCustomFormation(team) { // íŠ¹ì • íŒ€(A/B/CíŒ€)ì˜ í¬ë©”ì´ì…˜ ì„¤ì • ì‹œ ë‚¨ì€ ì¸ì›ì´ ëª‡ ëª…ì¸ì§€ ì‹¤ì‹œê°„ìœ¼ë¡œ ê³„ì‚°í•˜ì—¬ í™”ë©´ì— í‘œì‹œ
  const select = document.getElementById(`formation${team}Select`);
  const customDiv = document.getElementById(`formation${team}Custom`);

  if (select.value === "custom") {
    customDiv.style.display = "block";
    updateRemainingSpots(team); // âœ… í‘œì‹œ ì—…ë°ì´íŠ¸
  } else {
    customDiv.style.display = "none";
    document.getElementById(`remaining${team}`).textContent = "";
  }
}

function populateDateSelectors() { //í™”ë©´ì— í‘œì‹œë˜ëŠ” ë‚ ì§œ ì„ íƒ ë“œë¡­ë‹¤ìš´(select ìš”ì†Œ)ì— ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œ ì˜µì…˜ì„ ìë™ìœ¼ë¡œ ì±„ì›Œ ë„£ëŠ” ì—­í• 
  const now = new Date();

  const shortYears = [2025, 2026, 2027, 2028];
  yearSelect.innerHTML = "";
  shortYears.forEach(y => {
    const option = document.createElement("option");
    option.value = y;
    option.textContent = `${String(y).slice(2)}ë…„`; // 25ë…„, 26ë…„ ë“±
    yearSelect.appendChild(option);
  });

  // ì›” ì´ˆê¸°í™”
  monthSelect.innerHTML = "";
  for (let m = 1; m <= 12; m++) {
    const option = document.createElement("option");
    option.value = m;
    option.textContent = `${m}ì›”`;
    monthSelect.appendChild(option);
  }

  // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ë³¸ê°’ ì„¤ì •
  yearSelect.value = now.getFullYear();
  monthSelect.value = now.getMonth() + 1;

  // ì¼ ì´ˆê¸°í™” (ìš”ì¼ ìƒ‰ìƒ í¬í•¨)
  const selectedYear = parseInt(yearSelect.value);
  const selectedMonth = parseInt(monthSelect.value);
  const lastDay = new Date(selectedYear, selectedMonth, 0).getDate();

  daySelect.innerHTML = "";
  for (let d = 1; d <= lastDay; d++) {
    const date = new Date(selectedYear, selectedMonth - 1, d);
    const weekday = date.getDay();
    let color = "black";
    if (weekday === 0) color = "red";
    else if (weekday === 6) color = "blue";

    const option = document.createElement("option");
    option.value = d;
    option.textContent = `${d}ì¼`;
    option.style.color = color;  // âœ… í•µì‹¬!
    daySelect.appendChild(option);
  }

  daySelect.value = now.getDate();
  updateWeekday();
}

function updateRemainingPlayers(team) { //ì • íŒ€(AíŒ€, BíŒ€, CíŒ€)ì˜ ì „ì²´ ì¸ì› ì¤‘ì—ì„œ ì„ ë°œ ì¸ì›ì„ ëº€ 'íœ´ì‹ ì¸ì› ìˆ˜'ë¥¼ ê³„ì‚°í•˜ê³  í™”ë©´ì— í‘œì‹œ
  const starterInput = document.getElementById(`match${team}Starter`);
  const df = parseInt(document.getElementById(`df${team}`).value) || 0;
  const mf = parseInt(document.getElementById(`mf${team}`).value) || 0;
  const fw = parseInt(document.getElementById(`fw${team}`).value) || 0;

  const starter = parseInt(starterInput.value) || 0;
  const used = 1 + df + mf + fw;
  const remaining = starter - used;

  const target = document.getElementById(`remaining${team}`);
  target.textContent = `ë‚¨ì€ ì¸ì›: ${remaining}ëª…`;
}

function loadRankedAttendance() {
  const container = document.getElementById("attendanceList");
  container.innerHTML = "";
  // ì´ë¯¸ ìƒì„±ëœ ë“œë¡­ë‹¤ìš´ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì—¬ ì œê±°
const existingSelect = document.getElementById("singleNameSelect");
if (existingSelect) {
  existingSelect.remove(); // ì¤‘ë³µ ìƒì„± ë°©ì§€
}

// ê¸°ì¡´ ì¤‘ê°„ ì‚½ì…ì°½ë„ í•¨ê»˜ ì œê±°
const existingBox = document.getElementById("middleInsertBox");
if (existingBox) {
  existingBox.remove();
}

  if (!Array.isArray(memberList) || memberList.length === 0) {
    const saved = localStorage.getItem("memberList");
    if (saved) {
      memberList = JSON.parse(saved);
    } else {
      alert("âš ï¸ ë¨¼ì € íšŒì› ëª…ë‹¨ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.");
      return;
    }
  }

  if (memberList.length === 0) {
    alert("ë¨¼ì € íšŒì› ëª…ë‹¨ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.");
    return;
  }

  // âœ… ë“œë¡­ë‹¤ìš´ ìƒì„±
  const select = document.createElement("select");
  select.id = "singleNameSelect";
  select.classList.add("name-select");
  select.style.fontSize = "1.3rem";
  select.style.marginBottom = "1rem";
  select.style.backgroundColor = "#fffde7";
  select.style.padding = "0.5rem 0.8rem";
  select.style.verticalAlign = "top";
  select.style.lineHeight = "1.3";

  const defaultOption = document.createElement("option");
  defaultOption.value = "";
  defaultOption.textContent = "-- ì„±ëª… ì„ íƒ --";
  select.appendChild(defaultOption);

  const sortedList = [...memberList].sort((a, b) => a.name.localeCompare(b.name, "ko"));
  sortedList.forEach(member => {
    const key = `${member.name}__${member.team || ""}`;
    if (selectedNames.includes(key)) return;

    const isDuplicate = memberList.filter(m => m.name === member.name).length > 1;

    const option = document.createElement("option");
    option.value = key;
    option.textContent = isDuplicate && member.team
      ? `${member.name}(${member.team})`
      : member.name;

    select.appendChild(option);
  });

  const nonMemberOption = document.createElement("option");
  nonMemberOption.value = "__ë¹„íšŒì›__";
  nonMemberOption.textContent = "â• ë¹„íšŒì› ì¶”ê°€";
  select.appendChild(nonMemberOption);

  select.addEventListener("change", () => {
    const fullKey = select.value;

    if (fullKey === "__ë¹„íšŒì›__") {
      showNonMemberInput(select);
      return;
    }

    if (!fullKey || selectedNames.includes(fullKey)) return;

    if (selectedNames.length >= 35) {
      alert("ìµœëŒ€ 35ëª…ê¹Œì§€ë§Œ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      return;
    }

    selectedNames.push(fullKey);
    updateSelectOptions(document.querySelectorAll('.name-select'));
    renderSelectedTable();

    localStorage.setItem("tempSelectedNames", JSON.stringify(selectedNames));
    localStorage.setItem("tempLateStatus", JSON.stringify(lateStatus));

    setTimeout(() => {
      select.selectedIndex = 0;
      updateSelectOptions(document.querySelectorAll(".name-select"));
    }, 500);
  });

  // âœ… ì¤‘ê°„ ì‚½ì… ë²„íŠ¼ê³¼ ë“œë¡­ë‹¤ìš´ì„ í•¨ê»˜ ê°ìŒ€ wrapper ìƒì„±
  const insertBtn = document.getElementById("middleInsertButton");
  if (insertBtn) {
    const innerWrapper = document.createElement("div");
    innerWrapper.style.display = "flex";
    innerWrapper.style.alignItems = "center";
    innerWrapper.style.gap = "10px";

    // ê¸°ì¡´ ë²„íŠ¼ ë³µì‚¬
    const btnClone = insertBtn.cloneNode(true);
    btnClone.onclick = showMiddleInsertForm;

    innerWrapper.appendChild(select);
    innerWrapper.appendChild(btnClone);

    insertBtn.parentNode.replaceChild(innerWrapper, insertBtn);
  } else {
    container.insertBefore(select, container.firstChild);
  }

  // âœ… í…Œì´ë¸” êµ¬ì„±
  renderSelectedTable();
  updateSelectOptions(document.querySelectorAll(".name-select"));
}

 
function showNonMemberInput(select) {
  // ê¸°ì¡´ ì…ë ¥ì°½ ì œê±°
  const existing = document.getElementById("nonMemberInputBox");
  if (existing) existing.remove();

  // ì™¸ë¶€ ì»¨í…Œì´ë„ˆ div
  const box = document.createElement("div");
  box.id = "nonMemberInputBox";
  box.style.marginTop = "0.5rem";                 // âœ… ìœ„ ì½¤ë³´ë°•ìŠ¤ì™€ ê°„ê²© í™•ë³´
  box.style.display = "flex";
  box.style.flexDirection = "column";           // âœ… ì„¸ë¡œ ì •ë ¬
  box.style.alignItems = "flex-start";
  box.style.width = "100%";
  box.style.maxWidth = "500px";
  box.style.gap = "0.5rem";

  // ë¹„íšŒì› ì´ë¦„ ì…ë ¥
  const input = document.createElement("input");
  input.placeholder = "ë¹„íšŒì› ì„±ëª… ì…ë ¥";
  input.style.fontSize = "1rem";
  input.style.padding = "0.4rem";
  input.style.height = "38px";
  input.style.width = "50%";         // ìœ ì§€í•˜ë©´ì„œë„
  input.style.maxWidth = "180px";     // âœ… ìµœëŒ€ ë„ˆë¹„ ì œí•œ ì¶”ê°€

  // ì €ì¥ ë²„íŠ¼
  const saveBtn = document.createElement("button");
  saveBtn.textContent = "ì €ì¥";
  saveBtn.style.height = "38px";
  saveBtn.style.fontSize = "1rem";
  saveBtn.style.padding = "0.5rem 1rem";
  saveBtn.onclick = () => {
    const name = input.value.trim();
    if (!name) {
      alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    const finalName = `(ìš©) ${name}`;
    if (selectedNames.includes(finalName)) {
      alert("ì´ë¯¸ ë“±ë¡ëœ ì´ë¦„ì…ë‹ˆë‹¤.");
      return;
    }

    selectedNames.push(finalName);
    renderSelectedTable();
    select.value = "";
    box.remove();
  };

  // ì·¨ì†Œ ë²„íŠ¼
  const cancelBtn = document.createElement("button");
  cancelBtn.textContent = "ì·¨ì†Œ";
  cancelBtn.style.height = "38px";
  cancelBtn.style.fontSize = "1rem";
  cancelBtn.style.padding = "0.5rem 1rem";
  cancelBtn.onclick = () => {
    select.value = "";
    box.remove();
  };

  // ë²„íŠ¼ ê°€ë¡œ ë°°ì¹˜
  const buttonRow = document.createElement("div");
  buttonRow.style.display = "flex";
  buttonRow.style.gap = "10px";
  buttonRow.appendChild(saveBtn);
  buttonRow.appendChild(cancelBtn);

  // êµ¬ì„± ìš”ì†Œ ì‚½ì…
  box.appendChild(input);
  box.appendChild(buttonRow);

  // âœ… select ì½¤ë³´ìƒìì™€ ì¤‘ê°„ ì‚½ì… ë²„íŠ¼ ì‚¬ì´ì— ìœ„ì¹˜í•˜ë„ë¡ ëª…í™•í•œ ë¶€ëª¨ì— ì¶”ê°€
  const container = document.getElementById("attendanceList"); // ë˜ëŠ” ì ì ˆí•œ wrapper
  const wrapper = select.closest("div");  // ë¹„íšŒì› ì¶”ê°€ ë²„íŠ¼ì„ ê°ì‹¼ div
if (wrapper) {
  wrapper.insertAdjacentElement("afterend", box);  // ë°”ë¡œ ì•„ë˜ ì‚½ì…
}
}


function showMiddleInsertForm() {
  const container = document.getElementById("attendanceList");

  // ì´ì „ ì‚½ì…ì°½ ì œê±°
  const existing = document.getElementById("middleInsertBox");
  if (existing) existing.remove();

  // ëª¨ë‹¬ ë°•ìŠ¤ ìƒì„±
  const box = document.createElement("div");
  box.id = "middleInsertBox";
  box.style.marginTop = "1rem";
  box.style.padding = "1rem";
  box.style.backgroundColor = "#f9f9f9";
  box.style.border = "1px solid #ccc";
  box.style.borderRadius = "8px";
  box.style.display = "flex";
  box.style.flexDirection = "column";         // âœ… ì¤„ë°”ê¿ˆ ê°•ì œ
  box.style.alignItems = "flex-start";
  box.style.gap = "0.5rem";
  box.style.width = "100%";
  box.style.maxWidth = "500px";

  // ì„±ëª… ì„ íƒ
  const nameSelect = document.createElement("select");
  nameSelect.id = "middleInsertName";
  nameSelect.classList.add("name-select");
  nameSelect.style.fontSize = "1.1rem";
  nameSelect.style.padding = "0.4rem 0.6rem";
  nameSelect.style.height = "38px";
  nameSelect.innerHTML = '<option value="">-- ì„±ëª… ì„ íƒ --</option>';

  const sortedList = [...memberList].sort((a, b) => a.name.localeCompare(b.name, "ko"));
  let addedCount = 0;

  sortedList.forEach(member => {
    const key = `${member.name}__${member.team || ""}`;
    if (selectedNames.includes(key)) return;

    const isDuplicate = memberList.filter(m => m.name === member.name).length > 1;
    const option = document.createElement("option");
    option.value = key;
    option.textContent = isDuplicate && member.team ? `${member.name}(${member.team})` : member.name;

    nameSelect.appendChild(option);
    addedCount++;
  });

  if (addedCount === 0) {
    const noticeOption = document.createElement("option");
    noticeOption.disabled = true;
    noticeOption.textContent = "âš ï¸ ì„ íƒ ê°€ëŠ¥í•œ ì´ë¦„ì´ ì—†ìŠµë‹ˆë‹¤";
    nameSelect.insertBefore(noticeOption, nameSelect.firstChild);
  }

  // ë¹„íšŒì› ì¶”ê°€ í•­ëª©
  const nonMemberOption = document.createElement("option");
  nonMemberOption.value = "__ë¹„íšŒì›__";
  nonMemberOption.textContent = "â• ë¹„íšŒì› ì¶”ê°€";
  nameSelect.appendChild(nonMemberOption);

  // ë“±ìˆ˜ ì„ íƒ
  const rankSelect = document.createElement("select");
  rankSelect.id = "middleInsertRank";
  rankSelect.style.fontSize = "1.1rem";
  rankSelect.style.height = "43px";
  for (let i = 1; i <= selectedNames.length + 1; i++) {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = `${i}ë“±`;
    rankSelect.appendChild(option);
  }

  // ì €ì¥ ë²„íŠ¼
  const saveBtn = document.createElement("button");
  saveBtn.textContent = "ì €ì¥";
  saveBtn.style.fontSize = "1.1rem";
  saveBtn.style.height = "38px";
  saveBtn.style.padding = "0.5rem 1rem";
  saveBtn.onclick = () => {
    const fullKey = nameSelect.value;
    const insertIndex = parseInt(rankSelect.value) - 1;

    if (selectedNames.includes(fullKey)) {
      alert("ì´ë¯¸ ì„ íƒëœ ì´ë¦„ì…ë‹ˆë‹¤.");
      return;
    }

    if (!fullKey || isNaN(insertIndex) || insertIndex < 0 || insertIndex > selectedNames.length) {
      alert("ì…ë ¥ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      return;
    }

    selectedNames.splice(insertIndex, 0, fullKey);
    renderSelectedTable();
    updateSelectOptions(document.querySelectorAll(".name-select"));
    box.remove();
  };

  // ë‹«ê¸° ë²„íŠ¼
  const closeBtn = document.createElement("button");
  closeBtn.textContent = "ë‹«ê¸°";
  closeBtn.style.fontSize = "1.1rem";
  closeBtn.style.height = "38px";
  closeBtn.style.padding = "0.5rem 1rem";
  closeBtn.onclick = () => box.remove();

  // ë²„íŠ¼ ê°€ë¡œ ì •ë ¬
  const bottomRow = document.createElement("div");
bottomRow.style.display = "flex";
bottomRow.style.gap = "10px";
bottomRow.style.alignItems = "center";

// âœ… ë“± ì½¤ë³´ë°•ìŠ¤, ì €ì¥, ë‹«ê¸° ëª¨ë‘ ì—¬ê¸°ì— ë„£ìŒ
bottomRow.appendChild(rankSelect);
bottomRow.appendChild(saveBtn);
bottomRow.appendChild(closeBtn);

  // êµ¬ì„± ìš”ì†Œ ì¶”ê°€
  box.appendChild(nameSelect);
  box.appendChild(bottomRow);


  // âœ… ì‚½ì… ìœ„ì¹˜: ì¤‘ê°„ ì‚½ì… ë²„íŠ¼(div) ì•„ë˜ì— ì¤„ë°”ê¿ˆìœ¼ë¡œ ì‚½ì…
  const insertBtn = document.getElementById("middleInsertButton");
  const wrapper = insertBtn.closest("div");
  if (wrapper) {
    wrapper.insertAdjacentElement("afterend", box);
  } else {
    container.appendChild(box);
  }
}

function renderSelectedTable() {
  const table = document.getElementById("selectedTable");

  if (!table) {
    console.error("âŒ selectedTable í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  table.classList.toggle("control-mode-active", reorderMode || deleteMode);

  // âœ… í—¤ë” ë™ì  ìƒì„±
  let thead = table.querySelector("thead");
  if (!thead) {
    thead = document.createElement("thead");
    table.appendChild(thead);
  }
  thead.innerHTML = "";

  const headerRow = document.createElement("tr");
  ["ìˆœ", "ì„±ëª…", (reorderMode || deleteMode) ? "ì¡°ì‘" : "ì§€ê°"].forEach(text => {
    const th = document.createElement("th");
    th.textContent = text;
    th.style.textAlign = "center";
    headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);

  // âœ… tbody ì¤€ë¹„
  let tbody = table.querySelector("tbody");
  if (!tbody) {
    tbody = document.createElement("tbody");
    table.appendChild(tbody);
  }
  tbody.innerHTML = "";

  selectedNames.forEach((fullKey, idx) => {
    const row = document.createElement("tr");
    row.style.fontSize = "1.3rem";
    row.style.border = "1px solid #ddd";

    // ìˆœë²ˆ ì—´
    const rankTd = document.createElement("td");
    rankTd.textContent = `${idx + 1}`;
    rankTd.style.textAlign = "center";

    // ì„±ëª… ì—´
    const nameTd = document.createElement("td");
    nameTd.style.textAlign = "center";
    const [name, team] = fullKey.split("__");
    const isDuplicate = memberList.filter(m => m.name === name).length > 1;
    const displayName = isDuplicate && team ? `${name}(${team})` : name;
    const nameSpan = document.createElement("span");
    nameSpan.textContent = displayName;
    nameTd.appendChild(nameSpan);

    // ì§€ê° ì—´ (ê¸°ë³¸ ìƒíƒœì—ì„œë§Œ í‘œì‹œ)
    const lateTd = document.createElement("td");
    lateTd.style.textAlign = "center";
    lateTd.style.display = (reorderMode || deleteMode) ? "none" : "table-cell";

    const lateCheck = document.createElement("input");
    lateCheck.type = "checkbox";
    lateCheck.checked = lateStatus[fullKey] || false;
    lateCheck.style.transform = "scale(1.3)";
    lateCheck.style.marginLeft = "8px";
    lateCheck.onchange = () => {
      lateStatus[fullKey] = lateCheck.checked;
      renderNameDropdown();
      updateSelectOptions(document.querySelectorAll(".name-select"));
    };
    lateTd.appendChild(lateCheck);

    // ì¡°ì‘ ì—´ (ìˆœì„œ ë³€ê²½ or ì‚­ì œ ëª¨ë“œì—ì„œë§Œ í‘œì‹œ)
    const controlTd = document.createElement("td");
    controlTd.classList.add("control-cell");
    controlTd.style.textAlign = "center";
    controlTd.style.display = (reorderMode || deleteMode) ? "table-cell" : "none";

    // ìˆœì„œ ë³€ê²½ ë²„íŠ¼
    const upBtn = document.createElement("button");
    upBtn.textContent = "â–²";
    upBtn.style.marginLeft = "6px";
    upBtn.style.marginRight = "10px";
    upBtn.style.fontSize = "0.8rem";
    upBtn.style.padding = "1px 5px";
    upBtn.onclick = () => {
      if (idx === 0) return;
      [selectedNames[idx - 1], selectedNames[idx]] = [selectedNames[idx], selectedNames[idx - 1]];
      renderSelectedTable();
    };

    const downBtn = document.createElement("button");
    downBtn.textContent = "â–¼";
    downBtn.style.fontSize = "0.8rem";
    downBtn.style.padding = "1px 5px";
    downBtn.onclick = () => {
      if (idx === selectedNames.length - 1) return;
      [selectedNames[idx + 1], selectedNames[idx]] = [selectedNames[idx], selectedNames[idx + 1]];
      renderSelectedTable();
    };

    // ì‚­ì œ ë²„íŠ¼
    const delBtn = document.createElement("button");
    delBtn.textContent = "ì‚­ì œ";
    delBtn.style.fontSize = "0.8rem";
    delBtn.style.lineHeight = "1";
    delBtn.style.padding = "0.2rem 0.5rem";
    delBtn.onclick = () => {
      selectedNames.splice(idx, 1);
      renderSelectedTable();
    };

    // ì¡°ì‘ ë²„íŠ¼ ì‚½ì…
    if (reorderMode) {
      controlTd.appendChild(downBtn);
      controlTd.appendChild(upBtn);
    }
    if (deleteMode) {
      controlTd.appendChild(delBtn);
    }

    // í–‰ ì¡°ë¦½
    row.appendChild(rankTd);
    row.appendChild(nameTd);
    row.appendChild(lateTd);
    row.appendChild(controlTd);
    tbody.appendChild(row);

    // ë§ˆì§€ë§‰ ì¤„ ìŠ¤í¬ë¡¤
    if (idx === selectedNames.length - 1) {
      row.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }
  });
}



function renderNameDropdown(selectId = "singleNameSelect", inputId = "nonMemberInput") {
  const select = document.getElementById(selectId);
  if (!select || !Array.isArray(memberList)) return;

  select.innerHTML = "";

  const defaultOption = document.createElement("option");
  defaultOption.value = "";
  defaultOption.textContent = "-- ì„±ëª… ì„ íƒ --";
  select.appendChild(defaultOption);

  const sortedList = [...memberList].sort((a, b) => a.name.localeCompare(b.name, "ko"));
  sortedList.forEach(member => {
    const key = `${member.name}__${member.team || ""}`;
    if (selectedNames.includes(key)) return;

    const isDuplicate = memberList.filter(m => m.name === member.name).length > 1;

    const option = document.createElement("option");
    option.value = key;
    option.textContent = isDuplicate && member.team
      ? `${member.name}(${member.team})`
      : member.name;
    select.appendChild(option);
  });

  const nonMemberOption = document.createElement("option");
  nonMemberOption.value = "__ë¹„íšŒì›__";
  nonMemberOption.textContent = "â• ë¹„íšŒì› ì¶”ê°€";
  select.appendChild(nonMemberOption);

  // ë¹„íšŒì› ì…ë ¥ì°½ í‘œì‹œ
  select.onchange = () => {
    const input = document.getElementById(inputId);
    if (input) input.style.display = (select.value === "__ë¹„íšŒì›__") ? "inline-block" : "none";
  };
}


let matchPlayers = []; // 1ê²½ê¸° ì°¸ê°€ì ì €ì¥ìš©

function loadMatchPlayers() {
    if (!window.attendanceHistoryData || Object.keys(attendanceHistoryData).length === 0) {
    alert("ì¶œì„ ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // ê°€ì¥ ìµœê·¼ ë‚ ì§œë¥¼ ì°¾ìŒ (ì •ë ¬ëœ ë§ˆì§€ë§‰ ê°’)
  const latestDate = Object.keys(attendanceHistoryData).sort().pop();
  const latestData = attendanceHistoryData[latestDate];

  matchPlayers = [...latestData];

  const total = matchPlayers.length;
  const cNum = parseInt(document.getElementById("matchCInput").value || 0);
  const rest = Math.max(0, total - cNum);
  const aNum = Math.ceil(rest / 2);
  const bNum = Math.floor(rest / 2);

  document.getElementById("matchAStarter").value = aNum;
  document.getElementById("matchBStarter").value = bNum;

  updateMatchCounts();

  // âœ… í¬ë©”ì´ì…˜ ì¶”ì²œ ì¦‰ì‹œ í‘œì‹œ
  suggestFormation("A");
  suggestFormation("B");

  console.log(`ìµœê·¼ ì¶œì„ ë‚ ì§œ: ${latestDate}`);
}

function updateMatchCounts() {
  const total = matchPlayers.length;
  const cNum = parseInt(document.getElementById("matchCInput").value || 0);
  const rest = Math.max(0, total - cNum);

  const bStarterInput = document.getElementById("matchBStarter");
  const isOneTeamMode = (parseInt(bStarterInput.value || 0) === 0);

  const aNum = isOneTeamMode ? rest : Math.ceil(rest / 2);
  const bNum = isOneTeamMode ? 0    : Math.floor(rest / 2);


  const totalPlayers = aNum + bNum + cNum;
  document.getElementById("matchTotal").textContent = totalPlayers;
  
  const aStarterInput = document.getElementById("matchAStarter");
  const bStarterNowInput = document.getElementById("matchBStarter");

  // âœ… ì‚¬ìš©ìê°€ ì§ì ‘ ì¡°ì‘í•˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ê°’ ìë™ ì„¤ì •
  if (!aStarterInput.dataset.manual) {
    aStarterInput.value = (aNum >= 10) ? 10 : aNum;
  }
  if (!bStarterNowInput.dataset.manual) {
    bStarterNowInput.value = (bNum >= 10) ? 10 : bNum;
  }

  const aStarter = parseInt(aStarterInput.value || 0);
  const bStarterNow = parseInt(bStarterNowInput.value || 0);

  const aRest = Math.max(0, aNum - aStarter);
  const bRest = Math.max(0, bNum - bStarterNow);
  
  document.getElementById("matchACount").textContent = aNum;
  document.getElementById("restACount").textContent = aRest;
  document.getElementById("matchBCount").textContent = bNum;
  document.getElementById("restBCount").textContent = bRest;

  if (aStarter > 0) suggestFormation("A");
  if (bStarterNow > 0) suggestFormation("B");
}






function suggestFormation(team) {
  let starter = parseInt(document.getElementById(`match${team}Starter`).value || 0);

  // âœ… 11ëª… ì´ìƒì¼ ê²½ìš° ê°•ì œë¡œ 11 ê¸°ì¤€ìœ¼ë¡œ ì¶”ì²œ (4-3-3 ë“±)
  const recommendedKey = (starter >= 11) ? 11 : starter;

  const target = document.getElementById(`suggest${team}`);
  const select = document.getElementById(`formation${team}Select`);
  const list = {
    12: ["4-5-2", "4-4-3", "3-4-4"],
    11: ["4-3-3", "4-4-2", "3-5-2", "3-4-3"], 
    10: ["4-4-1", "3-4-2", "3-5-1", "4-3-2"],
    9: ["3-4-1", "4-3-1", "3-3-2"],
    8: ["3-3-1", "2-4-1", "4-2-1"],
    7: ["3-3-0", "2-3-1", "3-2-1"],
    6: ["2-2-1", "1-2-2", "2-3-0"],
    5: ["1-2-1", "2-2-0", "1-1-2"],
    4: ["1-1-1", "1-2-0"]
  };

  const recommended = list[recommendedKey] || [];

  // í…ìŠ¤íŠ¸ ë° ì…€ë ‰íŠ¸ ë°•ìŠ¤ ì´ˆê¸°í™”
  target.textContent = recommended.join(", ");
  select.innerHTML = '<option value="">-- ì¶”ì²œ ì„ íƒ --</option>';

  recommended.forEach((form, i) => {
    const option = document.createElement("option");
    option.value = form;
    option.textContent = form;
    if (i === 0) option.selected = true;
    select.appendChild(option);
  });

  const customOption = document.createElement("option");
  customOption.value = "custom";
  customOption.textContent = "ì§ì ‘ ì…ë ¥";
  select.appendChild(customOption);
}

let formationA = null;
let formationB = null;

function switchTab(tabId) {
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(tab => {
    tab.style.display = (tab.id === tabId) ? 'block' : 'none';
  });

  const buttons = document.querySelectorAll('.tab-buttons button');
  buttons.forEach(button => {
    if (button.dataset.tab === tabId) {
      button.classList.add('active');
    } else {
      button.classList.remove('active');
    }
  });
  if (tabId === "matchSetup2") {
    updateDrawButtonsStatus();  // 2-4ê²½ê¸° íƒ­ì¼ ë•Œ ë²„íŠ¼ ìƒíƒœ ë°˜ì˜
  }

  console.log(`âœ… íƒ­ ì „í™˜ë¨: ${tabId}`);
}

function assignTeams() {
  const numPlayers = parseInt(document.getElementById("matchCount").value);
  const formation = document.getElementById("formationSelect").value;
  const [df, mf, fw] = formation.split("-").map(Number);

  const selected = [...savedAttendanceData] // ì¶œì„ ì €ì¥ëœ ëª…ë‹¨
    .filter(p => memberList.map(m => m.name).includes(p.name))
    .slice(0, numPlayers);

  if (selected.length < numPlayers) {
    alert(`ì¶œì„ ì¸ì›ì´ ${numPlayers}ëª…ë³´ë‹¤ ì ìŠµë‹ˆë‹¤.`);
    return;
  }

  // ì…”í”Œ
  const shuffled = [...selected].sort(() => Math.random() - 0.5);

  const GK = shuffled[0].name;
  const DFs = shuffled.slice(1, 1 + df).map(p => p.name);
  const MFs = shuffled.slice(1 + df, 1 + df + mf).map(p => p.name);
  const FWs = shuffled.slice(1 + df + mf, 1 + df + mf + fw).map(p => p.name);

  // íŒ€ ë¶„í•  (ë‚˜ë¨¸ì§€ ì¸ì› ìë™ A/B ë°°ì •)
  const teamA = [], teamB = [];
  shuffled.forEach((p, i) => {
    if (i % 2 === 0) teamA.push(p.name);
    else teamB.push(p.name);
  });

  let html = `<h3>í¬ì§€ì…˜ ë°°ì • (${formation})</h3>`;
  html += `<p><strong>GK:</strong> ${GK}</p>`;
  html += `<p><strong>DF:</strong> ${DFs.join(", ")}</p>`;
  html += `<p><strong>MF:</strong> ${MFs.join(", ")}</p>`;
  html += `<p><strong>FW:</strong> ${FWs.join(", ")}</p>`;

  html += `<h3>AíŒ€</h3><ul>${teamA.map(n => `<li>${n}</li>`).join("")}</ul>`;
  html += `<h3>BíŒ€</h3><ul>${teamB.map(n => `<li>${n}</li>`).join("")}</ul>`;

  document.getElementById("teamResult").innerHTML = html;
}


function clearCurrentAttendanceInputs() {
  // âœ… ì„ íƒëœ ì´ë¦„ ë°°ì—´ê³¼ ìƒíƒœ ì´ˆê¸°í™”
  selectedNames = [];
  lateStatus = {};

  // âœ… ì¶œì„ í…Œì´ë¸” ì‚­ì œ
  const table = document.getElementById("selectedTable");
  const tbody = document.querySelector("#selectedTable tbody");
if (tbody) tbody.innerHTML = "";


  // âœ… ì§€ê° ìƒíƒœ í…Œì´ë¸” ì‚­ì œ
  const status = document.getElementById("lateStatusTable");
  if (status) status.remove();

  // âœ… ì¤‘ê°„ ì‚½ì… ì…ë ¥ì°½ ì‚­ì œ
  const middleBox = document.getElementById("middleInsertBox");
  if (middleBox) middleBox.remove();
  

  // âœ… ìš”ì•½ ì˜ì—­ ì´ˆê¸°í™”
  const summary = document.getElementById("attendanceSummary");
  if (summary) summary.innerHTML = "";

  // âœ… í¬ì§€ì…˜ ë½‘ê¸° ê´€ë ¨ ìƒíƒœ ì „ë¶€ ì´ˆê¸°í™”
  confirmedSelections = {};
  shuffledNotes = [];
  shuffledNotesOriginal = [];
  openedEnvelopes = [];
  confirmedIndexes = [];
  voteOrder = [];
  currentPlayerIndex = 0;
  finalTeamResults = {};

  localStorage.removeItem("finalTeamResults");
  localStorage.removeItem("confirmedSelections");

  // âœ… ê´€ë ¨ ëª¨ë‹¬ì°½ ìˆ¨ê¸°ê¸°
  ["resultModalOverlay", "drawModalOverlay", "selectionModal"].forEach(id => {
    const modal = document.getElementById(id);
    if (modal) modal.style.display = "none";
  });

  // âœ… íŒ€êµ¬ë¶„ ê²°ê³¼ í…Œì´ë¸”ë„ ì´ˆê¸°í™”
  const liveResult = document.getElementById("liveResultTable");
  if (liveResult) liveResult.innerHTML = "";

  // âœ… ì„ íƒ ë“œë¡­ë‹¤ìš´ ì¬ë¡œë“œ
  loadRankedAttendance();  // ë‹¤ì‹œ ì´ˆê¸° í™”ë©´ ë Œë”ë§
}


function updateSelectOptions(selects) {
  const selectedKeys = [...selectedNames]; // fullKey ê¸°ì¤€ìœ¼ë¡œ ì²´í¬í•´ì•¼ ì •í™•

  selects.forEach(select => {
    const current = select.value;
    Array.from(select.options).forEach(option => {
      if (option.value === "") return;

      // ë¹„íšŒì› ì¶”ê°€ëŠ” í•­ìƒ í‘œì‹œ
      if (option.value === "__ë¹„íšŒì›__") {
        option.hidden = false;
        return;
      }

      // ì´ë¯¸ ì„ íƒëœ í•­ëª©ì€ ìˆ¨ê¹€ (ë‹¨, í˜„ì¬ ì„ íƒí•œ ê±´ ìœ ì§€)
      option.hidden = selectedKeys.includes(option.value) && option.value !== current;
    });
  });
}

let savedAttendanceData = [];

function saveAttendance() {
  savedAttendanceData = [];

  for (let i = 0; i < selectedNames.length; i++) {
    const fullKey = selectedNames[i];
    const [name] = fullKey.split("__");

    const late = lateStatus[name] || false;
    const leave = (confirmedSelections[name] || "").includes("ì¡°í‡´");

    savedAttendanceData.push({
      rank: i + 1,
      name,
      late,
      leave,
      isNonMember: false,
      score: (late || leave) ? 5 : 10
    });
  }

  const year = document.getElementById("yearSelect").value;
  const month = document.getElementById("monthSelect").value.padStart(2, '0');
  const day = document.getElementById("daySelect").value.padStart(2, '0');
  const dateKey = `${year}-${month}-${day}`;

  if (!window.attendanceHistoryData) window.attendanceHistoryData = {};
  window.attendanceHistoryData[dateKey] = [...savedAttendanceData];

  localStorage.setItem("attendanceHistoryData", JSON.stringify(window.attendanceHistoryData));

  alert(`ì¶œì„ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (${dateKey})`);
  renderAttendanceHistory();

  // âœ… ì¶”ê°€: ìë™ íƒ­ ì´ë™ ë° ì ìš©
  showTab("matchTab"); // íƒ­ ì´ë™
  // ì¶œì„ ì €ì¥ í›„ ê²½ê¸° ì°¸ê°€ì ë°ì´í„°ë¡œ ë°˜ì˜
    matchPlayers = selectedNames.map(fullKey => {
      const [name] = fullKey.split("__");
      return { name };
    });
    updateMatchCounts();

// âœ… ê²½ê¸° í¸ì„± 1ê²½ê¸° íƒ­ ë²„íŠ¼ ë³´ì´ê²Œ í•˜ê¸°
const matchTabBtn = document.getElementById("matchTabButton");
if (matchTabBtn) {
  matchTabBtn.style.display = "inline-block";
}
}


const recommendedFormations = {
  12: ["4-5-2", "4-4-3", "3-4-4"],
  11: ["4-3-3", "4-4-2", "3-5-2", "3-4-3"],
  10: ["4-4-1", "3-4-2", "3-5-1", "4-3-2"],
  9: ["3-4-1", "4-3-1", "3-3-2"],
  8: ["3-3-1", "2-4-1", "4-2-1"],
  7: ["3-3-0", "2-3-1", "3-2-1"],
  6: ["2-2-1", "1-2-2", "2-3-0"],
  5: ["1-2-1", "2-2-0", "1-1-2"],
  4: ["1-1-1", "1-2-0"]
};


function updateTeamCounts() {
  const total = savedAttendanceData.filter(p => memberList.map(m => m.name).includes(p.name)).length;
  const cNum = parseInt(document.getElementById("cTeamInput").value || 0);
  const rest = Math.max(0, total - cNum);
  const aNum = Math.ceil(rest / 2);
  const bNum = Math.floor(rest / 2);

  document.getElementById("totalCount").textContent = total;
  document.getElementById("cCount").textContent = cNum;
  document.getElementById("aCount").textContent = aNum;
  document.getElementById("bCount").textContent = bNum;
}


function renderAttendanceHistory() {
  const container = document.getElementById("attendanceHistory");
  if (!container) {
    console.warn("âš ï¸ attendanceHistory ìš”ì†Œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ.");
    return;
  }

  const history = window.attendanceHistoryData || {};
  if (Object.keys(history).length === 0) {
    container.innerHTML = "<p>âš ï¸ ì €ì¥ëœ ì¶œì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    return;
  }

  const dates = Object.keys(history).sort(); // ë‚ ì§œ ì—´
  const sortedMembers = [...memberList].sort((a, b) => a.name.localeCompare(b.name, "ko"));

  let html = `
    <table border='1' cellpadding='6' style='border-collapse: collapse; min-width: 600px; text-align: center;'>
    <thead>
      <tr>
        <th>ì„±ëª…</th>
        <th>ì†Œì†</th>
        ${dates.map(date => `<th>${date}</th>`).join('')}
      </tr>
    </thead>
    <tbody>
  `;

  sortedMembers.forEach(member => {
    html += `<tr><td>${member.name}</td><td>${member.team || ""}</td>`;

    dates.forEach(date => {
      const records = history[date] || [];
      const entry = records.find(r => r.name === member.name);

      let status = "";
      if (entry) {
        if (entry.leave) {
          status = "<span style='color:red; font-weight:bold;'>ì¡°í‡´</span>";
        } else if (entry.late) {
          status = "<span style='color:orange; font-weight:bold;'>ì§€ê°</span>";
        } else {
          status = "<span style='color:green; font-weight:bold;'>ì¶œì„</span>";
        }
      }

      html += `<td>${status}</td>`;
    });

    html += "</tr>";
  });

  html += "</tbody></table>";
  container.innerHTML = html;
}

function showAllScores() {
  const container = document.getElementById("allScoresArea");
  if (!container) return;

  const history = JSON.parse(localStorage.getItem("attendanceHistoryData") || "{}");
  const members = JSON.parse(localStorage.getItem("memberList") || "[]");

  const dates = Object.keys(history).sort();
  if (dates.length === 0 || members.length === 0) {
    container.innerHTML = "<p>âš ï¸ ì €ì¥ëœ ì¶œì„ ê¸°ë¡ ë˜ëŠ” íšŒì› ëª…ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
    return;
  }

  // ì ìˆ˜ ê¸°ì¤€: ì¶œì„ 10ì , ì§€ê°/ì¡°í‡´ 5ì 
  const memberScores = members.map(member => {
    const perDate = {};
    let total = 0;

    dates.forEach(date => {
      const record = history[date]?.find(r => r.name === member.name);
      let score = 0;
      if (record) {
        if (record.leave || record.late) score = 5;
        else score = 10;
      }
      perDate[date] = score;
      total += score;
    });

    return {
      name: member.name,
      team: member.team || "",
      scores: perDate,
      total
    };
  });

  // í…Œì´ë¸” ìƒì„±
  let html = `
    <div style="overflow-x: auto; max-width: 100%;">
    <table border="1" cellpadding="6" style="border-collapse: collapse; width: max-content; text-align: center; font-size: 1rem;">
      <thead style="background-color: #eee;">
        <tr>
          <th style="position: sticky; left: 0; background: #eee; z-index: 2;">ì„±ëª…</th>
          <th style="position: sticky; left: 100px; background: #eee; z-index: 2;">ì†Œì†</th>
          <th style="position: sticky; left: 200px; background: #eee; z-index: 2;">ì´ì </th>
           ${dates.map(date => `<th style="min-width: 90px;">${date}</th>`).join("")}
        </tr>
      </thead>
      <tbody>
    `;

  memberScores.forEach(m => {
  html += `<tr>
    <td style="position: sticky; left: 0; background: white; z-index: 1; min-width: 100px;">${m.name}</td>
    <td style="position: sticky; left: 100px; background: white; z-index: 1; min-width: 120px;">${m.team}</td>
    <td style="position: sticky; left: 220px; background: white; z-index: 1; min-width: 80px;"><strong>${m.total}</strong></td>
    ${dates.map(date => `<td style="min-width: 90px;">${m.scores[date]}</td>`).join("")}
  </tr>`;
});

html += "</tbody></table></div>";
  container.innerHTML = html;
}


function updateWeekday() {
  const y = parseInt(yearSelect.value);
  const m = parseInt(monthSelect.value) - 1; // 0-indexed
  const d = parseInt(daySelect.value);
  const date = new Date(y, m, d);
  const weekday = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "][date.getDay()];
  
  weekdayDisplay.textContent = `${weekday}`; // â† "ìš”ì¼" ì œê±°, í•œ ê¸€ìë§Œ í‘œì‹œ

  // ìƒ‰ìƒ ì§€ì •
  let color = "black";
  if (weekday === "í† ") color = "blue";
  if (weekday === "ì¼") color = "red";
  weekdayDisplay.style.color = color;

  // âœ… ê¸€ì í¬ê¸° í‚¤ìš°ê¸° ì¶”ê°€
  weekdayDisplay.style.fontSize = "1.6rem";  // ì›í•˜ëŠ” í¬ê¸°ë¡œ ì¡°ì ˆ ê°€ëŠ¥
}


// ì´ë²¤íŠ¸ ë°”ì¸ë”©
yearSelect.addEventListener("change", updateWeekday);
monthSelect.addEventListener("change", updateWeekday);
daySelect.addEventListener("change", updateWeekday);

populateDateSelectors();
setupDateListeners();

let selectedNames = [];
let lateStatus = {};


function updateSelectedFileName(input) {
  const fileNameDisplay = document.getElementById("fileNameDisplay");
  if (input.files.length > 0) {
    fileNameDisplay.textContent = `ì„ íƒí•œ íŒŒì¼: ${input.files[0].name}`;
    handleExcelUpload(); // âœ… íŒŒì¼ì„ ì„ íƒí•˜ë©´ ë°”ë¡œ ì²˜ë¦¬
  } else {
    fileNameDisplay.textContent = "";
  }
}

function handleExcelUpload() {
  const input = document.getElementById("excelFileInput");
  const file = input.files[0];
  if (!file) {
    alert("ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];

    const memberData = [];
    let row = 3;

    while (true) {
      const nameCell = sheet[`B${row}`];
      const teamCell = sheet[`D${row}`];
      if (!nameCell && !teamCell) break;

      const name = nameCell ? nameCell.v.trim() : "";
      const team = teamCell ? teamCell.v.trim() : "";

      if (name !== "") {
        memberData.push({ name, team });
      }
      row++;
    }

    // âœ… ì¤‘ë³µ ì—†ì´ ë³‘í•© (memberListê°€ ì˜ ë¹„ì›Œì¡ŒëŠ”ì§€ ì¬í™•ì¸)
    if (!Array.isArray(memberList)) {
      memberList = [];
    }

    const existingNames = new Set(memberList.map(m => m.name));
    const newMembers = memberData.filter(m => !existingNames.has(m.name));

    // âœ… ì—…ë¡œë“œëœ ì—‘ì…€ì„ ë°”ë¡œ ë°˜ì˜
    memberList = [...memberList, ...newMembers];
    localStorage.setItem("memberList", JSON.stringify(memberList));
    renderMemberList();

    alert("ì—‘ì…€ íŒŒì¼ì˜ íšŒì› ëª…ë‹¨ì„ ê¸°ì¡´ ëª…ë‹¨ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.");
  };

  reader.readAsArrayBuffer(file);
}


function renderMemberList() {
  const tbody = document.getElementById("memberTableBody");
  if (!tbody) return;

  const memberList = JSON.parse(localStorage.getItem("memberList") || "[]");
  tbody.innerHTML = "";

  memberList.forEach((member, index) => {
  const tr = document.createElement("tr");

  tr.innerHTML = `
    <td>${index + 1}</td>
    <td>${member.name}</td>
    <td>
      <span id="teamText${index}">${member.team}</span>
      ${showEditTeamButtons ? `
        <button onclick="showEditTeamInput(${index})" style="margin-left: 8px;">ìˆ˜ì •</button>
        <input 
          type="text" 
          id="editInput${index}" 
          value="${member.team}" 
          style="display:none; margin-left:6px; width: 90px;"
        />
        <button 
          onclick="saveEditedTeam(${index})" 
          id="saveButton${index}" 
          style="display:none; margin-left: 4px;"
        >ì €ì¥</button>
      ` : ""}
    </td>
    ${showDeleteButtons ? `
      <td>
        <button 
          onclick="deleteMember(${index}, '${member.name}')"
          class="delete-btn"
        >âŒ ì‚­ì œ</button>
      </td>
    ` : ""}
  `;

  tbody.appendChild(tr);
});

  // í…Œì´ë¸” í—¤ë”ì—ë„ ì‚­ì œ ì—´ ì¶”ê°€/ì œê±°
  const thRow = document.querySelector(".member-table thead tr");
  if (thRow) {
    const hasDeleteTh = thRow.querySelector(".delete-header");
    if (showDeleteButtons && !hasDeleteTh) {
      const th = document.createElement("th");
      th.textContent = "ì‚­ì œ";
      th.className = "delete-header";
      thRow.appendChild(th);
    } else if (!showDeleteButtons && hasDeleteTh) {
      thRow.removeChild(hasDeleteTh);
    }
  }
}


function saveMemberList() {
  localStorage.setItem("memberList", JSON.stringify(memberList));
  console.log("âœ… memberList saved at", new Date().toLocaleString());
}

function deleteMember(index, name) {
  const confirmMsg = `ì •ë§ë¡œ "${name}" íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
  if (confirm(confirmMsg)) {
    memberList.splice(index, 1);           // ë©”ëª¨ë¦¬ì—ì„œ ì‚­ì œ
    saveMemberList();                      // localStorage ë°˜ì˜
    renderMemberList();                    // í™”ë©´ ê°±ì‹ 
    console.log("âœ… ì‚­ì œ í›„ memberList:", memberList);
  }
}



function deleteAllMembers() {
  const password = prompt("ì „ì²´ ì‚­ì œë¥¼ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");

  if (password === "0301") {
    if (confirm("ì •ë§ ì „ì²´ íšŒì› ëª…ë‹¨ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      memberList = []; // ì „ì—­ ë°°ì—´ë„ ë¹„ì›€
      localStorage.removeItem("memberList"); // ì €ì¥ì†Œì—ì„œë„ ì‚­ì œ
      renderMemberList(); // í™”ë©´ ê°±ì‹ 

      alert("âœ… ì „ì²´ íšŒì› ëª…ë‹¨ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
  } else {
    alert("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }
}

function downloadMemberList() {
  if (!memberList || memberList.length === 0) {
    alert("íšŒì› ëª…ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const worksheet = XLSX.utils.json_to_sheet(memberList);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "íšŒì›ëª…ë‹¨");

  XLSX.writeFile(workbook, "íšŒì›ëª…ë‹¨.xlsx");
}

function toggleIndividualDelete() {
  showDeleteButtons = !showDeleteButtons;
  saveMemberList();
  renderMemberList();  // ë‹¤ì‹œ ê·¸ë ¤ì„œ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ë°˜ì˜
}

function toggleEditTeam() {
  showEditTeamButtons = !showEditTeamButtons;
  renderMemberList(); // í…Œì´ë¸”ì„ ë‹¤ì‹œ ê·¸ë¦¼
}

function showEditTeamInput(index) {
  document.getElementById(`teamText${index}`).style.display = "none";
  document.getElementById(`editInput${index}`).style.display = "inline-block";
  document.getElementById(`saveButton${index}`).style.display = "inline-block";

  // ğŸ”½ ìˆ˜ì • ë²„íŠ¼ ìˆ¨ê¸°ê¸°
  const editButton = document.querySelector(`#teamText${index} + button`);
  if (editButton) editButton.style.display = "none";
}

function saveEditedTeam(index) {
  const inputField = document.getElementById(`editInput${index}`);
  const newTeam = inputField.value.trim();

  if (memberList[index]) {
    memberList[index].team = newTeam;
    saveMemberList(); // = localStorage ì €ì¥

    // UI ì—…ë°ì´íŠ¸
    document.getElementById(`teamText${index}`).textContent = newTeam;
    document.getElementById(`teamText${index}`).style.display = "inline";
    inputField.style.display = "none";
    document.getElementById(`saveButton${index}`).style.display = "none";

    // âœ… ìˆ˜ì • ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê²Œ
    const editButton = document.querySelector(`#teamText${index} + button`);
    if (editButton) editButton.style.display = "inline-block";

    alert(`âœ… ì†Œì†ì´ '${newTeam}'(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  }
}


function addManualMember() {
  const nameInput = document.getElementById("manualName");
  const teamInput = document.getElementById("manualTeam");

  const name = nameInput.value.trim();
  const team = teamInput.value.trim(); // ì†Œì†ì€ ì—†ì–´ë„ í—ˆìš©

  // ì´ë¦„ í•„ìˆ˜
  if (!name) {
    alert("âš ï¸ ì„±ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }

  // ì´ë¦„ ì¤‘ë³µ ë°©ì§€
  const duplicate = memberList.some(m => m.name === name);
  if (duplicate) {
    alert("âš ï¸ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.");
    return;
  }

  // ì¶”ê°€
  memberList.push({ name, team });
  saveMemberList();
  renderMemberList();

  // ì…ë ¥ì°½ ì´ˆê¸°í™”
  nameInput.value = "";
  teamInput.value = "";

  alert(`âœ… ${name} íšŒì›ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

function openRewardSetting() {
  const pw = prompt("âš ï¸ ë³´ìƒê¸ˆ ì„¤ì •ì„ ìˆ˜ì •í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
  if (pw !== "0301") {
    alert("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
    return;
  }

  const area = document.getElementById("rewardSettingArea");
  if (!area) return;
  area.style.display = "block";

  // ê¸°ë³¸ê°’ ë˜ëŠ” ì €ì¥ëœ ê°’ ë°˜ì˜
  for (let i = 1; i <= 10; i++) {
    const input = document.getElementById(`reward${i}`);
    if (input) input.value = Number(rewardList[i - 1] || 0);
  }
}

const defaultRewardList = [120000, 70000, 60000, 50000, 50000, 30000, 30000, 30000, 30000, 30000];

// âœ… ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜ ê¸°ë³¸ê°’ ì„¤ì •
let rewardList = [];

try {
  const parsed = JSON.parse(localStorage.getItem("rewardList") || "null");
  if (Array.isArray(parsed) && parsed.length === 10) {
    rewardList = parsed;
  } else {
    rewardList = defaultRewardList;
    localStorage.setItem("rewardList", JSON.stringify(defaultRewardList));
  }
} catch (e) {
  rewardList = defaultRewardList;
  localStorage.setItem("rewardList", JSON.stringify(defaultRewardList));
}

// ë³´ìƒ ì…ë ¥ì°½ ì—´ê¸°
function showRewardInput() {
  const rewardContainer = document.getElementById("rewardSettingArea");
  rewardContainer.innerHTML = "<h3>ğŸ† ìˆœìœ„ë³„ ë³´ìƒ ê¸ˆì•¡ ì…ë ¥</h3>";

  // âœ… rewardListë¥¼ ê¸°ë°˜ìœ¼ë¡œ rewardSettings ì´ˆê¸°í™”
  rewardSettings = [];
  for (let i = 1; i <= 10; i++) {
    rewardSettings.push({ rank: i, amount: rewardList[i - 1] ?? 0 });
  }

  const listDiv = document.createElement("div");
  listDiv.style.display = "flex";
  listDiv.style.flexDirection = "column";
  listDiv.style.gap = "0.4rem";

  rewardSettings.forEach(({ rank, amount }) => {
    const line = document.createElement("div");
    line.style.display = "flex";
    line.style.alignItems = "center";
    line.style.gap = "0.6rem";

    const label = document.createElement("label");
    label.style.width = "4rem";
    label.textContent = `${rank}ë“±:`;

    const input = document.createElement("input");
    input.type = "text";
    input.id = `reward${rank}`;
    input.style.width = "140px";
    input.style.padding = "0.3rem";
    input.value = (Number(amount) || 0).toLocaleString();  // âœ… í‘œì‹œìš©: ì²œë‹¨ìœ„ ì½¤ë§ˆ

    line.appendChild(label);
    line.appendChild(input);
    listDiv.appendChild(line);
  });

  rewardContainer.appendChild(listDiv);
}

// ì €ì¥ ë²„íŠ¼ ê¸°ëŠ¥
function saveRewardList() {
  const newList = [];
  for (let i = 1; i <= 10; i++) {
    const input = document.getElementById(`reward${i}`);
    const value = parseInt(input.value.replace(/,/g, ""), 10);
    newList.push(isNaN(value) ? 0 : value);
  }

  // âœ… ì €ì¥
  localStorage.setItem("rewardList", JSON.stringify(newList));
  rewardList = newList;

  // âœ… ğŸŸ¨ ì¶”ê°€: prizeMapë„ ì¦‰ì‹œ ë°˜ì˜
  prizeMap = {};
  newList.forEach((amount, idx) => {
    prizeMap[idx + 1] = amount;
  });

  alert("âœ… ë³´ìƒê¸ˆ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
}




// ë‹«ê¸° ë²„íŠ¼ ê¸°ëŠ¥
function closeRewardSetting() {
  document.getElementById("rewardSettingArea").style.display = "none";
}

function assignTiedRanks(list) {
  let rank = 1;
  let prevScore = null;
  let actualRank = 1;

  return list.map((item, idx) => {
    if (item.score !== prevScore) {
      rank = actualRank;
      prevScore = item.score;
    }
    actualRank++;
    return { ...item, rank };
  });
}

function showTop10() {
  const rewardListRaw = JSON.parse(localStorage.getItem("rewardList") || "[]");
  const rewardList = rewardListRaw.map(v => Number(v) || 0);
  const startDate = document.getElementById("seasonStart")?.value || "ì‹œì‘ì¼";
  const endDate = document.getElementById("seasonEnd")?.value || "ë§ˆê°ì¼";

  const allScores = getAllMemberScores();
  const sorted = assignTiedRanks([...allScores].sort((a, b) =>
    b.score - a.score || a.name.localeCompare(b.name, "ko")
  )).slice(0, 10);

  let html = `<strong>ì‹œì¦Œ ê¸°ê°„:</strong> ${startDate} ~ ${endDate}<br><br>`;
  html += `<table border="1" cellpadding="8" style="border-collapse: collapse; width: 100%; text-align: center;">
    <thead style="background-color: #eee;">
      <tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>í¬ìƒê¸ˆ (ì˜ˆì •)</th></tr>
    </thead><tbody>`;

  sorted.forEach(p => {
    const prize = rewardList[p.rank - 1] || 0;
    html += `
      <tr>
        <td>${p.rank}ìœ„</td>
        <td>${p.name}</td>
        <td>${prize.toLocaleString("ko-KR")}ì›</td>
      </tr>
    `;
  });

  html += "</tbody></table>";
  document.getElementById("top10Display").innerHTML = html;
}

function toggleTop10() {
  const container = document.getElementById("top10Display");
  if (!container) return;

  if (container.style.display === "none" || container.style.display === "") {
    container.style.display = "block";
    showTop10();
  } else {
    container.style.display = "none";
  }
}

function toggleAllScores() {
  const container = document.getElementById("allScoresArea");
  if (!container) return;

  if (container.style.display === "none" || container.style.display === "") {
    container.style.display = "block";
    showAllScores(); // âœ… ë‚´ìš© í‘œì‹œ
  } else {
    container.style.display = "none";
  }
}

function toggleAttendanceHistory() {
  const container = document.getElementById("attendanceHistory");
  if (!container) return;

  // ì´ë¯¸ ë³´ì´ë©´ ìˆ¨ê¹€, ìˆ¨ê²¨ì ¸ ìˆìœ¼ë©´ í‘œì‹œ
  if (container.style.display === "none" || container.style.display === "") {
    container.style.display = "block";
    renderAttendanceHistory();  // âœ… ì €ì¥ëœ ì¶œì„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  } else {
    container.style.display = "none";
  }
}


function getAllMemberScores() {
  if (!window.attendanceHistoryData || !Array.isArray(memberList)) return [];

  const memberNames = memberList.map(m => m.name);
  const scores = {};

  for (const date in attendanceHistoryData) {
    attendanceHistoryData[date].forEach(entry => {
      if (memberNames.includes(entry.name)) {
        if (!scores[entry.name]) scores[entry.name] = 0;
        scores[entry.name] += entry.score;
      }
    });
  }

  return Object.entries(scores).map(([name, score]) => ({ name, score }));
}

function debugAddRandomAttendance(count = 27) {
  if (!Array.isArray(memberList) || memberList.length < count) {
    alert("íšŒì› ëª…ë‹¨ì„ ë¨¼ì € ì—…ë¡œë“œí•˜ê±°ë‚˜, ì¶©ë¶„í•œ ì¸ì›ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.");
    return;
  }

  // ì „ì—­ ìƒíƒœ ì´ˆê¸°í™”
  selectedNames = [];
  lateStatus = {};
  confirmedSelections = {};
  finalTeamResults = {};

  // memberListì—ì„œ ë¬´ì‘ìœ„ë¡œ countëª… ì¶”ì¶œ
  const shuffled = [...memberList].sort(() => Math.random() - 0.5);
  const selected = shuffled.slice(0, count);
  selectedNames = selected.map(m => `${m.name}__${m.team || ""}`);  // ë°˜ë“œì‹œ name__team í¬ë§·

  // UI ë° ìš”ì•½ ê°±ì‹ 
  renderSelectedTable();
  renderNameDropdown?.();

  alert(`âœ… ëœë¤ ${count}ëª…ì´ ì¶œì„ ëª…ë‹¨ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

function handleNameSelect(select) {
  const input = document.getElementById("nonMemberInput");
  if (input) {
    input.style.display = (select.value === "__ë¹„íšŒì›__") ? "inline-block" : "none";
  }
}
function insertSelectedNameMid() {
  const select = document.getElementById("nameSelect");
  let key = select.value;

  if (!key) {
    alert("ì„±ëª…ì„ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  if (key === "__ë¹„íšŒì›__") {
    const input = document.getElementById("nonMemberInput");
    const name = input.value.trim();
    if (!name) {
      alert("ë¹„íšŒì› ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }
    key = `${name}__`;
  }

  if (selectedNames.includes(key)) {
    alert("ì´ë¯¸ ì¶œì„ ëª…ë‹¨ì— ìˆëŠ” ì´ë¦„ì…ë‹ˆë‹¤.");
    return;
  }

  const mid = Math.floor(selectedNames.length / 2);
  selectedNames.splice(mid, 0, key);

  renderSelectedTable();
  renderNameDropdown();

  // ì„ íƒê°’ ë° ì…ë ¥ì°½ ì´ˆê¸°í™”
  select.value = "";
  const input = document.getElementById("nonMemberInput");
  if (input) input.value = "";
  if (input) input.style.display = "none";
}

function moveToMatchTab1() {
  const h2 = document.querySelector('#matchTab h2');
  if (h2) {
    h2.style.display = "block"; // íƒ€ì´í‹€ì´ ìˆ¨ê²¨ì ¸ ìˆìœ¼ë©´ ë³´ì´ê²Œ
  }

  const matchTabDiv = document.getElementById("matchTab");
  if (matchTabDiv) {
    showTab("matchTab"); // âœ… ìƒìœ„ íƒ­ìœ¼ë¡œ ì´ë™ (ì´ë¯¸ ìˆìœ¼ë¯€ë¡œ ìœ ì§€)
    setTimeout(() => {
      window.scrollTo({ top: matchTabDiv.offsetTop, behavior: "smooth" });
    }, 100);
  }
}

function assignAllToATeam() {
  const teamA = [...selectedNames];
  const teamB = [];

  localStorage.setItem("autoTeamA", JSON.stringify(teamA));
  localStorage.setItem("autoTeamB", JSON.stringify(teamB));

  renderMatchTeam("A", teamA);
  renderMatchTeam("B", teamB);

  recommendFormation("A", teamA.length);
  recommendFormation("B", 0); // ì¶”ì²œ ì œê±°
}
function recommendFormation(team, count) {
  const select = document.getElementById(`formation${team}Select`);
  const suggestSpan = document.getElementById(`suggest${team}`);
  const suggestLabel = document.getElementById(`suggest${team}Label`);

  let suggestion = "";

  if (count >= 11) {
    suggestion = "4-4-2";
  } else if (count === 10) {
    suggestion = "4-3-2";
  } else if (count === 9) {
    suggestion = "3-3-2-1";
  } else {
    suggestion = "ì‚¬ìš©ì ì§€ì • í•„ìš”";
  }

  // ì¶”ì²œ í‘œì‹œ
  if (suggestSpan) suggestSpan.textContent = suggestion;
  if (suggestLabel) suggestLabel.style.display = "inline-block";

  // selectì— ì¶”ì²œê°’ ìë™ ì„¤ì •
  if (select) {
    select.value = suggestion === "ì‚¬ìš©ì ì§€ì • í•„ìš”" ? "custom" : suggestion;
    select.dispatchEvent(new Event("change"));
  }
}

function renderMatchTeam(team, list) {
  const container = document.getElementById(`match${team}Info`);
  const countSpan = document.getElementById(`match${team}Count`);
  const restSpan = document.getElementById(`rest${team}Count`);

  if (countSpan) countSpan.textContent = list.length;
  if (restSpan) restSpan.textContent = 0;

  // ì¶”ê°€ì ìœ¼ë¡œ í¬ì§€ì…˜ UI ë Œë”ë§ë„ ê°€ëŠ¥
}

function setupVotingOrder(team = null) {
  let players;

  if (team && window.finalTeamResults?.[team]) {
    players = finalTeamResults[team];
  } else {
    players = matchPlayers;
  }

  const total = players.length;
  const voteOrder = [...players];

  const playerVoteCount = voteOrder.map((_, idx) => {
    if (idx < 2) return 3;
    if (idx < Math.ceil(total / 2)) return 2;
    return 1;
  });

  window.voteOrder = voteOrder;
  window.playerVoteCount = playerVoteCount;

  console.log("âœ… voteOrder:", voteOrder.map(p => p.name));
  console.log("âœ… playerVoteCount:", playerVoteCount);
}



function renderEnvelopes() {
  const container = document.getElementById("envelopeArea");
  if (!container) {
    console.error("âŒ envelopeAreaê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  container.innerHTML = "";
  container.style.display = "flex";
  container.style.flexWrap = "wrap";
  container.style.justifyContent = "center";
  container.style.gap = "5px";

  const votes = playerVoteCount[currentPlayerIndex];

  for (let i = 0; i < shuffledNotes.length; i++) {
    const isPicked = pickedIndexes.includes(i);
    const isConfirmed = confirmedIndexes.includes(i);
    const number = i + 1;
    const isEven = i % 2 === 0;

    const box = document.createElement("div");
    box.id = `envelope-${i}`;
    box.className = "envelope-box envelope";

    // âœ… ê¸°ë³¸ í…ìŠ¤íŠ¸
      if (confirmedIndexes.includes(i)) {
  // ì´ë¯¸ í™•ì •ëœ ìª½ì§€ â†’ ê³ ì •
      box.textContent = "ì™„ë£Œ";
      box.style.backgroundColor = "#c0c0c0";
      box.style.pointerEvents = "none";
    } else if (pickedIndexes.includes(i)) {
      // í˜„ì¬ ê³ ë¥´ëŠ” ì¤‘ì¸ ìª½ì§€
      box.textContent = "âœ…";
      box.style.backgroundColor = "#fff59d";
      box.style.pointerEvents = "auto";
    } else {
      // ì•„ì§ ì„ íƒ ì•ˆ ëœ ìª½ì§€
      box.textContent = number;
      box.style.backgroundColor = isEven ? "#e3f2fd" : "#fff3e0";
      box.style.pointerEvents = "auto";
    }


    // âœ… ê³µí†µ ìŠ¤íƒ€ì¼
    box.style.width = "calc(100% / 7)";
    box.style.aspectRatio = "16 / 10";
    box.style.boxSizing = "border-box";   // âœ… ì¤‘ìš”!
    box.style.border = "1px solid #888";
    box.style.margin = "0";
    box.style.fontSize = "1.3rem";
    box.style.fontWeight = "bold";
    box.style.display = "flex";
    box.style.alignItems = "center";
    box.style.justifyContent = "center";
    box.style.userSelect = "none";
    box.style.transition = "transform 0.2s ease-in-out";

    // âœ… ìƒíƒœë³„ ìŠ¤íƒ€ì¼
    if (isConfirmed) {
      box.style.cursor = "not-allowed";
      box.style.pointerEvents = "none";
      box.style.opacity = "0.6";
      box.style.backgroundColor = "#d0d0d0";
      box.style.color = "#333";
      box.style.fontStyle = "italic";
    } else {
      box.style.cursor = "pointer";
      box.style.pointerEvents = "auto";
      box.style.opacity = "1";
      box.style.color = "#000";
      box.style.backgroundColor = isEven ? "#e3f2fd"  // ì§ìˆ˜: ì—°í•˜ëŠ˜ìƒ‰
    : "#fff3e0"; // í™€ìˆ˜: ì‚´êµ¬ìƒ‰
    }

    // âœ… í´ë¦­ ì´ë²¤íŠ¸
    if (!isPicked && !isConfirmed) {
      box.onclick = () => {
        pickedIndexes.push(i);
        renderEnvelopes();

        // âœ… í˜„ì¬ ë½‘ê¸° ìˆ˜
        const currentVotes = playerVoteCount[currentPlayerIndex] || 1;

        // âœ… ë½‘íŒ ìª½ì§€ ì €ì¥
        if (pickedIndexes.length > 0) {
          lastSelections = pickedIndexes.map(index => ({
            index,
            value: shuffledNotes[index]
          }));
        }

        // âœ… ìª½ì§€ë¥¼ ëª¨ë‘ ë½‘ì•˜ë‹¤ë©´ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
        if (pickedIndexes.length === currentVotes) {
          openedEnvelopes = [...lastSelections];
          showSelectionModal(); // ğŸ¯ ì‚¬ìš©ì ì„ íƒ ìœ ë„
        }
      };
    }

    container.appendChild(box);
  }
}

function showVotingInfo() {
  const player = voteOrder[currentPlayerIndex];
  const votes = playerVoteCount[currentPlayerIndex];

  if (!player || typeof votes === "undefined") {
    console.warn("ì„ íƒí•  í”Œë ˆì´ì–´ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const infoEl = document.getElementById("drawPlayerInfo");
  if (infoEl) {
    infoEl.textContent = `ğŸ‘¤ ${player.name} ì„ ìƒë‹˜, ${votes}ì¥ ë½‘ê¸°`;
  }

  console.log(`ğŸ¯ í˜„ì¬ ìˆœì„œ: ${currentPlayerIndex + 1} / ì´ë¦„: ${player.name}, ë½‘ê¸° ìˆ˜: ${votes}`);
}


function showSelectionModal() {
  const content = document.getElementById("selectionContent");
  content.innerHTML = "";

  content.style.display = "flex";
  content.style.flexWrap = "wrap";
  content.style.justifyContent = "center";
  content.style.gap = "0.8rem";

  if (!openedEnvelopes || openedEnvelopes.length === 0) {
    content.innerHTML = `<p style="font-size:1.2rem; color: red;">ì„ íƒ ê°€ëŠ¥í•œ ìª½ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
    return;
  }

  const player = voteOrder[currentPlayerIndex];
  const playerName = player?.name || "ì„ íƒì";

  const nameDiv = document.createElement("div");
  nameDiv.textContent = `ğŸ‘¤ ${playerName} ì„ ìƒë‹˜ ì„ íƒ ì¤‘`;
  nameDiv.style.fontSize = "1.1rem";
  nameDiv.style.marginBottom = "1.1rem";
  nameDiv.style.fontWeight = "bold";
  nameDiv.style.width = "100%";
  nameDiv.style.textAlign = "center";
  content.appendChild(nameDiv);

  // âœ… ì—¬ê¸°ì„œ idxë„ í•¨ê»˜ ë°›ë„ë¡ ìˆ˜ì •
  openedEnvelopes.forEach((item, idx) => {
    const value = item?.value;
    if (typeof value !== "string") return;

    const match = value.match(/^(AíŒ€|BíŒ€|CíŒ€)?\s*(.*)$/);
    const teamKor = match?.[1] || "";
    const position = match?.[2] || value;
    const team = teamKor.replace("íŒ€", "");

    const btn = document.createElement("button");
    btn.className = "diagonal-box";

    // âœ… í¬ì§€ì…˜ë³„ ì´ëª¨ì§€ ì„¤ì •
    let icon = "";
    if (position === "GK") icon = "ğŸ¥…";
    else if (position === "DF") icon = "ğŸ§±";
    else if (position === "MF") icon = "ğŸƒğŸ¿";
    else if (position === "FW") icon = "âš½";
    else if (position === "REF") icon = "âš–ï¸";
    else if (position === "íœ´ì‹") icon = "ğŸ’¤";

    btn.setAttribute("data-icon", icon);

    // âœ… ì• ë‹ˆë©”ì´ì…˜ ìˆœì°¨ íš¨ê³¼
    btn.style.animationDelay = `${idx * 0.1}s`;

    btn.onclick = () => {
      confirmSelection(item.index);
      closeSelectionModal();
    };

    if (team === "A") btn.style.backgroundColor = "#fff9c4";
    else if (team === "B") btn.style.backgroundColor = "#ffe0b2";
    else if (team === "C") btn.style.backgroundColor = "#e1f5fe";
    else btn.style.backgroundColor = "#ffffff";

    const teamDiv = document.createElement("div");
    teamDiv.className = "team";
    teamDiv.textContent = team;
    teamDiv.style.fontSize = "1.8rem";     // âœ… íŒ€ ê¸€ì”¨ í‚¤ì›€
    teamDiv.style.fontWeight = "bold";

    const posDiv = document.createElement("div");
    posDiv.className = "position";
    posDiv.textContent = position;
    posDiv.style.fontSize = "1.4rem";      // âœ… í¬ì§€ì…˜ ë” í¬ê²Œ
    posDiv.style.fontWeight = "bold";

    btn.appendChild(teamDiv);
    btn.appendChild(posDiv);
    content.appendChild(btn);
  });

  document.getElementById("selectionModal").style.display = "block";
}



function closeSelectionModal() {
  document.getElementById("selectionModal").style.display = "none";
}
function openEnvelopeModal() {
  document.getElementById("envelopeModal").style.display = "flex";
}

function closeEnvelopeModal() {
  const modal = document.getElementById("envelopeModal");
  if (modal) modal.style.display = "none";
}


function confirmSelection(index) {
  const selected = openedEnvelopes.find(e => e.index === index);
  const player = voteOrder[currentPlayerIndex];

  if (!selected || !player || typeof selected.index === "undefined") {
    alert("ì„ íƒ ì˜¤ë¥˜ ë°œìƒ");
    return;
  }

  // âœ… íŒ€/í¬ì§€ì…˜ ì¶”ì¶œ ë° ì €ì¥
  const match = selected.value.match(/^(AíŒ€|BíŒ€|CíŒ€)\s*(.*)$/);
  if (match) {
    const team = match[1].replace("íŒ€", "");
    const position = match[2];
    confirmedSelections[team][player.name] = position;
  }

  confirmedIndexes.push(selected.index);
  confirmedIndexesMap[player.name] = selected.index;
  fixedNotes.push({ index: selected.index, value: selected.value });

  // âœ… ì„ íƒëœ ë°•ìŠ¤ UI ê³ ì •
  const box = document.getElementById(`envelope-${selected.index}`);
  if (box) {
    box.textContent = "ì™„ë£Œ";
    box.style.pointerEvents = "none";
    box.style.opacity = "0.6";
    box.style.backgroundColor = "#c0c0c0"; // âœ… ëª…ì‹œì ìœ¼ë¡œ íšŒìƒ‰ ì§€ì •
  }

  // âœ… ë‚˜ë¨¸ì§€ ì—´ë¦° ìª½ì§€ ë³µì›
  openedEnvelopes.forEach(item => {
  if (item.index !== selected.index) {
    const otherBox = document.getElementById(`envelope-${item.index}`);
    if (otherBox) {
      otherBox.textContent = item.index + 1; // ğŸ” ìª½ì§€ ë²ˆí˜¸ë¡œ ë³µì›
      otherBox.style.pointerEvents = "auto";
      otherBox.style.opacity = "1";
    }
  }
});

  console.log("ğŸ§¾ ì„ íƒëœ ìª½ì§€ ë‚´ìš©:", selected.value);

  // âœ… ì‹¤ì‹œê°„ íŒ€ í…Œì´ë¸” ì—…ë°ì´íŠ¸
  renderLiveTeamTable();

  // âœ… ìƒíƒœ ì´ˆê¸°í™”
  currentPlayerIndex++;
  pickedIndexes = [];
  openedEnvelopes = [];

  // âœ… ê³ ì •ëœ ìª½ì§€ ì œì™¸í•˜ê³  ì…”í”Œ ë‹¤ì‹œ
  shuffleAvailableNotes();

  if (currentPlayerIndex >= voteOrder.length) {
  console.log("âœ… ëª¨ë“  ìª½ì§€ ì„ íƒ ì™„ë£Œ");
  
 window.finalTeamResults = {
  A: sortTeamByCustomRule(Object.entries(confirmedSelections.A).map(([name, position]) => ({ name, position }))),
  B: sortTeamByCustomRule(Object.entries(confirmedSelections.B).map(([name, position]) => ({ name, position }))),
  C: sortTeamByCustomRule(Object.entries(confirmedSelections.C).map(([name, position]) => ({ name, position })))
};

  localStorage.setItem("finalTeamResults", JSON.stringify(window.finalTeamResults));

 // âœ… ê²½ê¸° í¸ì„± 2ê²½ê¸° íƒ­ë„ ìë™ìœ¼ë¡œ ë³´ì´ê²Œ ì„¤ì •
  const teamTabBtn = document.getElementById("teamTabButton");
if (teamTabBtn) {
  teamTabBtn.style.display = "inline-block";
}

const matchSetup2Btn = document.getElementById("matchSetup2Button");
if (matchSetup2Btn) {
  matchSetup2Btn.style.display = "inline-block";
}
  showTab('teamTab');  // âœ… ë²„íŠ¼ ê°•ì¡°, active í´ë˜ìŠ¤ ë°˜ì˜ í¬í•¨

  displayFinalTeamResults();
  closeEnvelopeModal();
} else {
  // âœ… ë‹¤ìŒ ì‚¬ëŒ ìˆì„ ê²½ìš° â†’ UI ê°±ì‹  í•„ìˆ˜
  renderEnvelopes();
  showVotingInfo();
}

}



function moveToTeamTab() {
  showTab("teamTab"); // 1ï¸âƒ£ íƒ­ ì „í™˜

  if (window.confirmedSelections && Object.keys(window.confirmedSelections).length > 0) {
    const finalResults = { A: [], B: [], C: [] };

    // 2ï¸âƒ£ ìª½ì§€ ê°’ì—ì„œ "AíŒ€ FW"ì²˜ëŸ¼ íŒ€ëª…/í¬ì§€ì…˜ ë¶„ë¦¬
    Object.entries(window.confirmedSelections).forEach(([name, pos]) => {
      const match = pos.trim().match(/^(AíŒ€|BíŒ€|CíŒ€)\s*(.*)$/);
      if (match) {
        const team = match[1].replace("íŒ€", ""); // 'AíŒ€' â†’ 'A'
        const position = match[2];
        finalResults[team].push({ name, position });
      }
    });

    // 3ï¸âƒ£ ì €ì¥ ë° ë Œë”ë§
    window.finalTeamResults = finalResults;
    localStorage.setItem("finalTeamResults", JSON.stringify(finalResults));
    displayFinalTeamResults(); // 4ï¸âƒ£ í…Œì´ë¸” ìƒì„±
  }
}
function displayFinalTeamResults() {
  const container = document.getElementById("teamDivisionResult");
  if (!container) return;

  container.innerHTML = "";

  const colorMap = { A: "#fff9c4", B: "#ffe0b2", C: "#bbdefb" };

  // ì¶œì„ ìˆœ ì •ë³´ ë§¤í•‘
  const attendanceOrder = {};
  matchPlayers.forEach((p, i) => attendanceOrder[p.name] = i);

  // íŒ€ ë©¤ë²„ ì •ë ¬ í•¨ìˆ˜
  const sortTeamMembers = (members) => {
    return [...members].sort((a, b) => {
      const getRank = (player) => {
        if (attendanceOrder[player.name] === 0) return 0;  // íŒ€ ë‚´ ì¶œì„ 1ë“±
        if (player.position === "ì‹¬íŒ") return 1;
        if (player.position === "íœ´ì‹") return 2;
        return 3;
      };

      const rankA = getRank(a);
      const rankB = getRank(b);
      if (rankA !== rankB) return rankA - rankB;

      return (attendanceOrder[a.name] || 999) - (attendanceOrder[b.name] || 999);
    });
  };

  // íŒ€ í…Œì´ë¸” ìƒì„± í•¨ìˆ˜
  const createTeamBox = (team, members) => {
    const sorted = members;

    const wrapper = document.createElement("div");
    wrapper.className = "team-box";
    wrapper.style.backgroundColor = colorMap[team];

        // âœ… íŒ€ ì œëª© ì¶”ê°€
      const title = document.createElement("div");
      title.className = "team-title";
      title.textContent = `${team}íŒ€`;
      title.style.textAlign = "center";
      title.style.fontWeight = "bold";
      title.style.fontSize = "1.4rem";
      title.style.marginBottom = "0.5rem";
      wrapper.appendChild(title);

    const table = document.createElement("table");
    table.style.width = "100%";
    table.style.borderCollapse = "collapse";

    // âœ… ë‚´ë¶€ ë°°ê²½ìƒ‰ë§Œ ì„¤ì •
    if (team === "A") table.style.backgroundColor = "#fff9c4";
    else if (team === "B") table.style.backgroundColor = "#ffe0b2";
    else if (team === "C") table.style.backgroundColor = "#bbdefb";
        const thead = document.createElement("thead");
    thead.innerHTML = `<tr><th>ìˆœ</th><th>ì„±ëª…</th><th>í¬ì§€ì…˜</th></tr>`;
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    sorted.forEach((player, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${player.name}</td>
        <td>${player.position}</td>
      `;
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    wrapper.appendChild(table);
    return wrapper;
  };

  // ê° íŒ€ ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ê¸°
  const results = window.finalTeamResults || {};
  const teamA = results.A || [];
  const teamB = results.B || [];
  const teamC = results.C || [];

  const teamWrapper = document.createElement("div");
  teamWrapper.className = "team-wrapper";

  const rowAB = document.createElement("div");
  rowAB.className = "row-ab";
  rowAB.appendChild(createTeamBox("A", teamA));
  if (teamB.length > 0) rowAB.appendChild(createTeamBox("B", teamB));
  teamWrapper.appendChild(rowAB);

  if (teamC.length > 0) {
    const rowC = document.createElement("div");
    rowC.className = "row-c";
    rowC.appendChild(createTeamBox("C", teamC));
    teamWrapper.appendChild(rowC);
  }

  container.appendChild(teamWrapper);
}


function updateDrawButtonsStatus() {
  const result = JSON.parse(localStorage.getItem("finalTeamResults") || "{}");

  const teamKeys = ["A", "B", "C"];
  teamKeys.forEach((team) => {
    const hasTeam = result[team] && result[team].length > 0;
    const btn = document.getElementById(`drawTeam${team}Button`);
    if (btn) {
      btn.disabled = !hasTeam;
      btn.style.opacity = hasTeam ? "1" : "0.4";
      btn.style.cursor = hasTeam ? "pointer" : "not-allowed";
    }
  });
}


function resetEnvelopeSelection() {
  const lastSelectedName = voteOrder[currentPlayerIndex - 1]?.name;

  if (!lastSelectedName || !confirmedSelections[lastSelectedName]) {
    alert("ì´ì „ ì„ íƒ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // âœ… ë˜ëŒë¦¬ê¸°
  currentPlayerIndex--;
  const playerName = lastSelectedName;

  // âœ… ì„ íƒê°’, ì¸ë±ìŠ¤, ê³ ì • ìª½ì§€ ì œê±°
  const targetIndex = confirmedIndexesMap?.[playerName];
  const selectedValue = confirmedSelections[playerName];

  if (typeof targetIndex === "number") {
    confirmedIndexes = confirmedIndexes.filter(idx => idx !== targetIndex);
    fixedNotes = fixedNotes.filter(f => f.index !== targetIndex);
    delete confirmedIndexesMap[playerName];
  }

  delete confirmedSelections[playerName];

  // âœ… finalTeamResultsì—ì„œ ì œê±°
  if (window.finalTeamResults) {
    for (const team in finalTeamResults) {
      finalTeamResults[team] = finalTeamResults[team].filter(p => p.name !== playerName);
    }
    localStorage.setItem("finalTeamResults", JSON.stringify(finalTeamResults));
  }

  // âœ… ì‹¤ì‹œê°„ í…Œì´ë¸” ê°±ì‹ 
  renderLiveTeamTable?.();

  // âœ… ìª½ì§€ ë‹¤ì‹œ ì…”í”Œ (ê³ ì • ì œì™¸)
  shuffleAvailableNotes(); // ğŸ¯ ë°˜ë“œì‹œ fixedNotes ê¸°ë°˜ìœ¼ë¡œ shuffledNotes ì¬ìƒì„±

  // âœ… ì´ì „ ì„ íƒ ìª½ì§€ ë³µì›
  openedEnvelopes = [{
    index: targetIndex,
    value: selectedValue
  }];
  pickedIndexes = [];

  // âœ… UI ê°±ì‹ 
  renderEnvelopes();
  showSelectionModal();
  setTimeout(() => showVotingInfo(), 200);

  console.log(`ğŸ” ë‹¤ì‹œ ì„ íƒ: ${playerName}`);
}

function fullResetDraw() {
  if (!confirm("ì •ë§ í¬ì§€ì…˜ ë½‘ê¸°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  // âœ… ìƒíƒœ ì´ˆê¸°í™”
  currentPlayerIndex = 0;
  pickedIndexes = [];
  openedEnvelopes = [];
  confirmedSelections = {};
  confirmedIndexes = [];

  // âœ… UI ì´ˆê¸°í™”
  renderEnvelopes();

  // âœ… ìµœì¢… íŒ€ ê²°ê³¼ í…Œì´ë¸” ì´ˆê¸°í™”
  const resultTable = document.getElementById("teamDivisionResult");
  if (resultTable) resultTable.innerHTML = "";

  // âœ… ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° í…Œì´ë¸” ì´ˆê¸°í™”
  const livePreview = document.getElementById("liveTeamPreview");
  if (livePreview) livePreview.innerHTML = "";

  console.log("â™»ï¸ ì „ì²´ í¬ì§€ì…˜ ë½‘ê¸° ì´ˆê¸°í™” ì™„ë£Œ");
}


function renderLiveTeamTable() {
  const container = document.getElementById("liveTeamPreview");
  if (!container) return;

  const teams = { A: [], B: [], C: [] };
  for (const team of ["A", "B", "C"]) {
    const selections = confirmedSelections?.[team];
    if (!selections) continue;
    for (const [name, position] of Object.entries(selections)) {
      teams[team].push({ name, position });
    }
  }

  const teamColors = {
    A: "#fff9c4",  // ì—°ë…¸ë‘
    B: "#ffe0b2",  // ì—°ì£¼í™©
    C: "#e1f5fe"   // ì—°íŒŒë‘
  };

  // âœ… A/BíŒ€ ë‚˜ë€íˆ ì¶œë ¥
  let html = `
    <div style="display: flex; flex-wrap: nowrap; justify-content: space-between; gap: 0.4rem; width: 100%; margin-top: 0.4rem;">
  `;

  for (const team of ["A", "B"]) {
    const members = teams[team];
    html += `
      <div style="
        flex: 0 0 auto;
        width: 48%;
        min-width: 200px;
        max-width: 220px;
        box-sizing: border-box;
        padding: 0.8rem;
        border-radius: 10px;
        background: white;
        font-size: 1.15rem;
      ">
        <h4 style="text-align: center; font-size: 1.5rem; margin-bottom: 0.6rem;">${team}íŒ€</h4>
        <table style="width: 100%; text-align: center; background: ${teamColors[team]}; font-size: 1.05rem; border-radius: 8px; border-collapse: collapse;">
          <thead><tr><th>ìˆœ</th><th>ì´ë¦„</th><th>í¬ì§€ì…˜</th></tr></thead>
          <tbody>
    `;
    if (members.length === 0) {
      html += `
        <tr><td colspan="3" style="color: #aaa; padding: 0.8rem;">ì•„ì§ ì„ íƒë˜ì§€ ì•ŠìŒ</td></tr>
      `;
    } else {
      members.forEach((p, i) => {
        html += `<tr><td>${i + 1}</td><td>${p.name}</td><td>${p.position}</td></tr>`;
      });
    }
    html += `</tbody></table></div>`;
  }

  html += `</div>`;  // A/B íŒ€ wrapper ë

  // âœ… CíŒ€ì€ ìˆì„ ë•Œë§Œ ì¶œë ¥ (AíŒ€ ì•„ë˜ ì¤‘ì•™)
  const cMembers = teams["C"];
  if (cMembers.length > 0) {
    html += `
      <div style="width: 100%; display: flex; justify-content: center; margin-top: 1.5rem;">
        <div style="
          width: 95%;
          max-width: 220px;
          box-sizing: border-box;
          padding: 0.8rem;
          border-radius: 10px;
          background: white;
          font-size: 1.15rem;
        ">
          <h4 style="text-align: center; font-size: 1.5rem; margin-bottom: 0.6rem;">CíŒ€</h4>
          <table style="width: 100%; text-align: center; background: ${teamColors["C"]}; font-size: 0.9rem; border-radius: 8px; border-collapse: collapse;">
            <thead><tr><th>ìˆœ</th><th>ì´ë¦„</th><th>í¬ì§€ì…˜</th></tr></thead>
            <tbody>
    `;
    cMembers.forEach((p, i) => {
      html += `<tr><td>${i + 1}</td><td>${p.name}</td><td>${p.position}</td></tr>`;
    });
    html += `</tbody></table></div></div>`;
  }

  container.innerHTML = html;
}

function shuffle(array) {
  const result = [...array]; // ì›ë³¸ í›¼ì† ë°©ì§€
  for (let i = result.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [result[i], result[j]] = [result[j], result[i]];
  }
  return result;
}

function shuffleAvailableNotes() {
  if (!originalNotes || originalNotes.length === 0) {
    alert("âŒ originalNotesê°€ ë¹„ì–´ ìˆì–´ ì…”í”Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    throw new Error("originalNotes is empty");
  }

  const allNotes = [...originalNotes];
  const noteCountMap = {}; // âœ… ìª½ì§€ë³„ ê°œìˆ˜ ì¶”ì 

  allNotes.forEach(note => {
    noteCountMap[note] = (noteCountMap[note] || 0) + 1;
  });

  fixedNotes.forEach(f => {
    if (noteCountMap[f.value]) {
      noteCountMap[f.value] -= 1;
    }
  });

  // âœ… ë‚¨ì€ ìœ ë™ ìª½ì§€ ì¶”ì¶œ
  const floating = [];
  Object.entries(noteCountMap).forEach(([note, count]) => {
    for (let i = 0; i < count; i++) {
      floating.push(note);
    }
  });

  const expectedCount = allNotes.length - fixedNotes.length;
  if (floating.length < expectedCount) {
    const shortage = expectedCount - floating.length;
    alert(`âŒ ì˜¤ë¥˜: ì…”í”Œí•  ìœ ë™ ìª½ì§€ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤ (${shortage}ê°œ ëˆ„ë½)\nìª½ì§€ ì¤‘ë³µ ì²˜ë¦¬ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
    throw new Error("ìœ ë™ ìª½ì§€ ë¶€ì¡±");
  }

  const shuffledFloating = shuffle(floating);
  shuffledNotes = [];
  let floatIdx = 0;

  for (let i = 0; i < allNotes.length; i++) {
    const fixed = fixedNotes.find(f => f.index === i);

    if (fixed) {
      shuffledNotes[i] = fixed.value;
    } else if (floatIdx < shuffledFloating.length) {
      shuffledNotes[i] = shuffledFloating[floatIdx++];
    } else {
      shuffledNotes[i] = "ì˜¤ë¥˜";
    }
  }

  console.log("âœ… shuffledNotes ìµœì¢…:", shuffledNotes);
}



function cancelPositionDraw() {
  if (!confirm("ì •ë§ í¬ì§€ì…˜ ë½‘ê¸°ë¥¼ ì™„ì „íˆ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì§„í–‰ ì¤‘ì¸ ë°ì´í„°ëŠ” ëª¨ë‘ ì´ˆê¸°í™”ë©ë‹ˆë‹¤)")) return;

  // ìƒíƒœ ì´ˆê¸°í™”
  currentPlayerIndex = 0;
  pickedIndexes = [];
  openedEnvelopes = [];
  confirmedSelections = {};
  confirmedIndexes = [];
  confirmedIndexesMap = {};
  fixedNotes = [];
  voteOrder = [];
  playerVoteCount = [];
  shuffledNotes = [];
  originalNotes = [];

  // ëª¨ë‹¬ ë‹«ê¸°
  document.getElementById("envelopeModal").style.display = "none";

  // UI ì´ˆê¸°í™”
  const preview = document.getElementById("liveTeamPreview");
  if (preview) preview.innerHTML = "";

  const envelopeArea = document.getElementById("envelopeArea");
  if (envelopeArea) envelopeArea.innerHTML = "";

  alert("âœ… í¬ì§€ì…˜ ë½‘ê¸°ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
}

function parseFormation(team) {
  const formationSelect = document.getElementById(`formation${team}Select`);
  const starterInput = document.getElementById(`match${team}Starter`);

  if (!formationSelect || !starterInput) {
    console.warn(`âŒ ${team}íŒ€ í¬ë©”ì´ì…˜ ë˜ëŠ” ì„ ë°œ ì¸ì› ì…ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.`);
    return null;
  }

  const formationValue = formationSelect.value;
  const starter = parseInt(starterInput.value || 0);

  let df = 0, mf = 0, fw = 0;
  if (formationValue === "custom") {
    df = parseInt(document.getElementById(`df${team}`).value || 0);
    mf = parseInt(document.getElementById(`mf${team}`).value || 0);
    fw = parseInt(document.getElementById(`fw${team}`).value || 0);
  } else {
    [df, mf, fw] = formationValue.split("-").map(Number);
  }

  return { df, mf, fw, starter };
}

function generateTeamNotes(teamName, df, mf, fw, starter, total) {
  const notes = [];

  if (!total || total === 0) {
    console.warn(`âš ï¸ ${teamName} ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤. ìª½ì§€ ìƒì„± ìƒëµ`);
    return [];
  }

  // âœ… í¬ì§€ì…˜ ìª½ì§€ ìƒì„±
  notes.push(`${teamName} GK`);
  notes.push(...Array(df).fill(`${teamName} DF`));
  notes.push(...Array(mf).fill(`${teamName} MF`));
  notes.push(...Array(fw).fill(`${teamName} FW`));

  const used = 1 + df + mf + fw;
  const nonStarters = total - used;

  if (nonStarters > 0) notes.push(`${teamName} ì‹¬íŒ`);
  if (nonStarters > 1) notes.push(...Array(nonStarters - 1).fill(`${teamName} íœ´ì‹`));

  console.log(`ğŸ§¾ ${teamName} ì´ ì¸ì›: ${total}, í¬ì§€ì…˜: ${used}, ì‹¬íŒ/íœ´ì‹: ${nonStarters}`);
  return notes;
}


function drawMatchPositions(team = null) {
  try {
    console.log(`ğŸ¯ drawMatchPositions í˜¸ì¶œë¨ (team=${team ?? "ì „ì²´"})`);

    // âœ… ê²½ê¸° í¸ì„± 1ê²½ê¸° íƒ­ ë²„íŠ¼ ë³´ì´ê¸°
    const matchTabBtn = document.getElementById("matchTabButton");
    if (matchTabBtn) {
      matchTabBtn.style.display = "inline-block";
    }

    // âœ… íƒ­ ì „í™˜
    showTab('matchTab');

    // âœ… ì´ˆê¸°í™”
    currentPlayerIndex = 0;
    openedEnvelopes = [];
    confirmedSelections = { A: {}, B: {}, C: {} };
    confirmedIndexes = [];
    lastSelections = [];
    fixedNotes = [];
    confirmedIndexesMap = [];

    if (!matchPlayers || matchPlayers.length === 0) {
      alert("ì¶œì„ë¶€ë¥¼ ë¨¼ì € ì ìš©í•´ì£¼ì„¸ìš”.");
      return;
    }

    setupVotingOrder(team);
    let notes = [];

    if (team === null) {
      assignMatchTeams();
      const parsedA = parseFormation('A');
      const parsedB = parseFormation('B');

      if (!parsedA || !parsedB) {
        alert("í¬ì§€ì…˜ ì„¤ì • ì˜¤ë¥˜: AíŒ€ê³¼ BíŒ€ì„ í™•ì¸í•˜ì„¸ìš”.");
        return;
      }

      var { df: dfA, mf: mfA, fw: fwA, starter: starterA } = parsedA;
      var { df: dfB, mf: mfB, fw: fwB, starter: starterB } = parsedB;

      notes = generateAllNotes(voteOrder.length);
    } else {
      const korTeamName = `${team}íŒ€`;
      const parsed = parseFormation(team);
      if (!parsed) {
        alert(`${team}íŒ€ í¬ì§€ì…˜ ì„¤ì • ì˜¤ë¥˜`);
        return;
      }

      const { df, mf, fw, starter } = parsed;
      notes.push(...generateTeamNotes(korTeamName, df, mf, fw, starter));
    }

    if (notes.length < voteOrder.length) {
      const diff = voteOrder.length - notes.length;
      console.warn(`âš ï¸ ìª½ì§€ ë¶€ì¡±: ${diff}ê°œ ì˜ˆë¹„ ì¶”ê°€`);
      notes.push(...Array(diff).fill("ì˜ˆë¹„"));
    }

    window.originalNotes = shuffle(notes);
    shuffleAvailableNotes();
    console.log("âœ… shuffledNotes:", window.shuffledNotes);

    setTimeout(() => {
      pickedIndexes = [];
      renderEnvelopes();
      openEnvelopeModal();
      setTimeout(showVotingInfo, 200);
    }, 100);

  } catch (err) {
    console.warn("âŒ drawMatchPositions ì¤‘ë‹¨:", err.message);
    console.log("ğŸ§ª ì—ëŸ¬ ê°ì²´:", err);
  }

  console.log("âœ… AíŒ€ ì¸ì›:", finalTeamResults?.A?.length || 0);
  console.log("âœ… BíŒ€ ì¸ì›:", finalTeamResults?.B?.length || 0);
  console.log("âœ… CíŒ€ ì¸ì›:", finalTeamResults?.C?.length || 0);
  console.log("âœ… í¬ì§€ì…˜ í•© (A):", 1 + dfA + mfA + fwA);
  console.log("âœ… í¬ì§€ì…˜ í•© (B):", 1 + dfB + mfB + fwB);
}


function updateTeamTable(team, selections) {
  const korTeam = `${team}íŒ€`;
  const container = document.getElementById("teamDivisionResult");

  // ê¸°ì¡´ í…Œì´ë¸” ì‚­ì œ
  const oldTable = document.getElementById(`table-${team}`);
  if (oldTable) container.removeChild(oldTable);

  // ìƒˆë¡œìš´ í…Œì´ë¸” ìƒì„±
  const table = document.createElement("table");
  table.id = `table-${team}`;
  table.className = "team-table";
  table.style.marginBottom = "1.5rem";
  table.style.borderCollapse = "collapse";
  table.style.width = "100%";
  table.style.maxWidth = "600px";
  table.style.boxShadow = "0 2px 5px rgba(0,0,0,0.1)";
  table.style.borderRadius = "8px";
  table.style.overflow = "hidden";
  table.style.backgroundColor = {
    A: "#fff9c4",
    B: "#ffe0b2",
    C: "#e1f5fe"
  }[team] || "#ffffff";

  const thead = document.createElement("thead");
  thead.innerHTML = `
    <tr style="background: rgba(0,0,0,0.05); font-weight: bold;">
      <th style="padding: 0.5rem; border-bottom: 1px solid #ccc;" colspan="2">${korTeam}</th>
    </tr>
    <tr style="background: rgba(0,0,0,0.03);">
      <th style="padding: 0.5rem; border-bottom: 1px solid #ccc;">ì„±ëª…</th>
      <th style="padding: 0.5rem; border-bottom: 1px solid #ccc;">í¬ì§€ì…˜</th>
    </tr>`;
  table.appendChild(thead);

  const tbody = document.createElement("tbody");

  // ğŸ”„ ë³€ê²½ëœ êµ¬ì¡°ì— ë§ì¶° íŒ€ë³„ ë°ì´í„°ë§Œ ì¶”ì¶œ
  const entries = Object.entries(selections[team] || {})
    .sort((a, b) => a[0].localeCompare(b[0])); // ì´ë¦„ìˆœ ì •ë ¬

  for (const [name, position] of entries) {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td style="padding: 0.5rem; border-bottom: 1px solid #eee;">${name}</td>
      <td style="padding: 0.5rem; border-bottom: 1px solid #eee;">${position}</td>
    `;
    tbody.appendChild(row);
  }

  table.appendChild(tbody);
  container.appendChild(table);
}


function detectCurrentTeam() {
  const note = window.originalNotes?.[0] || "";
  if (note.startsWith("AíŒ€")) return "A";
  if (note.startsWith("BíŒ€")) return "B";
  if (note.startsWith("CíŒ€")) return "C";
  return null;
}

function assignMatchTeams() {
  if (!matchPlayers || matchPlayers.length === 0) {
    alert("âš ï¸ ì¶œì„ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const total = matchPlayers.length;
  const cCount = parseInt(document.getElementById("matchCInput").value || 0);
  const rest = Math.max(0, total - cCount);

  const aCount = Math.ceil(rest / 2);
  const bCount = Math.floor(rest / 2);

  const teamA = matchPlayers.slice(0, aCount);
  const teamB = matchPlayers.slice(aCount, aCount + bCount);
  const teamC = matchPlayers.slice(aCount + bCount, aCount + bCount + cCount);

  // âœ… ì´ë¦„ë§Œ ë‹´ê³ , positionì€ ë‚˜ì¤‘ì— ë½‘ê¸°ì—ì„œ ì„¤ì •ë¨
  window.finalTeamResults = {
    A: teamA.map(p => ({ name: p.name, position: "" })),
    B: teamB.map(p => ({ name: p.name, position: "" })),
    C: teamC.map(p => ({ name: p.name, position: "" }))
  };

  localStorage.setItem("finalTeamResults", JSON.stringify(window.finalTeamResults));
  console.log("ğŸ‘¤ matchPlayers:", matchPlayers);
  console.log("ğŸ“‹ memberList:", memberList);
}


function generateAllNotes() {
  const formationA = document.getElementById("formationASelect").value;
  const formationB = document.getElementById("formationBSelect").value;
  const [dfA, mfA, fwA] = formationA.split("-").map(Number);
  const [dfB, mfB, fwB] = formationB.split("-").map(Number);
  const starterA = parseInt(document.getElementById("matchAStarter").value || "0");
  const starterB = parseInt(document.getElementById("matchBStarter").value || "0");

  // âœ… íŒ€ë³„ ì¸ì› ìˆ˜ëŠ” finalTeamResults ê¸°ì¤€ìœ¼ë¡œ ì •í™•íˆ ê³„ì‚°
  const countA = finalTeamResults?.A?.length || 0;
  const countB = finalTeamResults?.B?.length || 0;
  const countC = finalTeamResults?.C?.length || 0;

  // âœ… A/B íŒ€ í¬ì§€ì…˜ ìª½ì§€ ìƒì„±
  const notes = [
    ...generateTeamNotes("AíŒ€", dfA, mfA, fwA, starterA, countA),
    ...generateTeamNotes("BíŒ€", dfB, mfB, fwB, starterB, countB)
  ];

  // âœ… CíŒ€ ìª½ì§€ ì²˜ë¦¬
  if (countC > 0) {
    notes.push(...Array(countC).fill("CíŒ€"));
    console.log(`ğŸ§¾ CíŒ€ ìª½ì§€ ${countC}ê°œ ì¶”ê°€`);
  }

  // âœ… ë¶€ì¡± ì‹œ ì˜¤ë¥˜ ì²˜ë¦¬
  if (notes.length < voteOrder.length) {
    const diff = voteOrder.length - notes.length;
    console.error(`âŒ ìª½ì§€ ìˆ˜ ë¶€ì¡±! â†’ ${diff}ê°œê°€ ëˆ„ë½ë¨ (check í¬ì§€ì…˜ ì…ë ¥ ë˜ëŠ” íŒ€ ì¸ì›ìˆ˜)`);
    alert(`âŒ ìª½ì§€ ìˆ˜ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (${diff}ê°œ ëˆ„ë½)\ní¬ì§€ì…˜ ì„¤ì • ë˜ëŠ” ì„ ë°œ ì¸ì›ìˆ˜ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.`);
    return []; // ì•„ì˜ˆ ì¤‘ë‹¨
  }

  console.log(`ğŸ“¦ ì „ì²´ ìª½ì§€ ìˆ˜: ${notes.length} / íˆ¬í‘œì ìˆ˜: ${voteOrder.length}`);
  return notes;
}


function startTeamDraw(team) {
  const result = JSON.parse(localStorage.getItem("finalTeamResults") || "{}");
  if (team === "C" && (!result.C || result.C.length === 0)) {
    alert("âš ï¸ 1ê²½ê¸°ì—ì„œ CíŒ€ì„ êµ¬ì„±í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return;
  }

  renderTeamDrawUI(team);
}
function renderTeamDrawUI(team) {
  const korTeam = `${team}íŒ€`;
  const container = document.getElementById("matchDrawArea");
  container.innerHTML = "";  // ì´ˆê¸°í™”

  // âš½ íƒ€ì´í‹€
  const title = document.createElement("h3");
  title.textContent = `${korTeam} í¬ì§€ì…˜ ì„¤ì •`;
  title.style.marginBottom = "1rem";
  container.appendChild(title);

  // âœ… ì„ ë°œ ì¸ì› ìˆ˜ ì…ë ¥
  const starterDiv = document.createElement("div");
  starterDiv.innerHTML = `
    <label for="match${team}Starter">ì„ ë°œ ì¸ì› ìˆ˜: </label>
    <input type="number" id="match${team}Starter" value="${finalTeamResults?.[team]?.length || 0}" min="1" style="width: 60px;">
  `;
  container.appendChild(starterDiv);

  // âœ… í¬ë©”ì´ì…˜ ì„ íƒ
  const formationDiv = document.createElement("div");
  formationDiv.style.marginTop = "0.8rem";
  formationDiv.innerHTML = `
    <label for="formation${team}Select">í¬ë©”ì´ì…˜: </label>
    <select id="formation${team}Select" onchange="toggleCustomFormation('${team}')">
      <option value="4-4-2">4-4-2</option>
      <option value="4-3-3">4-3-3</option>
      <option value="3-3-4">3-3-4</option>
      <option value="custom">ì‚¬ìš©ì ì§€ì •</option>
    </select>
  `;
  container.appendChild(formationDiv);

  // âœ… ì‚¬ìš©ì ì§€ì • í¬ë©”ì´ì…˜ ì…ë ¥ì¹¸
  const customDiv = document.createElement("div");
  customDiv.id = `formation${team}Custom`;
  customDiv.style.display = "none";
  customDiv.style.marginTop = "0.5rem";
  customDiv.innerHTML = `
    <label>DF: <input type="number" id="df${team}" value="4" style="width: 40px;"></label>
    <label>MF: <input type="number" id="mf${team}" value="4" style="width: 40px;"></label>
    <label>FW: <input type="number" id="fw${team}" value="2" style="width: 40px;"></label>
    <span id="remaining${team}" style="margin-left: 1rem; font-weight: bold;"></span>
  `;
  container.appendChild(customDiv);

  // âœ… í¬ì§€ì…˜ ë½‘ê¸° ë²„íŠ¼
  const drawBtn = document.createElement("button");
  drawBtn.textContent = "í¬ì§€ì…˜ ë½‘ê¸° ì‹œì‘";
  drawBtn.style.marginTop = "1rem";
  drawBtn.style.padding = "0.7rem 1.5rem";
  drawBtn.style.fontSize = "1rem";
  drawBtn.onclick = () => {
  if (!team) {
    alert("íŒ€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  drawMatchPositions(team);
};
  container.appendChild(drawBtn);
}
function sortTeamByCustomRule(teamPlayers) {
  const nameToOrder = {};
  voteOrder.forEach((player, idx) => {
    nameToOrder[player.name] = idx;
  });

  // ğŸ¯ íŒ€ ë‚´ ì¶œì„ ìˆœ 1ë“±
  const teamTopName = [...teamPlayers].sort((a, b) => nameToOrder[a.name] - nameToOrder[b.name])[0]?.name;

  return teamPlayers.sort((a, b) => {
    const rankA = getRank(a);
    const rankB = getRank(b);
    if (rankA !== rankB) return rankA - rankB;
    return nameToOrder[a.name] - nameToOrder[b.name]; // ê°™ì€ ê·¸ë£¹ì€ ì¶œì„ ìˆœ
  });

  function getRank(player) {
    if (player.name === teamTopName) return 0;                      // íŒ€ ë‚´ ì¶œì„ 1ìœ„
    if (player.position.includes("ì‹¬íŒ")) return 1;
    if (player.position.includes("íœ´ì‹")) return 2;
    if (player.position === "GK") return 3;
    return 4;
  }
}
function showTeamAddForm() {
  const area = document.getElementById("teamChangeContainer");
  const hasCTeam = finalTeamResults?.C && finalTeamResults.C.length > 0;

  area.innerHTML = `
    <div>
      <label>ì„±ëª…: 
        <select id="addNameSelect" onchange="toggleNonMemberInput()">
          ${memberList.map(m => `<option value="${m.name}">${m.name}</option>`).join("")}
          <option value="ë¹„íšŒì›">ë¹„íšŒì› ì¶”ê°€</option>
        </select>
        <input type="text" id="nonMemberInput" placeholder="ë¹„íšŒì› ì´ë¦„ ì…ë ¥" style="display:none; margin-left:0.5rem;" />
      </label>
      <label>íŒ€: 
        <select id="addTeamSelect">
          <option value="A">AíŒ€</option>
          <option value="B">BíŒ€</option>
          ${hasCTeam ? '<option value="C">CíŒ€</option>' : ''}
        </select>
      </label>
      <button onclick="saveTeamAddition()">ì €ì¥</button>
      <button onclick="clearTeamChangeForm()">ë‹«ê¸°</button>
    </div>
  `;
}
function toggleNonMemberInput() {
  const select = document.getElementById("addNameSelect");
  const input = document.getElementById("nonMemberInput");
  if (select.value === "ë¹„íšŒì›") {
    input.style.display = "inline-block";
  } else {
    input.style.display = "none";
  }
}


function showTeamChangeForm() {
  const area = document.getElementById("teamChangeContainer");
  const allNames = Object.values(finalTeamResults).flat().map(p => p.name);

  const hasCTeam = finalTeamResults?.C && finalTeamResults.C.length > 0;

  area.innerHTML = `
    <div style="margin-top: 0.5rem;">
      <label>ì´ë¦„: 
        <select id="moveNameSelect">
          ${allNames.map(n => `<option value="${n}">${n}</option>`).join("")}
        </select>
      </label>
      <label>ì˜®ê¸¸ íŒ€: 
        <select id="moveTeamSelect">
          <option value="A">AíŒ€</option>
          <option value="B">BíŒ€</option>
          ${hasCTeam ? '<option value="C">CíŒ€</option>' : ''}
        </select>
      </label>
      <button onclick="movePlayerToTeam()">ì €ì¥</button>
      <button onclick="clearTeamChangeForm()">ë‹«ê¸°</button>
    </div>
  `;
}

function showLeaveForm() {
  const area = document.getElementById("teamChangeContainer");
  const allNames = Object.values(finalTeamResults).flat().map(p => p.name);
  area.innerHTML = `
    <div style="margin-top: 0.5rem;">
      <label>ì„±ëª…: 
        <select id="leaveNameSelect">
          ${allNames.map(n => `<option value="${n}">${n}</option>`).join("")}
        </select>
      </label>
      <button onclick="processLeave()">ì¡°í‡´ ì²˜ë¦¬</button>
      <button onclick="clearTeamChangeForm()">ë‹«ê¸°</button>
    </div>
  `;
}
function clearTeamChangeForm() {
  const area = document.getElementById("teamChangeContainer");
  if (area) area.innerHTML = "";
}
function saveTeamAddition() {
  let name = document.getElementById("addNameSelect").value;
  const team = document.getElementById("addTeamSelect").value;

  if (name === "ë¹„íšŒì›") {
  const customInput = document.getElementById("nonMemberInput").value.trim();
  if (!customInput) return alert("ë¹„íšŒì› ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
  name = `(ìš©) ${customInput}`;  // âœ… ì—¬ê¸°ì„œ ì•ì— '(ìš©) ' ë¶™ì„
  } 


  if (!name || !team) {
    alert("ì´ë¦„ê³¼ íŒ€ì„ ëª¨ë‘ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  if (!window.finalTeamResults) window.finalTeamResults = {};
  if (!finalTeamResults[team]) finalTeamResults[team] = [];

  finalTeamResults[team].push({ name, position: "ì§€ê°" });
  localStorage.setItem("finalTeamResults", JSON.stringify(finalTeamResults));

  // íšŒì›ì¸ ê²½ìš°ë§Œ ì¶œì„ ì²˜ë¦¬
  const member = memberList.find(m => m.name === name);
  if (member) {
    const year = document.getElementById("yearSelect").value;
    const month = document.getElementById("monthSelect").value.padStart(2, '0');
    const day = document.getElementById("daySelect").value.padStart(2, '0');
    const dateKey = `${year}-${month}-${day}`;

    if (!window.attendanceHistoryData) window.attendanceHistoryData = {};
    if (!attendanceHistoryData[dateKey]) attendanceHistoryData[dateKey] = [];

    const already = attendanceHistoryData[dateKey].find(e => e.name === name);
    if (!already) {
      attendanceHistoryData[dateKey].push({
        name,
        late: true,
        leave: false,
        score: 5
      });
    }

    localStorage.setItem("attendanceHistoryData", JSON.stringify(attendanceHistoryData));
  }

  alert(`âœ… ${name} ì„ ìˆ˜ê°€ ${team}íŒ€ì— ì§€ê°ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  clearTeamChangeForm();
  displayFinalTeamResults();
}

function movePlayerToTeam() {
  const name = document.getElementById("moveNameSelect")?.value;
  const newTeam = document.getElementById("moveTeamSelect")?.value;

  if (!name || !newTeam) {
    alert("ì´ë¦„ê³¼ íŒ€ì„ ëª¨ë‘ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  if (!window.finalTeamResults || !finalTeamResults[newTeam]) {
    alert("âš ï¸ íŒ€ ë°ì´í„°ê°€ ë¹„ì •ìƒì…ë‹ˆë‹¤.");
    return;
  }

  // âœ… ì¶œì„ì + ì¶”ê°€ ì¸ì›ê¹Œì§€ í¬í•¨í•˜ëŠ” ìˆœì„œ
const extendedOrder = [...voteOrder];

// A/B/CíŒ€ì— ì¶”ê°€ëœ ì¸ì›ë„ í¬í•¨
["A", "B", "C"].forEach(team => {
  const members = finalTeamResults[team] || [];
  members.forEach(p => {
    if (!extendedOrder.find(e => e.name === p.name)) {
      extendedOrder.push({ name: p.name });
    }
  });
});

// ì¶œì„ ìˆœì„œ ë§µ ìƒì„±
const orderMap = {};
extendedOrder.forEach((p, idx) => {
  orderMap[p.name] = idx;
});

  const playerOrder = orderMap[name];
  if (playerOrder === undefined) {
    alert("âš ï¸ í•´ë‹¹ ì´ë¦„ì´ ì¶œì„ì ëª…ë‹¨ì— ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // ğŸ” ê¸°ì¡´ í¬ì§€ì…˜ ì°¾ê¸°
  let originalPosition = "ì§€ì •ì•ˆë¨";
  for (const team in finalTeamResults) {
    const found = finalTeamResults[team].find(p => p.name === name);
    if (found) originalPosition = found.position;
  }

  // ê¸°ì¡´ íŒ€ì—ì„œ ì œê±°
  for (const team in finalTeamResults) {
    finalTeamResults[team] = finalTeamResults[team].filter(p => p.name !== name);
  }

  // ìƒˆ íŒ€ì— ì¶œì„ìˆœ ê¸°ì¤€ìœ¼ë¡œ ì‚½ì…
  const newPlayer = { name, position: originalPosition };
  const teamList = finalTeamResults[newTeam];
  let insertIndex = teamList.findIndex(p => orderMap[p.name] > playerOrder);
  if (insertIndex === -1) insertIndex = teamList.length;
  teamList.splice(insertIndex, 0, newPlayer);

  localStorage.setItem("finalTeamResults", JSON.stringify(finalTeamResults));
  alert(`âœ… ${name} ì„ ìˆ˜ê°€ ${newTeam}íŒ€ì— ì¶œì„ ìˆœì„œ ê¸°ì¤€ìœ¼ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  clearTeamChangeForm();
  displayFinalTeamResults();
}
function processLeave() {
  const name = document.getElementById("leaveNameSelect")?.value;
  if (!name) return alert("ì¡°í‡´ ì²˜ë¦¬í•  ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”.");

  // âœ… íŒ€êµ¬ë¶„ í…Œì´ë¸”ì—ì„œ ì œê±°
  for (const team in finalTeamResults) {
    finalTeamResults[team] = finalTeamResults[team].filter(p => p.name !== name);
  }

  // âœ… ì¶œì„ ê´€ë¦¬ì— ì¡°í‡´ ê¸°ë¡
  const year = document.getElementById("yearSelect").value;
  const month = document.getElementById("monthSelect").value.padStart(2, '0');
  const day = document.getElementById("daySelect").value.padStart(2, '0');
  const dateKey = `${year}-${month}-${day}`;

  if (!window.attendanceHistoryData) attendanceHistoryData = {};
  if (!attendanceHistoryData[dateKey]) attendanceHistoryData[dateKey] = [];

  // ê¸°ì¡´ ê¸°ë¡ì´ ìˆëŠ”ì§€ í™•ì¸
  const existing = attendanceHistoryData[dateKey].find(p => p.name === name);
  if (existing) {
    existing.leave = true;
    existing.late = false;
    existing.score = 5;
  } else {
    attendanceHistoryData[dateKey].push({
      name,
      late: false,
      leave: true,
      score: 5
    });
  }

  // âœ… ì €ì¥ ë° UI ë°˜ì˜
  localStorage.setItem("finalTeamResults", JSON.stringify(finalTeamResults));
  localStorage.setItem("attendanceHistoryData", JSON.stringify(attendanceHistoryData));
  alert(`âœ… ${name} ì¡°í‡´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  clearTeamChangeForm();
  displayFinalTeamResults();
}




window.addEventListener("DOMContentLoaded", () => {
    const storedHistory = localStorage.getItem("attendanceHistoryData");
  if (storedHistory) {
    window.attendanceHistoryData = JSON.parse(storedHistory);
  }

  const saved = localStorage.getItem("memberList");
  if (saved) {
    memberList = JSON.parse(saved);
    loadRankedAttendance();
  }
  renderMemberList();

  // âœ… ì¤‘ê°„ ì‚½ì… ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë° ì´ë²¤íŠ¸ ì—°ê²°
  const btn = document.getElementById("middleInsertButton");
  if (btn) {
    btn.onclick = showMiddleInsertForm;
    btn.style.padding = "0.5rem 0.8rem";
    btn.style.fontSize = "1.1rem";
    btn.style.lineHeight = "1.3";
    btn.style.borderRadius = "6px";
    btn.style.border = "1px solid #ccc";
    btn.style.backgroundColor = "#f0f0f0";
    btn.style.cursor = "pointer";
    btn.style.verticalAlign = "top";
    btn.style.transform = "translateY(-8px)";  // âœ… ë°”ë¡œ ì—¬ê¸° ì¶”ê°€!
  }
});

</script>
<!-- ì„ íƒ ê²°ê³¼ ëª¨ë‹¬ -->
    <div id="selectionModal" style="
  display: none;
  position: absolute;
  top: 10%;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  z-index: 99999;
  padding: 1rem;
  border-radius: 10px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  width: 90%;
  max-width: 600px;
  text-align: center;
">
  <div id="selectionContent" style="
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.6rem;
    font-size: 1rem;
    font-weight: normal;
  "></div>
    </div>
    <!-- ìª½ì§€ ì„ íƒ ì „ì²´ ëª¨ë‹¬ -->
<div id="envelopeModal" style="
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100vw;
  height:100vh;
  background:white; /* âœ… í°ìƒ‰ ë°°ê²½ */
  z-index:9999;

  flex-direction: column;
  justify-content: flex-start;
  align-items: center;

  overflow-y: auto;
  overflow-x: hidden;         /* âœ… ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
  box-sizing: border-box;     /* âœ… paddingì´ ë„ˆë¹„ì— í¬í•¨ë˜ë„ë¡ */
  padding: 1rem;              /* âœ… ì•ˆì „í•˜ê²Œ ë‚´ë¶€ ì—¬ë°± ì¶”ê°€ */
  ">

  <div style="width:100%; max-width:700px; padding:1rem; color:white; text-align:center;">
    <h2 id="drawPlayerInfo" style="font-size:1.5rem; color: black;">ğŸ‘¤ í˜„ì¬ í”Œë ˆì´ì–´ ì´ë¦„</h2>
    <div id="envelopeArea" style="margin-top:1rem;"></div>
  </div>
  <!-- ëª¨ë‹¬ ë‚´ë¶€ ë²„íŠ¼ (ì„ íƒ ëª¨ë‹¬ í•˜ë‹¨ì— ìœ„ì¹˜) -->
  <div id="selectionButtons" style="margin-top: 1rem; text-align: center;">
    <button onclick="resetEnvelopeSelection()" style="padding: 0.6rem 1rem; font-size: 1.1rem; margin-right: 10px;">
      ğŸ”„ ë‹¤ì‹œ ì„ íƒ
    </button>
    <button onclick="fullResetDraw()" style="padding: 0.6rem 1rem; font-size: 1.1rem;">
      â™»ï¸ ì´ˆê¸°í™”
    </button>
    <button onclick="cancelPositionDraw()" style="padding: 0.6rem 1rem; font-size: 1.1rem; margin-left: 10px;">
    âŒ ë½‘ê¸° ì·¨ì†Œ
  </button>
  </div>
  <div id="liveTeamPreview" style="margin-top: 0.4rem;"></div>

</div>


</body>
</html>